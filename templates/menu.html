<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayfa İçi Sekmeler</title>
    <style>
        /* Sekme başlıkları */
        .tab {
            display: inline-block;
            padding: 10px 20px;
            background-color: #ddd;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        /* Aktif sekme başlığı */
        .tab.active {
            background-color: #333;
            color: white;
        }

        /* Sekme içerikleri */
        .tab-content {
            display: none;
            padding: 20px;
            border: 0px solid #ddd;
            border-top: none;
        }

        /* Aktif sekme içeriği */
        .tab-content.active {
            display: block;
        }

        /* Logo ve Başlık */
        .header {
            display: flex;
            align-items: center; /* Dikeyde ortalama */
            justify-content: flex-start; /* Sol hizalama */
            padding: 10px 20px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        .logo {
            max-width: 300px;
            height: auto;
            margin-right: 20px; /* Logo ile kullanıcı bilgisi arasına boşluk ekleyebiliriz */
        }

        .user-info {
            display: flex;
            flex-direction: column; /* Yatay yerine dikey sıralar */
            gap: 0; /* Aradaki boşluğu sıfırla */
            margin: 0; /* Margin sıfırlandı */
        }

        .user-info h1, .user-info p {
            margin: 0; /* Burada da margin sıfırlandı */
            padding: 0; /* Padding sıfırlandı */
        }

        

        .header-button {
            margin-left: 20px; /* Buton ile kullanıcı bilgisinin arasına boşluk ekleyebiliriz */
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .header-button:hover {
            background-color: #0056b3;
        }

        .logout {
            position: absolute;  /* Sabit pozisyon */
            top: 10px;        /* Ekranın üstünden 10px mesafe */
            right: 10px;      /* Ekranın sağından 10px mesafe */
            text-decoration: none;
            background-color: #f44336;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10000;    /* Diğer öğelerin önünde görünsün */
        }

        #serverTime {
            font-size: 14px;
            color: gray;
            margin-left: auto; /* Sağ tarafa hizala */
        }

        /* Sabit Tab Bar - Sekme başlıkları altta */
        .tab-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #007BFF;
            padding: 10px 0;
            z-index: 1000;
        }

        /* Sayfa içeriği, sekme başlıkları ile çakışmasın diye alt tarafta bir boşluk bırak */
        .content {
            padding-bottom: 70px; /* Alt kısımdaki sabit sekme çubuğu için boşluk */
        }

        /* Müşteri Penceresi */
        .modal {
            display: none; /* Başlangıçta gizli */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Yarı şeffaf arka plan */
            justify-content: center;
            align-items: center;
            z-index: 1050; /* Modalın diğer öğelerin üstünde görünmesi için z-index artırıldı */
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto; /* Ortalamak için */
            padding: 20px;
            border: 1px solid #888;
            width: 100%; /* Modal genişliği */
            max-width: 1200px; /* Maksimum genişlik */
            height: 70%; /* Sabit yükseklik */
            overflow: hidden; /* İçerik taşmasını gizle */
            display: flex;
            flex-direction: column;
            z-index: 1051; /* Modal içeriği için z-index artırıldı */
            position: relative; /* Modal içeriğinin diğer öğelerle çakışmasını önlemek için */
        }

        .modal input {
            width: 30%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .modal button {
            background-color: #007BFF;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: auto; /* Butonu içeriğin altına iter */
            align-self: center; /* Ortalar */
        }

        .modal button:hover {
            background-color: #0056b3;
        }

        table {
            width: 50%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }
        .scrollable-table {
            max-height: 820px; /* Tablonun maksimum yüksekliği */
            overflow-y: auto; /* Yalnızca dikey kaydırma */
            border: 1px solid #ddd; /* Çerçeve ekleyin */
            z-index: 1; /* Tablo başlığının modalın altında kalması için z-index düşük tutuldu */
        }

        .scrollable-table table {
            width: 100%; /* Tabloyu kapsayıcıya yay */
            border-collapse: collapse; /* Çerçeveleri birleştir */
        }

        .scrollable-table th {
            position: sticky; /* Sabit pozisyon */
            top: 0; /* Tablo başlığı yukarıda sabitlenir */
            background-color: #f2f2f2; /* Arka plan rengi */
            z-index: 1049; /* Tablo başlığının modalın altında kalması için z-index düşürüldü */
            border: 1px solid #ddd; /* Başlık hücre çerçevesi */
            padding: 8px; /* İçerik aralığı */
            text-align: center; /* Ortala */
        }

        .unite-table {
            max-height: 1000px; /* Tablonun maksimum yüksekliği */
            overflow-x: auto; /* Yalnızca dikey kaydırma */

        }

        .unite-table th,
        .unite-table td {
            padding: 2px 3px !important;
            font-size: 13px !important;
            min-width: 0 !important;
            /*max-width: 60px;*/
            white-space: nowrap;
        }
       .unite-table th {
            position: sticky; /* Sabit pozisyon */
            top: 0; /* Tablo başlığı yukarıda sabitlenir */
            background-color: #f2f2f2; /* Arka plan rengi */
            z-index: 1049; /* Tablo başlığının modalın altında kalması için z-index düşürüldü */

        }

        .refrigeration-table th,
        .refrigeration-table td {
            padding: 2px 3px !important;
            font-size: 13px !important;
            min-width: 0 !important;
            /*max-width: 60px;*/
            white-space: nowrap;
        }
        .refrigeration-table th {
            position: sticky;
            top: 0;
            background-color: #f2f2f2;
            z-index: 1049;
        }


        /* .unite-table select,
        .unite-table input[type="text"],
        .unite-table input[type="number"] {
            padding: 2px 3px !important;
            font-size: 13px !important;
            width: 100% !important;
            min-width: 0 !important;
            box-sizing: border-box;
            margin: 0;
            height: 22px;
        } */
        
                /* Loading overlay still */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: rgba(255,255,255,0.85);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 2rem;
            color: #333;
            pointer-events: all;
        }
        #loadingOverlay .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007BFF;
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        body.loading {
            overflow: hidden !important;
            pointer-events: none;
            user-select: none;
        }

    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        Sayfa yükleniyor...
    </div>
    

 <!-- Çıkış Butonu -->
 <a href="/logout" class="logout">Çıkış Yap</a>


 <!-- Logo ve Kullanıcı Bilgileri -->
 <div class="header">
     <img src="/static/images/logo.png" alt="Logo" class="logo">
     <div class="user-info" data-user-id="{{ user_id }}">
         <h1>User Name: {{ user }}</h1>
         
         <!--<p id="largestFile">Quotation Number: {{ largest_file }}</p>-->
         <p id="largestFile">{{ largest_file }}</p>
                 {% if session['authority'] == 'admin' %}
        <div style="margin-bottom: 8px;">
            <a href="{{ url_for('active_users') }}" 
            style="color:black; background: red; padding: 3px 7px; border-radius: 5px; text-decoration: none; font-weight: bold; display: inline-block;">
                USER Control
            </a>
        </div>
        {% endif %}
     </div>

     <button class="header-button" onclick="openModal()">Müşteri Bilgileri</button> <!-- Yeni Buton -->

     <!--<div id="selectedCustomer" style="margin-left: 0px; font-size: 14px;">-->
     <div id="selectedCustomer" style="display: flex; gap: 40px;"></div>
         <!-- Seçilen müşteri bilgileri burada görünecek -->
     <span id="serverTime" style="display: block; margin-top: 10px; font-size: 14px; color: gray;">
        <!-- Tarih burada gösterilecek -->
    </span>
 </div>

 <!-- İçerik -->
 <div class="content">

        <!-- Unite Tab İçeriği -->

        <!-- Unite Tab İçeriği -->
        <div id="tab_unite" class="tab-content">
            <h2>Unite Page</h2>
            <!--<p>Bu, Unite sekmesinin içeriğidir.</p>-->
            <!-- 40 Satır ve 43 Kolonlu Tablo -->

            <!--<button id="updateWidthButton">Update Width</button>-->

            <form method="POST">
                <div class="unite-table">
                <table>
                    <thead>
                        <tr>
                            <th colspan="6"></th>
                            <th colspan="2">Top Shelf1</th>
                            <th colspan="2">Top Shelf2</th>
                            <th colspan="2">Top Shelf3</th>
                            <th colspan="3">Back Panel 40</th>
                            <th colspan="3">Back Panel 30</th>
                            <th colspan="3">Back Panel 20</th>
                            <th colspan="3">Back Panel 10</th>
                            <th colspan="2">Shelves</th>
                            <th colspan="2">Back Panels</th>
                            <th colspan="2">Post, Baseleg</th>
                            <th colspan="2">Extras</th>
                            <th colspan="2">Risers</th>
                            <th colspan="2">Wire Shelves</th>
                            <th colspan="2">Baskets</th>
                            <th colspan="2">Hooks</th>
                            <th colspan="2">Counter Standart</th>
                            <th colspan="2">Counter High</th>
                        </tr>
                        <tr>
                            <th>Sira</th>
                            <th>Unit Piece</th>
                            <th>Unit Type</th>
                            <th>Height</th>
                            <th>Width</th>
                            <th>Base Shelf</th>
                            <th>Qty</th>
                            <th>Shelf Size</th>
                            <th>Qty</th>
                            <th>Shelf Size</th>
                            <th>Qty</th>
                            <th>Shelf Size</th>
                            <th>BP 40</th>
                            <th>Plane 40</th>
                            <th>Perf 40</th>
                            <th>BP 30</th>
                            <th>Plane 30</th>
                            <th>Perf 30</th>
                            <th>BP 20</th>
                            <th>Plane 20</th>
                            <th>Perf 20</th>
                            <th>BP 10</th>
                            <th>Plane 10</th>
                            <th>Perf 10</th>
                            <th>Qty</th>
                            <th>Shelf</th>
                            <th>Qty</th>
                            <th>Back Panel</th>
                            <th>Qty</th>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Extras</th>
                            <th>Qty</th>
                            <th>Risers</th>
                            <th>Qty</th>
                            <th>Wire Shelf</th>
                            <th>Qty</th>
                            <th>Baskets</th>
                            <th>Qty</th>
                            <th>Hooks</th>
                            <th>Qty</th>
                            <th>Counter Standart</th>
                            <th>Qty</th>
                            <th>Counter High</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(50) %}
                        <tr data-row-index="{{ i }}">
                            <td class="row-number">{{ i + 1 }}</td>
                            <td>
                                <select name="option1_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox1'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--UNIT PIECE-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option2_{{ i }}" class="trigger-select">
                                    <option value=""></option>
                                    {% for option in options['combobox2'] %}
                                        <option value="{{ option }}">{{ option }}</option>  <!--UNIT TYPE-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option3_{{ i }}"class="base-select">
                                    <option value=""></option>
                                    {% for option in options['combobox3'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--HEIGHT-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option4_{{ i }}" >
                                    <option value=""></option>
                                    {% for option in options['combobox4'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--WIDTH-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option5_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox5'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--BASE SHELF-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option6_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox6'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--TOP1 S QTY-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option7_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox7'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--TOP1 S SHLF SUZE-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option8_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox8'] %}
                                       <option value="{{ option|int }}">{{ option|int }}</option>  <!--TOP2 S QTY-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option9_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox9'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--TOP2 S SHLF SIZE-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option10_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox10'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--TOP3 S QTY-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option11_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox11'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>  <!--TOP3 S SHLF SIZE-->
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value1_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option13_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox13'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option14_{{ i }}" class="bp-select">
                                    <option value=""></option>
                                    {% for option in options['combobox14'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value2_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option16_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox16'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option17_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox17'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value3_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option19_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox19'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option20_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox20'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value4_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option22_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox22'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option23_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox23'] %}
                                        <option value="{{ option|int }}">{{ option|int }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>
                                <!-- Label yerine text box (input) ekliyoruz -->
                                <input name="option24_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option25_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox25'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option26_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option27_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox27'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option28_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option29_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox29'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option30_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option31_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox31'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option32_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option33_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox33'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option34_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option35_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox35'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option36_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option37_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox37'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option38_{{ i }}" type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option39_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox39'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option40_{{ i }}"type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option41_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox41'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input name="option42_{{ i }}"type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option43_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox43'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </form>
        </div>

        <!-- Diğer Tab İçeriği (Örnek: Refrigeration) -->
        <div id="tab_refrigeration" class="tab-content">
            <h2>Refrigeration</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <label for="customerType">Choose Customer Type:</label>
                    <select id="customerType">
                        <option value="Retail">Retail</option>
                        <option value="Trade">Trade</option>
                    </select>
                </div>
                <div>
                    <label for="ref_dsc">Discount:</label>
                    <input type="number" id="ref_dsc" value="0" style="width: 60px;" min="0" max="100" step="1">
                </div>
            </div>
            <table border="1" style="width: 100%; text-align: center; border-collapse: collapse;">
            <!-- <table class="refrigeration-table" border="1" style="width: 100%; text-align: center; border-collapse: collapse;"> -->
                <thead>
                    <tr>
                        <th>SELECT GROUP</th>
                        <th>SELECT ITEM</th>
                        <th>WARRANTY</th>
                        <th>UNPACK&POSITION</th>
                        <th>REMOVE&DISPOSE</th>
                        <th>QUANTITY</th>
                        <th>PRICE</th>
                        <th>D.PRICE</th>
                        <th>SKU</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(15) %}
                    <tr>
                        <td>
                            <select name="group_{{ i }}" class="group-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <select name="item_{{ i }}" class="item-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <select name="warranty_{{ i }}" class="warranty-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <select name="unpack_{{ i }}" class="unpack-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->

                            </select>
                        </td>
                        <td>
                            <select name="remove_{{ i }}" class="remove-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <input type="number" name="quantity_{{ i }}" min="1" style="width: 60px;">
                        </td>
                        <td>
                            <label id="price_{{ i }}"></label>
                        </td>
                        <td>
                            <label id="dprice_{{ i }}"></label>
                        </td>
                        <td>
                            <label id="sku_{{ i }}"></label>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="tab_add_item" class="tab-content">
            <h2>ADD ITEM</h2>
            <!--<p>Bu, add item sekmesinin içeriğidir.</p>-->
            <!--<table border="1" style="width: 100%; text-align: center;">-->
                <table border="1" style="text-align: center;">
                <thead>
                    <tr>
                        <th style="width: 200px;">Item Name</th>
                        <th style="width: 30px;">Qty</th>
                        <th style="width: 30px;">Price</th>
                        <th style="width: 30px;">After Disc.</th>
                        <th style="width: 60px;">Depo Code</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 20 satır oluşturuluyor -->
                    <!-- Her satırda 5 sütun -->
                    <!-- 2., 3., ve 4. sütunlar için yalnızca rakam girişi -->
                    <!-- HTML5 input type="number" kullanılarak sağlanır -->
                    <!-- Satırlar dinamik olarak çoğaltılabilir -->
                    <script>
                        //<input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                        //<td><input type="number" style="width: 100%;"></td>
                        //<td><input type="number" step="0.01" style="width: 100%;"></td>
                        // 20 satır ve 5 sütun ekleyen dinamik JavaScript kodu
                        for (let i = 0; i < 20; i++) {
                            document.write(`<tr>
                                <td><input type="text" style="width: 100%;"></td>
                                <td><input type="text" style="width: 100%;"  onkeypress="return isNumberKey(event)" ></td> 
                                <td><input type="text" style="width: 100%;"  onkeypress="return isNumberKey(event)" ></td> 
                                <td><input type="text" style="width: 100%;"  onkeypress="return isNumberKey(event)" ></td>
                                <td><input type="text" style="width: 100%;"></td>
                            </tr>`);
                        }
                    </script>
                </tbody>
            </table>
        </div>

        
        <div id="tab_proforma" class="tab-content active">
            <!-- <h2>Proforma</h2>-->
            <h2 id="tableHeader" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Quote list: Yükleniyor...</span>
            </h2>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">

                <!-- quoteDate sağa hizalandı -->
                <div id="quoteDateContainer" style="display: flex; flex-direction: column; align-items: flex-end;">
                <span id="quoteDate" style="padding: 5px 10px; font-size: 14px; color: gray;">Quote date: Yükleniyor...</span>
                <!-- KG bilgisi buraya eklenecek -->
                </div>
            
                <!-- Diğer butonlar -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <button id="updateWidthBtn">Make Proforma</button>
                        <button id="openProformaBtn" onclick="openProformaModal()">Open Proforma</button>
                        <label for="discountInput">Discount:</label>
                        <input type="number" id="discountInput" value="0" style="width: 60px;" min="0" max="100" step="1">
                        <label for="deliveryPriceInput">Delivery Price:</label>
                        <input type="number" id="deliveryPriceInput" value="0" style="width: 80px;" min="0" step="1">
                    </div>

                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="display: flex; flex-direction: column;">
                            <label for="shelfColor">Shelf Colour:</label>
                            <select id="shelfColor"></select>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="ticketColor">Ticket Color and Type:</label>
                            <select id="ticketColor"></select>
                            <select id="ttype"></select>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="slatwall">Slatwall:</label>
                            <select id="slatwall"></select>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="insert">Insert:</label>
                            <select id="insert"></select>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="endcap">End Cap:</label>
                            <select id="endcap"></select>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="viewMode">View Mode:</label>
                        <select id="viewMode">
                            <option value="subtotal">Subtotal</option>
                            <option value="parts">Parts (Old style)</option>
                        </select>
                    </div>
            
                    <!-- Sell butonu sağda -->
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button id="sellBtn" onclick="sellModalcnt()" style="padding: 5px 10px;">Sell</button>
                        <button id="invBtn" onclick="generateInvoice(false)" style="padding: 5px 10px;">Inv</button>
                        <button id="prfBtn" onclick="generateProfroma()" style="padding: 5px 10px;">Prf</button>
                    </div>
                </div>
            
            </div>

            <script>
                async function saveColorSelections(quoteNumber) {
                    const selections = {
                    shelfColor: document.getElementById('shelfColor')?.value || '',
                    ticketColor: document.getElementById('ticketColor')?.value || '',
                    ttype: document.getElementById('ttype')?.value || '',
                    slatwall: document.getElementById('slatwall')?.value || '',
                    insert: document.getElementById('insert')?.value || '',
                    endcap: document.getElementById('endcap')?.value || ''
                    };

                    // ✅ Seçilen verileri ekrana yazdır
                //alert(`Gönderilen Teklif Numarası: ${quoteNumber}`);
                //alert(`Seçilen Renkler:\n${JSON.stringify(selections, null, 2)}`);

            try {
                const response = await fetch('/save_color_selections', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
            },
                body: JSON.stringify({ quote_number: quoteNumber, selections: selections }),
            });

                const data = await response.json();
                if (data.status === 'success') {
                    //alert('Renk seçimleri başarıyla kaydedildi.');
                } else {
                    alert('Hata: ' + data.message);
                }
                } catch (error) {
                    console.error('Renk seçimleri kaydedilirken hata oluştu:', error);
                    alert('Renk seçimleri kaydedilirken bir hata oluştu.');
                }
            }

                async function loadColorSelections(quoteNumber) {
                try {
                    const response = await fetch(`/load_color_selections?quote_number=${quoteNumber}`);
                    const data = await response.json();

                    if (data.status === 'success') {
                        const selections = data.selections;

                        // Check if each element exists before setting its value
                        const shelfColorElement = document.getElementById('shelfColor');
                        if (shelfColorElement) shelfColorElement.value = selections.shelfColor || '';

                        const ticketColorElement = document.getElementById('ticketColor');
                        if (ticketColorElement) ticketColorElement.value = selections.ticketColor || '';

                        const ttypeElement = document.getElementById('ttype');
                        if (ttypeElement) ttypeElement.value = selections.ttype || '';

                        const slatwallElement = document.getElementById('slatwall');
                        if (slatwallElement) slatwallElement.value = selections.slatwall || '';

                        const insertElement = document.getElementById('insert');
                        if (insertElement) insertElement.value = selections.insert || '';

                        const endcapElement = document.getElementById('endcap');
                        if (endcapElement) endcapElement.value = selections.endcap || '';
                    } else {
                        console.error('Error loading color selections:', data.message);
                    }
                    } catch (error) {
                        console.error('Error in loadColorSelections:', error);
                    }
                }

            </script>

            <script>
                // Fetch options from color_tbl.db and populate dropdowns
                async function fetchColorOptions() {
                    try {
                        const response = await fetch('/get_color_options');
                        const data = await response.json();

                        if (data.status === 'success') {
                            populateDropdown('shelfColor', data.shelf);
                            populateDropdown('ticketColor', data.ticket);
                            populateDropdown('ttype', data.type);
                            populateDropdown('slatwall', data.slatwall);
                            populateDropdown('insert', data.insert);
                            populateDropdown('endcap', data.endcap);
                        } else {
                            console.error('Error fetching color options:', data.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                }

                function populateDropdown(id, options) {
                    const dropdown = document.getElementById(id);
                    dropdown.innerHTML = `<option value=""></option>` + // Varsayılan boş seçenek
                    options.map(option => `<option value="${option}">${option}</option>`).join('');
                }

                // Call the function on page load
                fetchColorOptions();
            </script>

            <p id="statusMessage"></p>
        
            <!-- Quote List Table -->
            <table id="quoteListTable" border="1" style="margin-top: 20px; width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="display:none;">USER_ID</th>
                        <th>ITEM_ID</th>
                        <th>ITEM_NAME</th>
                        <th>QTTY</th>
                        <th style="display:none;">UNIT_TYPE</th>
                        <th style="display:none;">SIRA</th>
                        <th style="display:none;">PRICE</th>
                        <th>D.PRICE</th>
                        <th>AMOUNTH</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Veri buraya yüklenecek -->
                </tbody>
            </table>
        </div>

        <!-- Sell Modal -->
        <div class="modal" id="sellModal">
            <div class="modal-content" style="max-width: 400px; text-align: center; height: 20%;"> <!-- Yükseklik azaltıldı -->
                <h2>Do you approve the sale?</h2>

                <div style="display: flex; justify-content: center; margin-top: auto; margin-bottom: 10px;">
                <label>
                    <input type="checkbox" id="checkboxS" onclick="toggleCheckbox('S')"> Sale
                </label>
                <label>
                    <input type="checkbox" id="checkboxI" onclick="toggleCheckbox('I')"> Invoice
                </label>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: auto; margin-bottom: 10px;"> <!-- Butonlar daha aşağıya taşındı -->
                    <button onclick="approveSale()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Yes</button>
                    <button onclick="closeSellModal(),ClearChckBox()" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">No</button>

                </div>
            </div>
        </div>

        <div id="tab_goruntule" class="tab-content">
            <h1>Database Content</h1>
        
            {% if data %}
                {% for table_name, table_data in data.items() %}
                    <h2>{{ table_name }}</h2>  <!-- Tablo adı -->
                    <table border="1">
                        <thead>
                            <tr>
                                {% for column in table_data.columns %}
                                    <th>{{ column }}</th>  <!-- Sütun isimleri -->
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data.rows %}
                                <tr>
                                    {% for cell in row %}
                                        <td>{{ cell }}</td>  <!-- Her hücrenin değeri -->
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endfor %}
            {% else %}
                <p>No data available.</p>
            {% endif %}
        </div>

        <div id="tab_ceiling" class="tab-content">
            <h2>Ceiling</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <label for="ceilingM2">Ceiling M2:</label>
                    <input type="number" id="ceilingM2" placeholder="Enter M2" style="margin-right: 20px;">
                    <label for="trimLM">Trim LM:</label>
                    <input type="number" id="trimLM" placeholder="Enter LM">
                </div>
                <div>
                    <label for="ceilingDiscount">Discount:</label>
                    <input type="number" id="ceilingDiscount" placeholder="Enter Discount" style="width: 100px;">
                </div>
            </div>
            <table border="1" style="width: 100%; text-align: center; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Materials</th>
                        <th>Notes</th>
                        <th>Qty</th>
                        <th>Local</th>
                        <th>D.Price</th>
                    </tr>
                </thead>
                <tbody id="ceilingTableBody">
                    <!-- Veriler backend'den yüklenecek -->
                </tbody>
            </table>
        </div>
        <script>
            let ceil_dsc = 0; // Discount değeri için global değişken

            function fetchCeilingData() {
                const ceilingM2Input = document.getElementById('ceilingM2');
                const trimLMInput = document.getElementById('trimLM');
                const discountInput = document.getElementById('ceilingDiscount');

                let ceilingM2 = parseFloat(ceilingM2Input.value) || 0;
                let trimLM = parseFloat(trimLMInput.value) || 0;
                ceil_dsc = parseFloat(discountInput.value) || 0; // Discount değerini al

                fetch('/calculate_ceiling_qty', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ceilingM2, trimLM, ceil_dsc }), // ceil_dsc gönderiliyor
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const tableBody = document.getElementById('ceilingTableBody');
                        tableBody.innerHTML = ''; // Eski içeriği temizle

                        data.rows.forEach(row => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${row.Code}</td>
                                <td>${row.Materials}</td>
                                <td>${row.Notes}</td>
                                <td>${row.qty}</td>
                                <td>${row.local}</td>
                                <td>${row.dPrice}</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    } else {
                        console.error('Hata:', data.message);
                    }
                })
                .catch(error => console.error('Hata:', error));
            }

            document.getElementById('ceilingM2').addEventListener('input', fetchCeilingData);
            document.getElementById('trimLM').addEventListener('input', fetchCeilingData);
            document.getElementById('ceilingDiscount').addEventListener('input', fetchCeilingData); // Discount değişikliğinde tetikleniyor
        </script>

        <!-- Diğer içerikler buraya eklenebilir -->
    </div>

    <div class="modal" id="customerModal">
    <div class="modal-content" style="max-width: 1400px;"> <!-- Modal genişliği artırıldı -->
    <h2>Customer List</h2>
    <input type="text" id="searchBox" placeholder="Search Customer..." onkeyup="searchCustomer()">
    <div style="display: flex; gap: 20px;">
        <!-- Sol taraf: Müşteri Tablosu -->
        <div style="flex: 2;">
            <table id="customerTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>C. ID</th>
                        <th>Customer Name</th>
                        <th>Tel</th>
                        <th>Address1</th>
                        <th>Address2</th>
                        <th>Postcode</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dinamik veri buraya gelir -->
                </tbody>
            </table>
            <button onclick="closeModal()" style="margin-top: 10px;">Kapat</button>
        </div>

        <!-- Orta çizgi -->
        <div style="width: 1px; background-color: #ddd;"></div>

        <!-- Sağ taraf: Customer Add/Update -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
            <h2>Customer Add/Update</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerName" style="width: 150px;">Customer Name *</label>
                <input type="text" id="customerName" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerTel" style="width: 150px;">Tel *</label>
                <input type="text" id="customerTel" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerAddress1" style="width: 150px;">Address Line1 *</label>
                <input type="text" id="customerAddress1" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerAddress2" style="width: 150px;">Address Line2</label>
                <input type="text" id="customerAddress2" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerPostcode" style="width: 150px;">Postcode *</label>
                <input type="text" id="customerPostcode" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerEmail" style="width: 150px;">Email</label>
                <input type="text" id="customerEmail" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerDiscount" style="width: 150px;">Discount</label>
                <input type="text" id="customerDiscount" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <button onclick="addOrUpdateCustomer()" style="margin-top: 10px; padding: 10px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer;">ADD / UPDATE</button>
        </div>
    </div>
</div>
</div>

<script>

</script>

    <div class="modal" id="proformaModal">
        <div class="modal-content">
            <h2>Proforma Listesi</h2>
            <input type="text" id="searchBox" placeholder="Proforma Arama..." onkeyup="searchProforma()">
            
            <!-- Kaydırılabilir tablo -->
            <div class="scrollable-table">
                <table id="proformaTable">
                    <thead>
                        <tr>
                            <th>Quote Number</th>
                            <th>User ID</th>
                            <th>User Name</th>
                            <th>Customer ID</th>
                            <th>Customer Name</th>
                            <th>DidDis</th>
                            <th>Amount</th>
                            <th>Sold</th>
                            <th>Inv</th>
                            <th>Created At</th> <!-- Yeni sütun -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dinamik veri buraya gelir -->
                    </tbody>
                </table>
            </div>
            
            <button onclick="closeProformaModal()">Kapat</button>
        </div>
    </div>

    <!-- Sabit Tab Bar - Sekme Başlıkları altta -->
    <div class="tab-bar">
        <div class="tab active" onclick="openTab('tab_proforma')">Proforma</div>
        <div class="tab" onclick="openTab('tab_unite')">Unite</div>
        <div class="tab" onclick="openTab('tab_refrigeration')">Refrigeration</div>
        <div class="tab" onclick="openTab('tab_ceiling')">Ceiling</div>
        <div class="tab" onclick="openTab('tab_add_item')">Add Item</div>
        
        <div class="tab" onclick="openTab('tab_reports')">Report</div>
        <div class="tab" onclick="openTab('tab_goruntule')">Goruntule</div>
    </div>


    

    <script>

let selectedCustomerID = null;
let selectedCustomer1ID = null;
let selectedCustomerName = null;
let selectedQuoteNumber = null; // Seçili quote numarasını saklamak için global değişken
let newQuoteNum = null;

function setCustomerInfo(customer) {
    // Backend'e müşteri bilgilerini gönder
    fetch('/set_customer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            customer_id: customer[0],
            customer_name: customer[1],
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log("Müşteri bilgileri başarıyla gönderildi.");
        } else {
            console.error("Müşteri bilgileri gönderilirken hata oluştu:", data.message);
        }
    })
    .catch(error => {
        console.error("Müşteri bilgileri gönderilirken hata oluştu:", error);
    });
}
        // Sekme açma fonksiyonu
        function openTab(tabId) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="openTab('${tabId}')"]`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.trigger-select').forEach((select, index) => {
                select.addEventListener('change', function() {
                   // toggleRowNumber(index);
                });
            });
    
            document.querySelectorAll('.bp-select').forEach((select, index) => {
                select.addEventListener('change', function() {
                    updateValueDisplay(index);
                });
            });
    
            document.querySelectorAll('.base-select').forEach((select, index) => {
                select.addEventListener('change', function() {
                    updateValueDisplay(index);
                });
            });
        });
    
        // function toggleRowNumber(index) {
        //     const rowNumberCell = document.querySelectorAll('.row-number')[index];
        //     const triggerSelect = document.querySelectorAll('.trigger-select')[index];
            
        //     if (triggerSelect.value) {
        //         rowNumberCell.textContent = index + 1; 
        //     } else {
        //         rowNumberCell.textContent = ""; 
        //     }
        // }
    
        function updateValueDisplay(index) {
        const bpSelect = document.querySelectorAll('.bp-select')[index];
        const type = document.querySelectorAll('.base-select')[index];
        const secondCombobox = document.querySelectorAll('.trigger-select')[index]; // 2. combobox
        const valueLabel1 = document.getElementById(`value1_${index}`);
        const valueLabel2 = document.getElementById(`value2_${index}`);
        const valueLabel3 = document.getElementById(`value3_${index}`);
        const valueLabel4 = document.getElementById(`value4_${index}`);

        const selectedValueBP = parseInt(bpSelect.value);
        const selectedValueBase = parseInt(type.value);
        const secondComboboxValue = secondCombobox.value; // 2. combobox değeri alınıyor
    
        let multiplier = 1;

    // 2. combobox değeri 'Single Gondola' veya 'Double Gondola' ise multiplier 2 katına çıkar
        if (secondComboboxValue === "Single Gondola" || secondComboboxValue === "Double Gondola") {
            if (!isNaN(selectedValueBase) && selectedValueBase > 10) {
                const adjustedValueBase = selectedValueBase - 10; 
                const pnl40=adjustedValueBase / 40
                valueLabel1.textContent = Math.floor(pnl40) * 2;
                const remainingAfter40 = adjustedValueBase - (Math.floor(pnl40) * 40); 
                const pnl30 = remainingAfter40 / 30; 
                valueLabel2.textContent = Math.floor(pnl30) * 2;
                const remainingAfter30 = remainingAfter40 - (Math.floor(pnl30) * 30); 
                const pnl20 = remainingAfter30 / 20; 
                valueLabel3.textContent = Math.floor(pnl20) * 2;
                const remainingAfter20 = remainingAfter30 - (Math.floor(pnl20) * 20); 
                const pnl10 = remainingAfter20 / 10; 
                valueLabel4.textContent = Math.floor(pnl10) * 2;
            }
            else {
            valueLabel1.textContent = "";
            valueLabel2.textContent = "";
            valueLabel3.textContent = "";
            valueLabel4.textContent = "";
            }  
        }
        else{

            if (!isNaN(selectedValueBase) && selectedValueBase > 10) {
                const adjustedValueBase = selectedValueBase - 10; 
                const pnl40=adjustedValueBase / 40
                valueLabel1.textContent = Math.floor(pnl40);
                const remainingAfter40 = adjustedValueBase - (Math.floor(pnl40) * 40); 
                const pnl30 = remainingAfter40 / 30; 
                valueLabel2.textContent = Math.floor(pnl30);
                const remainingAfter30 = remainingAfter40 - (Math.floor(pnl30) * 30); 
                const pnl20 = remainingAfter30 / 20; 
                valueLabel3.textContent = Math.floor(pnl20);
                const remainingAfter20 = remainingAfter30 - (Math.floor(pnl20) * 20); 
                const pnl10 = remainingAfter20 / 10; 
                valueLabel4.textContent = Math.floor(pnl10);
            }
            else {
            valueLabel1.textContent = "";
            valueLabel2.textContent = "";
            valueLabel3.textContent = "";
            valueLabel4.textContent = "";
            } 
        } 
    }       
        function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        // Rakam (0-9) ve Backspace (8) dışında bir tuş basıldığında engelle
        if (charCode != 8 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }


    // 1. İlk fonksiyon: updateWidthData
async function updateWidthData() {
    const rows = Array.from(document.querySelectorAll('tbody tr'));
    let validRows = [];
    const largestFile = document.getElementById('largestFile').textContent.trim();

    // --- Başlıkları ve üst başlıkları al ---
    const headerRows = document.querySelectorAll('.unite-table table thead tr');
    const mainHeaders = [];
    let colIndex = 0;
    headerRows[0].querySelectorAll('th').forEach(th => {
        const colspan = parseInt(th.getAttribute('colspan')) || 1;
        for (let i = 0; i < colspan; i++) {
            mainHeaders[colIndex++] = th.textContent.trim();
        }
    });
    const subHeaders = Array.from(headerRows[1].querySelectorAll('th')).map(th => th.textContent.trim());

    for (let index = 0; index < 50; index++) {
        const row = rows[index];
        const rowIndex = index + 1;

        const unitPieceElement = row.querySelector('select[name^="option1_"]');
        const unittypeElement = row.querySelector('select[name^="option2_"]');
        const heightValueElement = row.querySelector('select[name^="option3_"]');
        const widthValueElement = row.querySelector('select[name^="option4_"]');
        const baseShelfValueElement = row.querySelector('select[name^="option5_"]');

        const isEndOrCorner = unittypeElement?.value?.includes('End') ||
                              unittypeElement?.value?.includes('Corner');

        const requiredFields = [
            { name: 'Unit Piece', el: unitPieceElement },
            { name: 'Unit Type', el: unittypeElement },
            { name: 'Height', el: heightValueElement },
        ];

        if (!isEndOrCorner) {
            requiredFields.push({ name: 'Width', el: widthValueElement });
        }

        const filledFields = requiredFields.filter(item => item.el && item.el.value);
        const missingFields = requiredFields.filter(item => item.el && !item.el.value);

        if (filledFields.length > 0 && filledFields.length < requiredFields.length) {
            const missingNames = missingFields.map(item => item.name).join(', ');
            alert(`Unite sayfası Satır ${rowIndex}: lütfen doldurun: ${missingNames}`);
            return false;
        }

        if (filledFields.length === 0) {
            continue;
        }

        // --- Qty/Size ikilileri kontrolü ---
        // 1. ikili: option6_ (qty), option7_ (size)
        // 2. ikili: option8_ (qty), option9_ (size)
        // 3. ikili: option10_ (qty), option11_ (size)
        const qtySizePairs = [
            { qty: row.querySelector('select[name^="option6_"]'), size: row.querySelector('select[name^="option7_"]'), mainIdx: 7, subIdx: 6 },   // Top Shelf1 Qty/Shelf Size
            { qty: row.querySelector('select[name^="option8_"]'), size: row.querySelector('select[name^="option9_"]'), mainIdx: 9, subIdx: 8 },   // Top Shelf2 Qty/Shelf Size
            { qty: row.querySelector('select[name^="option10_"]'), size: row.querySelector('select[name^="option11_"]'), mainIdx: 11, subIdx: 10 } // Top Shelf3 Qty/Shelf Size
        ];

        for (let i = 0; i < qtySizePairs.length; i++) {
            const { qty, size, mainIdx, subIdx } = qtySizePairs[i];
            const qtyVal = qty?.value || '';
            const sizeVal = size?.value || '';
            // Alt başlıklar: subHeaders[subIdx] ve subHeaders[subIdx+1]
            if ((qtyVal && !sizeVal) || (!qtyVal && sizeVal)) {
                // Hangi alan eksikse onu bul
                let missingField = '';
                if (qtyVal && !sizeVal) missingField = subHeaders[subIdx+1] || 'Size';
                if (!qtyVal && sizeVal) missingField = subHeaders[subIdx] || 'Qty';
                alert(`Satır ${rowIndex} ${mainHeaders[mainIdx]} ${missingField} için hem Qty hem Size doldurulmalı!`);
                return false;
            }
        }

        // Devam eden seçimler
        const qtyValueElement = row.querySelector('select[name^="option6_"]'); // 1 qty
        const shelfSizeValueElement = row.querySelector('select[name^="option7_"]'); // 1 size
        const qtyOption8Element = row.querySelector('select[name^="option8_"]'); // 2 qty
        const shelfSizeOption9Element = row.querySelector('select[name^="option9_"]'); // 2 size
        const qtyOption10Element = row.querySelector('select[name^="option10_"]'); // 3 qty
        const shelfSizeOption11Element = row.querySelector('select[name^="option11_"]'); // 3 size
        const plane40Element = row.querySelector('select[name^="option13_"]');
        const perf40Element = row.querySelector('select[name^="option14_"]');
        const plane30Element = row.querySelector('select[name^="option16_"]');
        const perf30Element = row.querySelector('select[name^="option17_"]');
        const plane20Element = row.querySelector('select[name^="option19_"]');
        const perf20Element = row.querySelector('select[name^="option20_"]');
        const plane10Element = row.querySelector('select[name^="option22_"]');
        const perf10Element = row.querySelector('select[name^="option23_"]');

        validRows.push({
            row_index: rowIndex,
            unit_piece: unitPieceElement.value,
            unit_type: unittypeElement.value,
            height: heightValueElement.value,
            width: widthValueElement.value,
            base_shelf: baseShelfValueElement?.value || '',
            qty: qtyValueElement?.value || '',
            shelf_size: shelfSizeValueElement?.value || '',
            qty_option8: qtyOption8Element?.value || '',
            shelf_size_option9: shelfSizeOption9Element?.value || '',
            qty_option10: qtyOption10Element?.value || '',
            shelf_size_option11: shelfSizeOption11Element?.value || '',
            plane40: plane40Element?.value || '',
            perf40: perf40Element?.value || '',
            plane30: plane30Element?.value || '',
            perf30: perf30Element?.value || '',
            plane20: plane20Element?.value || '',
            perf20: perf20Element?.value || '',
            plane10: plane10Element?.value || '',
            perf10: perf10Element?.value || '',
            largest_file: largestFile
        });
    }

    if (validRows.length === 0) {
        window.untknt = 0;
        return true;
    }

    try {
        for (const data of validRows) {
            const response = await fetch('/update_width', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (!response.ok) {
                throw new Error(`Satır ${data.row_index} için güncelleme başarısız.`);
            }
        }

        window.untknt = 1;
        return true;

    } catch (error) {
        console.error('Hata:', error);
        document.getElementById('statusMessage').textContent = 'Güncelleme sırasında hata oluştu.';
        return false;
    }
}

// 2. İkinci fonksiyon: showAddItemData
async function showAddItemData() {
    const rows = document.querySelectorAll('#tab_add_item tbody tr'); // Tüm satırları seç
    const largestFile = document.getElementById('largestFile').textContent.trim(); // largestFile değerini al

    const addItemData = []; // Gönderilecek tüm verileri tutacak dizi

    // Tüm satırlarda dön
    rows.forEach((row) => {
        const inputs = row.querySelectorAll('input'); // Satırdaki tüm inputları al
        const itemName = inputs[0]?.value.trim(); // 1. input (Item Name)
        const qty = inputs[1]?.value.trim(); // 2. input (Quantity)
        const price = inputs[2]?.value.trim(); // 3. input (Price)
        const dsprice = inputs[3]?.value.trim(); // 4. input (After Discount)
        const kar = inputs[4]?.value.trim(); // 5. input (Depo Code)

        // Eğer en az Item Name ve Quantity doluysa, veriyi ekle
        if (itemName && qty) {
            addItemData.push({
                itemName: itemName,
                qty: parseInt(qty, 10), // Sayıya çevir
                price: parseFloat(price || 0), // Sayıya çevir, boşsa 0
                dsprice: parseFloat(dsprice || 0), // Sayıya çevir, boşsa 0
                //kar: String(kar || "") // kar değerini açıkça text'e çevir
                kar:kar
            });
        }
    });

    // Eğer gönderilecek veri yoksa uyarı ver ve işlemi durdur
     if (addItemData.length === 0) {
        ///////////////////////////////////////alert("Add item bos!");
        //return Promise.reject("Geçerli veri yok.");
        window.aditmknt = 0; // Tüm fonksiyonlar için global bir değişken oluşturuyoruz.
        return true;
    }else{
        window.aditmknt = 1;
    }

    // API'ye gönderilecek veri
    const data = {
        add_item_data: addItemData, // Toplanan tüm satırlar
        largest_file: largestFile // largestFile değeri burada kullanılıyor
    };

    // API'ye POST isteği gönder
    try {
        // Yerel veya sunucu ortamına göre API taban URL'sini ayarla
    const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';

    const apiBaseUrl = isLocal
        ? 'http://127.0.0.1:5000' // Yerel geliştirme ortamı için
        : window.location.origin; // Render.com veya herhangi bir sunucu ortamı için

    // API çağrısı
    const response = await fetch(`${apiBaseUrl}/add_item_data`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
            },
        body: JSON.stringify(data)
    });


        const responseData = await response.json();

        if (responseData.status === "success") {
            //alert("Veriler başarıyla gönderildi!");
        } else {
            throw new Error("Bir hata oluştu: " + responseData.message);
        }
    } catch (error) {
        console.error('API Hatası:', error);
        alert('Veri gönderme sırasında hata oluştu.');
        await fetch('/reset_islmdvm', { method: 'POST' });
        throw error; // Hata fırlatarak işlemi durdur
    }
}
// 3. Main fonksiyon: Sıralı çağırma ve loadQuoteList() çağrısı
async function mainFunction() {
    console.log("mainFunction çalıştı");
    // islmdvm değerini kontrol et
    const response = await fetch('/check_islmdvm');
    const data = await response.json();

        // Müşteri seçimi kontrolü
    if (!selectedCustomerID) {
    alert("Müşteri seçili değil! Lütfen bir müşteri seçin.");
    // islmdvm değerini sıfırlamak için bir API çağrısı yap
    await fetch('/reset_islmdvm', { method: 'POST' });
    return; // İşlemleri sonlandır
    }

    
        // --- YENİ KONTROL: Unite sekmesinde hiç değer yoksa color kontrolünü atla ---
    let uniteHasValue = false;
    const uniteRows = document.querySelectorAll('#tab_unite tbody tr');
    for (const row of uniteRows) {
        // Tüm select ve inputları kontrol et
        const selects = row.querySelectorAll('select');
        const inputs = row.querySelectorAll('input');
        for (const el of [...selects, ...inputs]) {
            if (el.value && el.value.trim() !== '') {
                uniteHasValue = true;
                break;
            }
        }
        if (uniteHasValue) break;
    }

    if (uniteHasValue) {
        const uptclrcont = await clrCont();
        if (!uptclrcont) {
            //console.error('Color cont basarisiz oldu.');
            await fetch('/reset_islmdvm', { method: 'POST' });
            return;
        }
    }

    if (data.status === 'busy') {
    //alert("İçeride kullanıcı var!");
    // İşlemleri iptal ettikten sonra "Make Proforma" butonuna otomatik tıklama
    await new Promise(resolve => setTimeout(resolve, 1000));
    document.getElementById('updateWidthBtn').click();
    return; // İşlemleri iptal et
    }
    // Eş zamanlı tıklamaları kontrol et
    //await checkConcurrentClicks();
    const nextNumber = await quotenumkont();
    newQuoteNum = nextNumber; // nextNumber'ı global değişkene ata
    if (!nextNumber) {
        console.error("quotenumkont işlemi başarısız. İşlem durduruldu.");
        await fetch('/reset_islmdvm', { method: 'POST' });
        return; // İşlemi sonlandır
    }

    // largestFile değerini güncelle
    document.getElementById('largestFile').textContent = nextNumber

        // 1. updateWidthData çağrısı
    const updateResult = await updateWidthData(nextNumber);
    if (!updateResult) {
        console.error('updateWidthData başarısız oldu. İşlem sonlandırıldı.');
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    // const updateResultsecnd = await uniteScndprt(nextNumber);
    // if (!updateResultsecnd && window.scnduntknt !== 0) {
    //     console.error('uniteScndprt sırasında teknik bir hata oluştu. İşlem sonlandırıldı.');
    //     await fetch('/reset_islmdvm', { method: 'POST' });
    //     return;
    // }

    await uniteScndprt(nextNumber);



    // 1. AddRefData çağrısı
    try {
        console.log("AddRefData fonksiyonu çağrıldı.");
        await AddRefData(); // İşlemin tamamlanmasını bekle
    } catch (error) {
        console.error('AddRefData başarısız oldu. İşlem sonlandırıldı.', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    // Ceiling verilerini gönder
    try {
        console.log("addCeilingData fonksiyonu çağrıldı.");
        await addCeilingData(); // Ceiling verilerini gönder
    } catch (error) {
        console.error('addCeilingData başarısız oldu. İşlem sonlandırıldı.', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    // 2. showAddItemData çağrısı
    try {
        console.log("showAddItemData fonksiyonu çağrıldı.");
        await showAddItemData(); // İşlemin tamamlanmasını bekle
    } catch (error) {
        console.error('showAddItemData başarısız oldu. İşlem sonlandırıldı.', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    
       // 3. Kullanıcıdan indirim değerini al
       const discountInput = document.getElementById('discountInput');
    const dsc = parseFloat(discountInput.value) || 0; // Kullanıcının girdiği değeri al

    // 4. apply_discount çağrısı
    try {
    const response = await fetch('/apply_discount', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
        body: JSON.stringify({ quote_number: nextNumber, dsc: dsc }) // dsc = 5
    });

    const result = await response.json();
    if (result.status !== 'success') {
        console.error('apply_discount başarısız oldu:', result.message);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }
    console.log(result.message);
    } catch (error) {
        console.error('apply_discount sırasında hata oluştu:', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    // 3. loadQuoteList çağrısı
    if ((window.untknt || 0) + (window.scnduntknt || 0) + (window.aditmknt || 0) + (window.adrefknt || 0)+ (window.adclknt || 0)<= 0) {
        alert("Proforma oluşturulacak bir değer yok!");
        await fetch('/reset_islmdvm', { method: 'POST' });
    } else {
        console.log("loadQuoteList fonksiyonu çağrılıyor.");
        
        //await renkkontrol(nextNumber);
        await createTableprofdelv(nextNumber);
        await loadQuoteList(nextNumber); // İşlemin tamamlanmasını bekle
        await loadProformaDeliveryInfo(nextNumber);
        await DpTpl(nextNumber);
        await KgTpl(nextNumber);
        await callPrepUpQt(nextNumber, dsc, selectedCustomerID, selectedCustomerName);
        await saveUniteSelection(nextNumber);
        await saveAddItemSelection(nextNumber);
        await saveRefSelection(nextNumber); // Yeni fonksiyon çağrısı
        await saveCeilSelection(nextNumber);
        await saveColorSelections(nextNumber);
        await fetchCustomerDataByQuote(newQuoteNum);
        await fetch('/reset_islmdvm', { method: 'POST' });
        
    }
}



// 4. Event Listener
document.getElementById('updateWidthBtn').addEventListener('click', mainFunction);
//document.getElementById('updateWidthBtn').addEventListener('click', quotenumkont);

// Yeni fonksiyon: quotenumkont

async function quotenumkont() {
    try {
        // Proforma listesinden seçili bir quote olup olmadığını kontrol et
        if (selectedQuoteNumber) {
            console.log(`Seçili quote bulundu: ${selectedQuoteNumber}`);

            // clear_list_table endpoint'ini çağır
            const response = await fetch('/clear_list_table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ db_name: selectedQuoteNumber }), // Veritabanı adını gönder
            });

            const data = await response.json();
            if (data.status === 'success') {
                console.log(data.message); // Başarı mesajını konsola yazdır
            } else {
                console.error('Tablo temizlenirken hata oluştu:', data.message);
                alert(data.message); // Hata mesajını kullanıcıya göster
                return null; // İşlemi sonlandır
            }

            return selectedQuoteNumber; // Seçili quote numarasını döndür
        }

        // Eğer seçili bir quote yoksa normal işlemlere devam et
        console.log("Seçili quote bulunamadı, yeni numara hesaplanıyor...");

        // Sunucudan dosya listesini al
        const response = await fetch('/get_quote_files'); // quotes klasöründeki dosyaları döndüren bir endpoint
        if (!response.ok) {
            throw new Error('Dosya listesi alınırken hata oluştu.');
        }

        // Dosya isimlerini al
        const files = await response.json(); // Örnek: ["001.db", "002.db", "010.db", "100.db"]
        if (!files || files.length === 0) {
            alert("Quotes klasöründe dosya bulunamadı.");
            return null; // İşlemi sonlandır
        }

        // Sadece .db uzantılı dosyaları ve sıfırları koruyarak numaraları ayıkla
        const fileNumbers = files
            .filter(file => file.endsWith('.db')) // .db uzantılı dosyaları seç
            .map(file => file.match(/^(\d+)\.db$/)) // Numara kısmını ve sıfırları ayıkla
            .filter(match => match) // Geçerli eşleşmeleri seç
            .map(match => match[1]); // Numara kısmını al

        if (fileNumbers.length === 0) {
            alert("Geçerli dosya numarası bulunamadı.");
            return null; // İşlemi sonlandır
        }

        // En büyük numarayı bul
        const maxNumber = fileNumbers.reduce((max, num) => 
            num.length > max.length || (num.length === max.length && num > max) ? num : max
        );

        // Bir fazlasını hesapla, sıfırları koruyarak
        const nextNumber = (BigInt(maxNumber) + 1n).toString().padStart(maxNumber.length, '0');

        console.log(`Bir sonraki dosya numarası: ${nextNumber}`);
        return nextNumber; // Hesaplanan değeri döndür
    } catch (error) {
        console.error('Hata:', error);
        alert('Dosya kontrolü sırasında bir hata oluştu.');
        return null; // İşlemi sonlandır
    }
}



document.addEventListener('DOMContentLoaded', function () {
    // Hedef değerler
    const targetValues = ["End / Wall Unit", "End / Single Gondola", "End / Double Gondola", "End / Vegetable Unit"];

    // Tüm trigger-select sınıfındaki select elementlerini dinle
    const triggerSelects = document.querySelectorAll('.trigger-select');

    triggerSelects.forEach(select => {
        select.addEventListener('change', function () {
            const row = select.closest('tr'); // Satırı bul
            const selectedValue = select.value; // Seçili değeri al
            
            // Eğer seçili değer hedef değerlerden biriyse
            if (targetValues.includes(selectedValue)) {
                lockComboboxes(row);
            } else {
                unlockComboboxes(row);
            }
        });
    });

    // Combobox'ları kilitle
    function lockComboboxes(row) {
        row.querySelectorAll('select').forEach((combobox, index) => {
            if (![0, 1, 2, 4].includes(index) && index <= 18) { // 0, 1, 2, 4 hariç 18. combobox'a kadar kilitle
                combobox.disabled = true;
            }
        });
    }

    // Combobox'ları aç
    function unlockComboboxes(row) {
        row.querySelectorAll('select').forEach((combobox, index) => {
            if (![0, 1, 2, 4].includes(index) && index <= 18) { // 0, 1, 2, 4 hariç 18. combobox'a kadar aç
                combobox.disabled = false;
            }
        });
    }
});

    document.addEventListener("DOMContentLoaded", function () {
        // Dinlenmesi gereken combobox isimlerini bir array olarak tanımlıyoruz
        const monitoredComboboxes = [
            "option13_", "option14_", 
            "option16_", "option17_", 
            "option19_", "option20_", 
            "option22_", "option23_"
        ];

        // Tüm satırlardaki comboboxlar için event listener ekle
        const selects = document.querySelectorAll("select");

        selects.forEach(select => {
            const name = select.getAttribute("name");
            if (monitoredComboboxes.some(prefix => name && name.startsWith(prefix))) {
                select.addEventListener("change", function () {
                    const row = select.closest('tr'); // İlgili satırı bul

                    // Her bir label için kontrol yap
                    checkLabelTotal(row, 'value1_', 'option13_', 'option14_');
                    checkLabelTotal(row, 'value2_', 'option16_', 'option17_');
                    checkLabelTotal(row, 'value3_', 'option19_', 'option20_');
                    checkLabelTotal(row, 'value4_', 'option22_', 'option23_');
                });
            }
        });

        // Label ile kendisinden sonraki iki combobox'ı kontrol eden fonksiyon
        function checkLabelTotal(row, labelPrefix, combobox1Prefix, combobox2Prefix) {
            const rowIndex = row.dataset.rowIndex; // Satır index'i

            // Label ve ilgili combobox'ları seç
            const label = row.querySelector(`#${labelPrefix}${rowIndex}`);
            const combobox1 = row.querySelector(`select[name="${combobox1Prefix}${rowIndex}"]`);
            const combobox2 = row.querySelector(`select[name="${combobox2Prefix}${rowIndex}"]`);

            if (label && combobox1 && combobox2) {
                const combobox1Value = parseFloat(combobox1.value) || 0;
                const combobox2Value = parseFloat(combobox2.value) || 0;
                const total = combobox1Value + combobox2Value;

                // Eğer label içeriği toplamına eşit değilse kırmızı arka plan ekle
                if (parseFloat(label.textContent) !== total) {
                    label.style.backgroundColor = "red";
                } else {
                    label.style.backgroundColor = ""; // Arka planı temizle
                }
            }
        }
    });

    //let selectedCustomerID = null;

// Modal açma
function openModal() {
    selectedCustomerID = null; // Modal açıldığında ID'yi sıfırla
    selectedCustomer1ID = null;
    document.getElementById("selectedCustomer").innerHTML = ""; // Seçilen müşteri bilgilerini temizle
    document.getElementById("customerModal").style.display = "flex";
    document.getElementById("searchBox").value = ""; // Arama kutusunu temizle
    //document.getElementById("customerName").value = "";
            // Güncelleme kısmındaki input kutularını temizle
    document.getElementById("customerName").value = "";
    document.getElementById("customerTel").value = "";
    document.getElementById("customerAddress1").value = "";
    document.getElementById("customerAddress2").value = "";
    document.getElementById("customerPostcode").value = "";
    document.getElementById("customerPostcode").disabled = false;
    document.getElementById("customerEmail").value = "";
    document.getElementById("customerDiscount").value = "";

    fetchCustomerData(); // Modal açıldığında müşteri verilerini çek
}

// Modal kapama
function closeModal() {
    document.getElementById("customerModal").style.display = "none";
}

// Müşteri verilerini çekme
function fetchCustomerData() {
    fetch("/fetch_customers")
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById("customerTable").querySelector("tbody");
            tableBody.innerHTML = ""; // Eski satırları temizle
            data.forEach(customer => {
                const tr = document.createElement("tr");
                customer.forEach(cell => {
                    const td = document.createElement("td");
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tr.addEventListener("dblclick", () => selectCustomer(customer)); // Satırı tıklanabilir hale getir
                
                tr.addEventListener("click", () => select1Customer(customer));
                tableBody.appendChild(tr);
            });
        });
}
function selectCustomer(customer) {
    selectedCustomerID = customer[0];
    selectedCustomerName = customer[1];
    selectedCustomer1ID = null;
    //alert("Customer ID: " + customer[0]); // <-- Burada alert eklendi
    document.getElementById("selectedCustomer").innerHTML = `
        <div>
            <strong>Proforma To</strong><br>
            <strong>Customer Name:</strong> ${customer[1]}<br>
            <strong>Tel:</strong> ${customer[2]}<br>
            <strong>Address Line1:</strong> ${customer[3]}<br>
            <strong>Address Line2:</strong> ${customer[4]}<br>
            <strong>Postcode:</strong> ${customer[5]}
        </div>

    `;
    // beckende musteri bilgilerini gonder    
    setCustomerInfo(customer);
    //modali kapat
    closeModal();
}

async function selectCustomerDlv(customer) {
    selectedCustomerID = customer[0];
    selectedCustomerName = customer[1];
    selectedCustomer1ID = null;

    // İlk div: Proforma To bilgileri
    document.getElementById("selectedCustomer").innerHTML = `
        <div style="width: 100; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <strong>Proforma To</strong><br>
            <strong>Customer Name:</strong> ${customer[1]}<br>
            <strong>Tel:</strong> ${customer[2]}<br>
            <strong>Address1:</strong> ${customer[3]}<br>
            <strong>Address2:</strong> ${customer[4]}<br>
            <strong>Postcode:</strong> ${customer[5]}
        </div>
        <div id="deliverTo" style="width: 100; margin-right: 100; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <strong>Deliver To</strong><br>
            <strong>Customer Name:</strong> <span id="deliverName"></span><br>
            <strong>Tel:</strong> <span id="deliverTel"></span><br>
            <strong>Address1:</strong> <span id="deliverAddress1"></span><br>
            <strong>Address2:</strong> <span id="deliverAddress2"></span><br>
            <strong>Postcode:</strong> <span id="deliverPostcode"></span>
        </div>
        <button onclick="openDeliveryModal()" style="align-self: flex-start; margin-left: 20px;">Change Delivery Address</button>
    `;

    // Backend'den Deliver To bilgilerini al
    try {
        const quoteNumber = selectedQuoteNumber ?? newQuoteNum;
        const response = await fetch(`/get_delivery_info?quote_number=${quoteNumber}`);
        //const response = await fetch(`/get_delivery_info?quote_number=${selectedQuoteNumber}`);
        const data = await response.json();

        if (data.status === "success") {
            const deliveryInfo = data.delivery_info;
            document.getElementById("deliverName").textContent = deliveryInfo.Dname || "";
            document.getElementById("deliverTel").textContent = deliveryInfo.Dtel || "";
            document.getElementById("deliverAddress1").textContent = deliveryInfo.Daddress1 || "";
            document.getElementById("deliverAddress2").textContent = deliveryInfo.Daddress2 || "";
            document.getElementById("deliverPostcode").textContent = deliveryInfo.Dpostcode || "";
        } else {
            console.error("Deliver To bilgileri alınırken hata oluştu:", data.message);
        }
    } catch (error) {
        console.error("Deliver To bilgileri alınırken hata oluştu:", error);
    }

    // Backend'e müşteri bilgilerini gönder
    setCustomerInfo(customer);
    closeModal();
}


    function select1Customer(customer) {
        selectedCustomer1ID = customer[0]; // Seçilen müşterinin ID'sini al
        //alert(`Selected Customer ID: ${selectedCustomer1ID}`); // ID'yi alert olarak göster

        // ...existing code...
        fetch(`/get_customer_by_id?id=${selectedCustomer1ID}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Customer Add/Update alanını doldur
                    document.getElementById("customerName").value = data.customer.name || "";
                    document.getElementById("customerTel").value = data.customer.tel || "";
                    document.getElementById("customerAddress1").value = data.customer.address1 || "";
                    document.getElementById("customerAddress2").value = data.customer.address2 || "";
                    document.getElementById("customerPostcode").value = data.customer.postcode || "";
                    document.getElementById("customerPostcode").disabled = true; // Postcode kutucuğunu değiştirilemez yap
                    document.getElementById("customerEmail").value = data.customer.email || "";
                    document.getElementById("customerDiscount").value = data.customer.discount || "";
                } else {
                    alert("Müşteri bilgileri alınamadı: " + data.message);
                }
            })
            .catch(error => console.error("Müşteri bilgileri alınırken hata oluştu:", error));
    }

    function toTitleCase(str) {
    return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
    }

    function addOrUpdateCustomer() {
    const nameInput = document.getElementById("customerName").value.trim();
    const telInput = document.getElementById("customerTel").value.trim();
    const address1Input = document.getElementById("customerAddress1").value.trim();
    const address2Input = document.getElementById("customerAddress2").value.trim();
    const postcodeInput = document.getElementById("customerPostcode").value.trim().toUpperCase().replace(/\s+/g, '');
    const emailInput = document.getElementById("customerEmail").value.trim();
    const discountInput = document.getElementById("customerDiscount").value.trim();

    const customerData = {
        id: selectedCustomer1ID || null,
        name: toTitleCase(nameInput),
        tel: telInput,
        address1: toTitleCase(address1Input),
        address2: toTitleCase(address2Input),
        postcode: postcodeInput,
        email: emailInput.toLowerCase(), // email'ler genelde küçük harf olur
        discount: discountInput,
    };
        
        fetch("/add_or_update_customer", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(customerData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                //alert("Customer added/updated successfully!");
                selectedCustomerID = null; // Modal açıldığında ID'yi sıfırla
                selectedCustomer1ID = null;
                document.getElementById("customerName").value = "";
                document.getElementById("customerTel").value = "";
                document.getElementById("customerAddress1").value = "";
                document.getElementById("customerAddress2").value = "";
                document.getElementById("customerPostcode").value = "";
                document.getElementById("customerEmail").value = "";
                document.getElementById("customerDiscount").value = "";
                fetchCustomerData(); // Tabloyu güncelle
                document.getElementById("customerPostcode").disabled = false;
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(error => console.error("Error:", error));
    }


// Arama fonksiyonu
function searchCustomer() {
    const input = document.getElementById("searchBox").value.toUpperCase();
    const table = document.getElementById("customerTable");
    const tr = table.getElementsByTagName("tr");

    for (let i = 1; i < tr.length; i++) { // İlk satır başlık olduğu için 1'den başla
        const tds = tr[i].getElementsByTagName("td");
        let visible = false;
        for (let td of tds) {
            if (td.textContent.toUpperCase().includes(input)) {
                visible = true;
                break;
            }
        }
        tr[i].style.display = visible ? "" : "none";
    }
}



// Aynı anda tıklayanları kontrol eden fonksiyon
async function checkConcurrentClicks() {
    try {
        const user = document.querySelector('.user-info h1').textContent.trim();
        //const userId = document.querySelector('.user-info').id.trim();
        const userId = document.querySelector('.user-info').getAttribute('data-user-id');
        const clickTime = new Date().toLocaleString(); // Kullanıcının tıklama zamanı

        const response = await fetch('/log_click', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                user: user, 
                user_id: userId 
            }),
        });

        const data = await response.json();

        if (data.status === 'success') {
            const recentClicks = data.recent_clicks;

            // Kullanıcının kendi tıklama detaylarını göster
            let alertMessage = `Tıklayan Kullanıcı: ${user} (ID: ${userId})\nTıklama Saati: ${clickTime}`;

            // Eğer başka kullanıcılar da tıkladıysa, onları listele
            if (recentClicks.length > 1) {
                const otherUsers = recentClicks
                    .filter(log => log.user_id !== userId)
                    .map(log => {
                        const time = new Date(log.time).toLocaleTimeString();
                        return `${log.user} (ID: ${log.user_id}) - ${time}`;
                    })
                    .join('\n');

                alertMessage += `\n\nAynı anda tıklayan diğer kullanıcılar:\n${otherUsers}`;
            }

            alert(alertMessage);
        }
    } catch (error) {
        console.error('Eş zamanlı tıklama kontrol hatası:', error);
    }
}

async function openProformaModal() {
    const modal = document.getElementById('proformaModal');
    modal.style.display = 'flex'; // Modalı görünür yap

    try {
        const response = await fetch('/get_quotes');
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        // Tabloyu doldur
        const tableBody = document.getElementById('proformaTable').querySelector('tbody');
        tableBody.innerHTML = ''; // Önceki içeriği temizle

        data.rows.forEach(row => {
            const tr = document.createElement('tr');
            row.forEach((cell, index) => {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });

            // Satıra tıklama olayı ekle
            tr.addEventListener('click', async () => {
                const quoteNumber = row[0]; // Birinci sütundaki numarayı al
                const discountValue = row[5]; // Discount değerini al
                selectedQuoteNumber = row[0]; // Birinci sütundaki quote numarasını al
                const deliveryPriceValue = row[10] || 0; // 10. sütun DeliveryPrice (Delpr) ise
                const Sing1 = row[7];
                const Sing2 = row[8];
                const dbName = `${quoteNumber}`; // Dosya adını oluştur

                // Discount değerini dsc alanına yaz
                document.getElementById('discountInput').value = discountValue;
                document.getElementById('deliveryPriceInput').value = deliveryPriceValue;

                // Eğer Sing1 veya Sing2 doluysa "Make Proforma" butonunu kilitle
                const makeProformaButton = document.getElementById('updateWidthBtn');
                if (Sing1 || Sing2) {
                    makeProformaButton.disabled = true;
                    makeProformaButton.style.cursor = 'not-allowed';
                    makeProformaButton.title = 'This quote is already processed.';
                } else {
                    makeProformaButton.disabled = false;
                    makeProformaButton.style.cursor = 'pointer';
                    makeProformaButton.title = '';
                }

                // Sıralı ve await'li şekilde çağır
                await fetchCustomerDataByQuote(quoteNumber);
                await loadUniteSelection(dbName);
                await loadAddItemSelection(dbName);
                await loadRefSelection(dbName);
                await loadCeilSelection(dbName);
                loadColorSelections(dbName);
                updateQuoteDate(quoteNumber);
                loadQuoteList(dbName);

                closeProformaModal(); // Modalı kapat
            });

            tableBody.appendChild(tr);
        });
    } catch (error) {
        console.error('Hata:', error);
        alert('Proforma listesi yüklenirken bir hata oluştu.');
    }
}

function closeProformaModal() {
    const modal = document.getElementById('proformaModal');
    modal.style.display = 'none'; // Modalı gizle
}

async function loadQuoteList(dbName) {
let inputsLocked = true;
    try {
        const viewMode = document.getElementById('viewMode').value;
        const response = await fetch(`/get_quote_list?db_name=${dbName}`);

        if (!response.ok) {
            if (response.status === 404) {
                alert('Dosya bulunamadı: ' + dbName);
            }
            throw new Error('Veri alınırken hata oluştu.');
        }

        const responseData = await response.json();
        const { db_name, data } = responseData;

        const tableHeader = document.getElementById('tableHeader');
        tableHeader.textContent = `Quote list: ${db_name}`;

        const tableBody = document.getElementById('quoteListTable').querySelector('tbody');
        tableBody.innerHTML = '';

        if (!data || data.length === 0) {
            alert('Gösterilecek liste verisi bulunamadı.');
            return;
        }

        if (viewMode === 'parts') {
            const grouped = {};

            data.forEach(row => {
                const itemName = row[2];
                const key = itemName;
                const adet = row[3];
                const index = row[9];

                if (!grouped[key]) {
                    grouped[key] = { ...row };
                    grouped[key].adet = adet;
                    grouped[key].amount = row[8];
                    grouped[key].dbList = [{ index, adet }];
                } else {
                    grouped[key].adet += adet;
                    grouped[key].amount += row[8];
                    grouped[key].dbList.push({ index, adet });
                }
            });

            let totalPrice = 0, totalDPrice = 0, totalAmount = 0;

            Object.values(grouped).forEach(row => {
                totalPrice += parseFloat(row[6]) || 0;
                totalDPrice += parseFloat(row[7]) || 0;
                totalAmount += parseFloat(row.amount) || 0;

                const dbIndexAdetList = row.dbList.map(entry => `${entry.index}-${entry.adet}`).join(', ');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="display:none;">${row[0]}</td>
                    <td style="text-align: Left;">${row[1]}</td>
                    <td style="text-align: Left;">${row[2]}</td>
                    <td>
                        <input class="adet-input" type="number" value="${row.adet}" min="0" style="width:60px;" disabled onkeypress="return isNumberKey(event)" />
                    </td>
                    <td style="display:none;">${row[4]}</td>
                    <td style="display:none;">${row[5]}</td>
                    <td style="display:none;">${parseFloat(row[6]).toFixed(2)}</td>
                    <td style="text-align: Right;">${parseFloat(row[7]).toFixed(2)}</td>
                    <td style="text-align: Right;">${parseFloat(row.amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td style="display:none;">${dbIndexAdetList}</td>
                `;
                tableBody.appendChild(tr);
            });

            const deliveryPriceInput = document.getElementById('deliveryPriceInput');
            const deliveryPrice = parseFloat(deliveryPriceInput.value) || 0;

            const vat = (totalAmount+deliveryPrice) * 0.2;
            const grandTotal = totalAmount + deliveryPrice + vat;

            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">Total:</td>
                <td style="font-weight: bold; text-align: right;">${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(totalRow);

           // Delivery Price satırı

            const deliveryRow = document.createElement('tr');
            deliveryRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">Delivery:</td>
                <td style="font-weight: bold; text-align: right;">${deliveryPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(deliveryRow);

            // VAT ve Grand Total satırları
            const vatRow = document.createElement('tr');
            vatRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">Vat (20%):</td>
                <td style="font-weight: bold; text-align: right;">${vat.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(vatRow);

            const grandTotalRow = document.createElement('tr');
            grandTotalRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">G.Total:</td>
                <td style="font-weight: bold; text-align: right;">${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(grandTotalRow);

            return;
        }

        // Subtotal mode (viewMode !== 'parts')
        const subtotals = {};
        const rowsByGroup = {};

        let totalPrice = 0, totalDPrice = 0, totalAmount = 0;

        data.forEach(row => {
            const tr = document.createElement('tr');
            const adet = row[3];
            const index = row[9];

            tr.innerHTML = `
                <td style="display:none;">${row[0]}</td>
                <td style="text-align: Left;">${row[1]}</td>
                <td style="text-align: Left;">${row[2]}</td>
                <td>
                    <input class="adet-input" type="number" value="${adet}" min="0" style="width:60px;" disabled onkeypress="return isNumberKey(event)" />
                </td>
                <td style="display:none;">${row[4]}</td>
                <td style="display:none;">${row[5]}</td>
                <td style="display:none;">${parseFloat(row[6]).toFixed(2)}</td>
                <td style="text-align: Right;">${parseFloat(row[7]).toFixed(2)}</td>
                <td style="text-align: Right;">${parseFloat(row[8]).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td style="display:none;">${index}-${adet}</td>
            `;
            tableBody.appendChild(tr);

            totalPrice += parseFloat(row[6]) || 0;
            totalDPrice += parseFloat(row[7]) || 0;
            totalAmount += parseFloat(row[8]) || 0;

            const siraRaw = String(row[5]);
            const sira = parseInt(siraRaw.includes('.') ? siraRaw.replace('.', '') : siraRaw, 10);
            if (sira >= 3500) return;

            const unitType = row[4];
            const groupKey = `SIRA-${sira}`;
            const amount = parseFloat(row[8]) || 0;

            if (!subtotals[groupKey]) {
                subtotals[groupKey] = { amount: 0, unitType: unitType };
                rowsByGroup[groupKey] = [];
            }

            subtotals[groupKey].amount += amount;
            rowsByGroup[groupKey].push(tr);
        });

        Object.keys(rowsByGroup).forEach(groupKey => {
            const groupId = groupKey.replace(/[^a-zA-Z0-9-_]/g, '-');
            const rows = rowsByGroup[groupKey];
            const { unitType, amount } = subtotals[groupKey];

            rows.forEach(tr => {
                tr.classList.add(groupId, 'group-row');
                tr.style.display = 'none';
            });

            // Sıra numarasının son hanesini bul
            let siraNo = "";
            const firstRow = rows[0];
            let uniteSecondColValue = "";
            if (firstRow) {
                // Sıra numarası (6. kolon, index 5)
                const siraCell = firstRow.children[5];
                if (siraCell) {
                    const siraText = siraCell.textContent.trim();
                    const siraParts = siraText.split('.');

                    if (siraParts[0].startsWith('1')) {
                        siraNo = siraParts[0].slice(-1); // Sadece son karakter
                    } else {
                        siraNo = siraParts[0]; // Tamamı
                    }
                }
            }

            // Unite tablosunda ilgili satırın 2. kolonundaki değeri ve 4,5,6. kolonları bul
            let uniteColValues = [];
            let bPlusText = "";
            let shelfSum = 0;
            let showShelfSum = true;
            let isDouble = false;
            if (siraNo) {
                const uniteRow = document.querySelector(`#tab_unite tbody tr[data-row-index="${parseInt(siraNo)-1}"]`);
                if (uniteRow) {
                    // 2. kolon (index 1)
                    const col2 = uniteRow.children[1];
                    if (col2) {
                        const select = col2.querySelector('select');
                        uniteSecondColValue = select ? select.value : (col2.textContent.trim() || "");
                    }
                    // 4,5,6. kolonlar: index 3,4,5
                    for (let i = 3; i <= 5; i++) {
                        const col = uniteRow.children[i];
                        let val = "";
                        if (col) {
                            const select = col.querySelector('select');
                            val = select ? select.value : (col.textContent.trim() || "");
                        }
                        uniteColValues.push(val);
                    }
                    // 6. kolon (index 5) için B+ kontrolü
                    if (uniteColValues[2]) {
                        bPlusText = "B ";
                    }
                    // "Double" kontrolü
                    isDouble = (unitType && unitType.toLowerCase().includes("double")) || (uniteSecondColValue && uniteSecondColValue.toLowerCase().includes("double"));
                    // 7,9,11. kolonların (index 6,8,10) değerlerini topla
                    let sum = 0;
                    [6, 8, 10].forEach(idx => {
                        const col = uniteRow.children[idx];
                        let val = 0;
                        if (col) {
                            const select = col.querySelector('select');
                            val = select ? parseInt(select.value) || 0 : parseInt(col.textContent.trim()) || 0;
                        }
                        sum += val;
                    });
                    shelfSum = isDouble ? Math.round(sum / 2) : sum;
                    // Eğer başlık "End" ile başlıyorsa B+ ve shelfSum gösterilmesin
                    if (unitType && unitType.trim().toLowerCase().startsWith("end")) {
                        bPlusText = "";
                        showShelfSum = false;
                    }
                }
            }

            const uniteColText = uniteColValues.filter(Boolean).join('x');

            const subtotalRow = document.createElement('tr');
            subtotalRow.classList.add('subtotal-header');
            subtotalRow.style.cursor = 'pointer';
            subtotalRow.innerHTML = `
                <td colspan="1"></td>
                <td colspan="1" style="font-weight: bold; text-align: Left;">
                    ${uniteSecondColValue ? uniteSecondColValue + "x" : ""}
                    ${unitType} ${uniteColText ? uniteColText : ""}
                    ${bPlusText && showShelfSum && shelfSum < 1 ? "  ---- "+ bPlusText:""}
                    ${bPlusText && showShelfSum && shelfSum > 0 ? "  ---- "+ bPlusText +"+ "+ shelfSum + " Shelf" : ""}
                    ${!bPlusText && showShelfSum && shelfSum > 0 ? "  ---- "+ shelfSum + " Shelf" : ""}
                </td>
                <td colspan="2"></td>
                <td style="font-weight: bold;text-align: Right;">
                    ${amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </td>
            `;

            subtotalRow.addEventListener('click', () => {
                const groupRows = document.querySelectorAll(`.${groupId}`);
                groupRows.forEach(row => {
                    row.style.display = (row.style.display === 'none') ? '' : 'none';
                });
            });

            const lastRow = rows[rows.length - 1];
            lastRow.after(subtotalRow);
        });

            const deliveryPriceInput = document.getElementById('deliveryPriceInput');
            const deliveryPrice = parseFloat(deliveryPriceInput.value) || 0;

            const vat = (totalAmount+deliveryPrice) * 0.2;
            const grandTotal = totalAmount + deliveryPrice + vat;

            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">Total:</td>
                <td style="font-weight: bold; text-align: right;">${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(totalRow);

           // Delivery Price satırı

            const deliveryRow = document.createElement('tr');
            deliveryRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">Delivery:</td>
                <td style="font-weight: bold; text-align: right;">${deliveryPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(deliveryRow);

            // VAT ve Grand Total satırları
            const vatRow = document.createElement('tr');
            vatRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">Vat (20%):</td>
                <td style="font-weight: bold; text-align: right;">${vat.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(vatRow);

            const grandTotalRow = document.createElement('tr');
            grandTotalRow.innerHTML = `
                <td colspan="4" style="font-weight: bold; text-align: right;">G.Total:</td>
                <td style="font-weight: bold; text-align: right;">${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(grandTotalRow);

    } catch (error) {
        console.error('Hata:', error);
        document.getElementById('statusMessage').textContent = 'Liste yüklenirken hata oluştu.';
    }

    DpTpl(dbName);
    KgTpl(dbName);
}


// Sayfa yüklendiğinde sunucudan tarih ve saat bilgisini çek
document.addEventListener('DOMContentLoaded', fetchServerTime);

async function saveUniteSelection(quoteNumber) {
    const rows = Array.from(document.querySelectorAll('#tab_unite tbody tr'));
    const selections = rows.map(row => {
        const selects = Array.from(row.querySelectorAll('select'));
        const inputs = Array.from(row.querySelectorAll('input')); // Text box'ları da dahil et
        return [...selects, ...inputs].map(input => input.value || null); // Seçili değerleri al
    });

    try {
        const response = await fetch('/save_unite_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                selections: selections,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Seçimler başarıyla kaydedildi.');
        } else {
            console.error('Seçimler kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Seçimler kaydedilirken hata oluştu:', error);
    }
}


async function loadUniteSelection(quoteNumber) {
    try {
        const response = await fetch(`/load_unite_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const selections = data.selections;
            const rows = Array.from(document.querySelectorAll('#tab_unite tbody tr'));

            rows.forEach((row, index) => {
                const selects = Array.from(row.querySelectorAll('select'));
                const inputs = Array.from(row.querySelectorAll('input')); // Text box'ları da dahil et
                const selection = selections[index] || [];
                [...selects, ...inputs].forEach((input, i) => {
                    input.value = selection[i] || ''; // Seçimleri geri yükle
                });

                // Seçimler yüklendikten sonra hesaplama fonksiyonunu çağır
                updateValueDisplay(index);
            });

            console.log('Seçimler başarıyla yüklendi.');
        } else {
            console.error('Seçimler yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Seçimler yüklenirken hata oluştu:', error);
    }

    // Kilit sistemini tetikleme
    const targetValues = ["End / Wall Unit", "End / Single Gondola", "End / Double Gondola", "End / Vegetable Unit"];
    const triggerSelects = document.querySelectorAll('.trigger-select');

    triggerSelects.forEach(select => {
        const row = select.closest('tr'); // Satırı bul
        const selectedValue = select.value; // Seçili değeri al

        if (targetValues.includes(selectedValue)) {
            lockComboboxes(row);
        } else {
            unlockComboboxes(row);
        }
    });

    function lockComboboxes(row) {
        row.querySelectorAll('select').forEach((combobox, index) => {
            if (![0, 1, 2, 4].includes(index) && index <= 18) {
                combobox.disabled = true;
            }
        });
    }

    function unlockComboboxes(row) {
        row.querySelectorAll('select').forEach((combobox, index) => {
            if (![0, 1, 2, 4].includes(index) && index <= 18) {
                combobox.disabled = false;
            }
        });
    }
}


async function fetchCustomerDataByQuote(quoteNumber) {
    try {
        const response = await fetch(`/get_customer_by_quote?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            // Müşteri bilgilerini al
            const customer = [
                data.customer_id,    // ID
                data.customer_name,  // Name
                data.tel,            // Tel
                data.address1,        // Address1
                data.address2,        // Address2
                data.postcode        // Postcode
            ];

            // selectCustomer fonksiyonunu tetikle
            //selectCustomer(customer);
            selectCustomerDlv(customer);
        } else {
            console.error('Müşteri bilgileri alınırken hata oluştu:', data.message);
            alert(data.message); // Hata mesajını kullanıcıya göster
        }
    } catch (error) {
        console.error('Müşteri bilgileri alınırken hata oluştu:', error);
        alert('Müşteri bilgileri alınırken bir hata oluştu.');
    }
}


async function callPrepUpQt(quoteNumber, dsc, customerId, customerName) {
    try {
        const deliveryPriceInput = document.getElementById('deliveryPriceInput');
        const deliveryPrice = parseInt(deliveryPriceInput?.value) || 0;

        const response = await fetch('/prep_up_qt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                quote_number: quoteNumber, 
                dsc: dsc,
                del_pr: deliveryPrice,
                customer_id: customerId,         // <-- müşteri id
                customer_name: customerName      // <-- müşteri adı
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log(data.message);
        } else {
            console.error('prep_up_qt çağrılırken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('prep_up_qt isteği sırasında hata oluştu:', error);
    }
}

async function fetchServerTime() {
    try {
        const response = await fetch('/get_server_time'); // Sunucudan tarih ve saat bilgisini al
        if (!response.ok) {
            throw new Error('Sunucudan tarih ve saat alınamadı.');
        }

        const data = await response.json();
        if (data.status === 'success') {
            const serverTimeElement = document.getElementById('serverTime');
            serverTimeElement.textContent = `Server Time: ${data.server_time}`; // `server_time` kullanıldı
        } else {
            console.error('Tarih ve saat alınırken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Tarih ve saat alınırken hata oluştu:', error);
    }
}

document.addEventListener('DOMContentLoaded', fetchServerTime); // Sayfa yüklendiğinde çağır

async function saveAddItemSelection(quoteNumber) {
    const rows = Array.from(document.querySelectorAll('#tab_add_item tbody tr'));
    const selections = rows.map(row => {
        const inputs = Array.from(row.querySelectorAll('input'));
        return inputs.map(input => input.value || null); // Input değerlerini al
    });

    // Selections verilerini gösteren alert mesajı
    //alert("Kaydedilecek Selections Verileri:\n" + JSON.stringify(selections, null, 2));

    try {
        const response = await fetch('/save_aditm_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                selections: selections,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Add Item seçimleri başarıyla kaydedildi.');
        } else {
            console.error('Add Item seçimleri kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Add Item seçimleri kaydedilirken hata oluştu:', error);
    }
}

async function loadAddItemSelection(quoteNumber) {
    try {
        const response = await fetch(`/load_aditm_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const selections = data.selections;
            const rows = Array.from(document.querySelectorAll('#tab_add_item tbody tr'));

            //console.log("Gelen veriler:", selections); // Gelen verileri logla

            rows.forEach((row, index) => {
                const inputs = Array.from(row.querySelectorAll('input'));
                const selection = selections[index] || {}; // Seçim nesnesini al

                //console.log(`Satır ${index} için seçimler:`, selection); // Satır bazında seçimleri logla

                // Input alanlarına değerleri ata
                if (inputs.length >= 5) {
                    inputs[0].value = selection.item_name || ''; // Item Name
                    inputs[1].value = selection.quantity || ''; // Quantity
                    inputs[2].value = selection.price || ''; // Price
                    inputs[3].value = selection.discounted_price || ''; // After Discount
                    inputs[4].value = selection.depo_code || ''; // Depo Code
                }
            });

            console.log('Add Item seçimleri başarıyla yüklendi.');
        } else {
            console.error('Add Item seçimleri yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Add Item seçimleri yüklenirken hata oluştu:', error);
    }
}



function clearAddItemPage() {
    const rows = Array.from(document.querySelectorAll('#tab_add_item tbody tr'));
    rows.forEach(row => {
        const inputs = Array.from(row.querySelectorAll('input'));
        inputs.forEach(input => {
            input.value = ''; // Tüm inputları temizle
        });
    });
}

document.addEventListener('DOMContentLoaded', function () {
    // Group seçimlerini doldur
    const groupSelects = document.querySelectorAll('.group-select');
    groupSelects.forEach(select => {
        fetch('/get_refrigeration_groups')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    data.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Group verileri alınırken hata oluştu:', data.message);
                }
            })
            .catch(error => console.error('Group verileri alınırken hata oluştu:', error));
    });

    // Group, item ve customer type değişikliklerini dinle
    document.querySelectorAll('.group-select, .item-select, #customerType').forEach(element => {
        element.addEventListener('change', function () {
            const row = this.closest('tr');
            const groupSelect = row ? row.querySelector('.group-select') : null;
            const itemSelect = row ? row.querySelector('.item-select') : null;
            const customerType = document.getElementById('customerType').value;
            const priceLabel = row ? row.querySelector('label[id^="price_"]') : null;
            const ref1price = priceLabel
            const dpriceLabel = row ? row.querySelector('label[id^="dprice_"]') : null;
            const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Get ref_dsc value

            // Group değiştiğinde item ve sonraki seçim kutularını sıfırla
            if (this.classList.contains('group-select')) {
                if (itemSelect) {
                    itemSelect.innerHTML = '<option value=""></option>';
                    itemSelect.value = ''; // Item seçimini sıfırla
                }
                const inputsAndSelects = Array.from(row.querySelectorAll('select, input')).slice(1); // Group'tan sonraki tüm elemanlar
                inputsAndSelects.forEach(inputOrSelect => {
                    if (inputOrSelect.tagName === 'SELECT') {
                        inputOrSelect.value = ''; // Seçimi sıfırla
                    } else if (inputOrSelect.tagName === 'INPUT') {
                        inputOrSelect.value = ''; // Giriş kutusunu sıfırla
                    }
                });
                if (priceLabel) priceLabel.textContent = ''; // Fiyatı sıfırla
                    dpriceLabel.textContent = '';

                const selectedGroup = groupSelect.value;
                if (selectedGroup) {
                    fetch(`/get_refrigeration_items?group=${encodeURIComponent(selectedGroup)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                data.items.forEach(item => {
                                    const option = document.createElement('option');
                                    option.value = item;
                                    option.textContent = item;
                                    itemSelect.appendChild(option);
                                });
                            } else {
                                console.error('Item verileri alınırken hata oluştu:', data.message);
                            }
                        })
                        .catch(error => console.error('Item verileri alınırken hata oluştu:', error));
                }
            }

            // Item değiştiğinde sonraki seçim kutularını ve giriş kutularını sıfırla
            if (this.classList.contains('item-select')) {
                const inputsAndSelects = Array.from(row.querySelectorAll('select, input')).slice(2); // Item'den sonraki tüm elemanlar
                inputsAndSelects.forEach(inputOrSelect => {
                    if (inputOrSelect.tagName === 'SELECT') {
                        inputOrSelect.value = ''; // Seçimi sıfırla
                    } else if (inputOrSelect.tagName === 'INPUT') {
                        inputOrSelect.value = ''; // Giriş kutusunu sıfırla
                    }
                });
            }

            // Group, item veya customer type değiştiğinde fiyatı güncelle veya sıfırla
            const selectedGroup = groupSelect ? groupSelect.value : null;
            const selectedItem = itemSelect ? itemSelect.value : null;

            if (selectedGroup && selectedItem && customerType) {
                fetch(`/get_refrigeration_price?model=${encodeURIComponent(selectedItem)}&customer_type=${encodeURIComponent(customerType)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            priceLabel.textContent = data.price.toFixed(2); // Display price
                            dpriceLabel.textContent = (data.price - (data.price * discount / 100)).toFixed(2); // Apply discount
                        } else {
                            console.error('Fiyat alınırken hata oluştu:', data.message);
                            priceLabel.textContent = ''; // Clear price on error
                            dpriceLabel.textContent = ''; // Clear discounted price on error
                        }
                    })
                    .catch(error => {
                        console.error('Fiyat alınırken hata oluştu:', error);
                        priceLabel.textContent = ''; // Clear price on error
                        dpriceLabel.textContent = ''; // Clear discounted price on error
                    });
            } else {
                if (priceLabel) priceLabel.textContent = ''; // Clear price if no selection
                if (dpriceLabel) dpriceLabel.textContent = ''; // Clear discounted price if no selection
            }
        });
    });

    // Customer type değiştiğinde fiyatı güncelle
    document.getElementById('customerType').addEventListener('change', function () {
        const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
        document.querySelectorAll('tr').forEach(row => {
            const groupSelect = row.querySelector('.group-select');
            const itemSelect = row.querySelector('.item-select');
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');

            const warrantyValue = parseFloat(row.querySelector('.warranty-select')?.value) || 0;
            const unpackValue = parseFloat(row.querySelector('.unpack-select')?.value) || 0;
            const removeValue = parseFloat(row.querySelector('.remove-select')?.value) || 0;
            
            const customerType = this.value;

            if (groupSelect && itemSelect && priceLabel && groupSelect.value && itemSelect.value) {
                fetch(`/get_refrigeration_price?model=${encodeURIComponent(itemSelect.value)}&customer_type=${encodeURIComponent(customerType)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            priceLabel.textContent = (data.price + warrantyValue + unpackValue + removeValue).toFixed(2); // Fiyatı güncelle
                            dpriceLabel.textContent = (data.price - (data.price * discount / 100) + warrantyValue + unpackValue + removeValue).toFixed(2);
                        } else {
                            console.error('Fiyat alınırken hata oluştu:', data.message);
                            priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                            dpriceLabel.textContent = '';
                        }
                    })
                    .catch(error => {
                        console.error('Fiyat alınırken hata oluştu:', error);
                        priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                        dpriceLabel.textContent = '';
                    });
            }
        });
    });

    // Function to update dprice for all rows
    function updateAllDPrices() {
        const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Get ref_dsc value
        document.querySelectorAll('tr').forEach(row => {
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');
            const warrantyValue = parseFloat(row.querySelector('.warranty-select')?.value) || 0;
            const unpackValue = parseFloat(row.querySelector('.unpack-select')?.value) || 0;
            const removeValue = parseFloat(row.querySelector('.remove-select')?.value) || 0;

            if (priceLabel && dpriceLabel && priceLabel.textContent) {
                const basePrice = parseFloat(priceLabel.textContent)-(warrantyValue+unpackValue+removeValue); // Base price before additions
                //alert(basePrice);
                const discountedPrice = (basePrice - (basePrice * discount / 100)).toFixed(2); // Calculate discounted price
                dpriceLabel.textContent = (parseFloat(discountedPrice) + warrantyValue + unpackValue + removeValue).toFixed(2); // Add additional values
            }
        });
    }

    // Update dprice when ref_dsc changes
    document.getElementById('ref_dsc').addEventListener('input', updateAllDPrices);
});

document.addEventListener('DOMContentLoaded', function () {

    document.querySelectorAll('.item-select').forEach(itemSelect => {
        itemSelect.addEventListener('change', function () {
            const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
            const row = this.closest('tr');
            const selectedItem = this.value;
            const warrantySelect = row.querySelector('.warranty-select');
            const unpackSelect = row.querySelector('.unpack-select');
            const removeSelect = row.querySelector('.remove-select');
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');
            const skuLabel = row.querySelector('label[id^="sku_"]');

            if (selectedItem) {
                fetch(`/get_refrigeration_item_details?model=${encodeURIComponent(selectedItem)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Populate warranty, unpack, and remove values with an empty option
                            warrantySelect.innerHTML = `<option value=""></option><option value="${data.warranty}">${data.warranty}</option>`;
                            unpackSelect.innerHTML = `<option value=""></option><option value="${data.unpack}">${data.unpack}</option>`;
                            removeSelect.innerHTML = `<option value=""></option><option value="${data.remove}">${data.remove}</option>`;

                            // Update price and dprice
                            const basePrice = parseFloat(priceLabel.textContent) || 0;
                            priceLabel.textContent = basePrice.toFixed(2);
                            dpriceLabel.textContent = (basePrice - (basePrice * discount / 100)).toFixed(2);

                            // Update SKU with TradePrice and Kar
                            const tradePrice = parseFloat(data.tradePrice) || 0;
                            const kar = parseFloat(data.kar) || 0;
                            //skuLabel.textContent = `${selectedItem} ${tradePrice.toFixed(2)}-${kar.toFixed(2)}`;
                            skuLabel.textContent = `SKU ${tradePrice}-${kar}`;
                        } else {
                            console.error('Item details alınırken hata oluştu:', data.message);
                            warrantySelect.innerHTML = '<option value=""></option>';
                            unpackSelect.innerHTML = '<option value=""></option>';
                            removeSelect.innerHTML = '<option value=""></option>';
                            skuLabel.textContent = ''; // Clear SKU on error
                        }
                    })
                    .catch(error => {
                        console.error('Item details alınırken hata oluştu:', error);
                        warrantySelect.innerHTML = '<option value=""></option>';
                        unpackSelect.innerHTML = '<option value=""></option>';
                        removeSelect.innerHTML = '<option value=""></option>';
                        skuLabel.textContent = ''; // Clear SKU on error
                    });
            } else {
                warrantySelect.innerHTML = '<option value=""></option>';
                unpackSelect.innerHTML = '<option value=""></option>';
                removeSelect.innerHTML = '<option value=""></option>';
                priceLabel.textContent = '';
                dpriceLabel.textContent = '';
                skuLabel.textContent = ''; // Clear SKU if no selection
            }
        });
    });

    document.querySelectorAll('.warranty-select, .unpack-select, .remove-select').forEach(select => {
        select.addEventListener('change', function () {
            const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
            const row = this.closest('tr');
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');
            const warrantyValue = parseFloat(row.querySelector('.warranty-select').value) || 0;
            const unpackValue = parseFloat(row.querySelector('.unpack-select').value) || 0;
            const removeValue = parseFloat(row.querySelector('.remove-select').value) || 0;

            const basePrice = parseFloat(priceLabel.dataset.basePrice) || parseFloat(priceLabel.textContent) || 0;

            // Calculate updated price
            const updatedPrice = basePrice + warrantyValue + unpackValue + removeValue;

            // Store the base price in a data attribute for future reference
            priceLabel.dataset.basePrice = basePrice;

            priceLabel.textContent = updatedPrice.toFixed(2);
            dpriceLabel.textContent = ((basePrice - (basePrice * discount / 100)) + warrantyValue + unpackValue + removeValue).toFixed(2);
        });
    });

});

document.querySelectorAll('.warranty-select, .unpack-select, .remove-select').forEach(select => {
    select.addEventListener('change', function () {
        const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
        const customerType = document.getElementById('customerType').value; // Customer type alındı
        const row = this.closest('tr');
        const priceLabel = row.querySelector('label[id^="price_"]');
        const dpriceLabel = row.querySelector('label[id^="dprice_"]');
        const warrantyValue = parseFloat(row.querySelector('.warranty-select').value) || 0;
        const unpackValue = parseFloat(row.querySelector('.unpack-select').value) || 0;
        const removeValue = parseFloat(row.querySelector('.remove-select').value) || 0;
        const itemSelect = row.querySelector('.item-select');

        if (itemSelect && itemSelect.value && customerType) {
            fetch(`/get_refrigeration_price?model=${encodeURIComponent(itemSelect.value)}&customer_type=${encodeURIComponent(customerType)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const basePrice = data.price; // Customer type'a göre fiyat alındı
                        const updatedPrice = basePrice + warrantyValue + unpackValue + removeValue;

                        // Store the base price in a data attribute for future reference
                        priceLabel.dataset.basePrice = basePrice;

                        priceLabel.textContent = updatedPrice.toFixed(2);
                        dpriceLabel.textContent = ((basePrice - (basePrice * discount / 100)) + warrantyValue + unpackValue + removeValue).toFixed(2);
                    } else {
                        console.error('Fiyat alınırken hata oluştu:', data.message);
                        priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                        dpriceLabel.textContent = '';
                    }
                })
                .catch(error => {
                    console.error('Fiyat alınırken hata oluştu:', error);
                    priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                    dpriceLabel.textContent = '';
                });
        } else {
            console.error('Gerekli bilgiler eksik: itemSelect veya customerType');
        }
    });
});

async function AddRefData() {
    const rows = document.querySelectorAll('#tab_refrigeration tbody tr'); // Refrigeration tablosundaki satırları seç
    const largestFile = document.getElementById('largestFile').textContent.trim(); // largestFile değerini al

    const refData = []; // Gönderilecek tüm verileri tutacak dizi
    let validRowFound = false; // Geçerli bir satır bulunup bulunmadığını kontrol etmek için

    rows.forEach((row) => {
        const sku = row.querySelector('label[id^="sku_"]')?.textContent.trim(); // SKU değeri
        const itemName = row.querySelector('.item-select')?.value.trim(); // Seçilen item
        const quantity = row.querySelector('input[name^="quantity_"]')?.value.trim(); // Girilen quantity
        const price = row.querySelector('label[id^="price_"]')?.textContent.trim(); // Price değeri
        const dprice = row.querySelector('label[id^="dprice_"]')?.textContent.trim(); // D.Price değeri

        // Eğer 1., 2., 6., 7., 8., ve 9. kolonlar doluysa, veriyi ekle
        if (sku && itemName && quantity && price && dprice) {
            refData.push({
                sku: sku,
                itemName: itemName,
                quantity: parseInt(quantity, 10), // Sayıya çevir
                price: parseFloat(price || 0), // Sayıya çevir, boşsa 0
                dprice: parseFloat(dprice || 0), // Sayıya çevir, boşsa 0,
                unitType: "Add Refrigeration" // Sabit değer
            });
            validRowFound = true; // Geçerli bir satır bulundu
        }
    });

    // Eğer geçerli bir satır bulunmadıysa işlemi durdur
    if (!validRowFound) {
        console.log("Refrigeration tablosunda işlenecek geçerli veri yok.");
        window.adrefknt = 0; // Tüm fonksiyonlar için global bir değişken oluşturuyoruz.
        return true;
    } else {
        window.adrefknt = 1;
    }

    // API'ye gönderilecek veri
    const data = {
        ref_data: refData, // Toplanan tüm satırlar
        largest_file: largestFile // largestFile değeri burada kullanılıyor
    };

    // API'ye POST isteği gönder
    try {
        const response = await fetch('/add_ref_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const responseData = await response.json();

        if (responseData.status === "success") {
            console.log("Refrigeration verileri başarıyla gönderildi!");
        } else {
            throw new Error("Bir hata oluştu: " + responseData.message);
        }
    } catch (error) {
        console.error('API Hatası:', error);
        alert('Refrigeration verileri gönderilirken hata oluştu.');
        throw error; // Hata fırlatarak işlemi durdur
    }
}

async function saveRefSelection(quoteNumber) {
    const customerType = document.getElementById('customerType')?.value || '';
    const refDsc = parseFloat(document.getElementById('ref_dsc')?.value) || 0;

    const rows = Array.from(document.querySelectorAll('#tab_refrigeration tbody tr'));
    const selections = rows.map(row => {
        const groupSelect = row.querySelector('.group-select')?.value || '';
        const itemSelect = row.querySelector('.item-select')?.value || '';
        const quantityInput = row.querySelector('input[name^="quantity_"]')?.value || 0;
        const warrantySelect = row.querySelector('.warranty-select')?.value || '';
        const unpackSelect = row.querySelector('.unpack-select')?.value || '';
        const removeSelect = row.querySelector('.remove-select')?.value || '';
        const priceLabel = row.querySelector('label[id^="price_"]')?.textContent || 0.0;
        const discountedPriceLabel = row.querySelector('label[id^="dprice_"]')?.textContent || 0.0;

        // Tüm satırları kaydet, boş olanlar dahil
        return {
            group_name: groupSelect,
            item_name: itemSelect,
            warranty: warrantySelect,
            unpack: unpackSelect,
            remove: removeSelect,
            quantity: parseInt(quantityInput, 10),
            price: parseFloat(priceLabel),
            discounted_price: parseFloat(discountedPriceLabel)
        };
    });

    try {
        const response = await fetch('/save_ref_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                customer_type: customerType,
                ref_dsc: refDsc,
                selections: selections,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Refrigeration seçimleri başarıyla kaydedildi.');
        } else {
            console.error('Refrigeration seçimleri kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Refrigeration seçimleri kaydedilirken hata oluştu:', error);
    }
}

async function loadRefSelection(quoteNumber) {
    // Tüm seçimleri sıfırla
    const rows = document.querySelectorAll('#tab_refrigeration tbody tr');
    rows.forEach(row => {
        const dpriceLabel = row.querySelector('label[id^="dprice_"]');
        const groupSelect = row.querySelector('.group-select');
        const itemSelect = row.querySelector('.item-select');
        const warrantySelect = row.querySelector('.warranty-select');
        const unpackSelect = row.querySelector('.unpack-select');
        const removeSelect = row.querySelector('.remove-select');
        const quantityInput = row.querySelector('input[name^="quantity_"]');
        const priceLabel = row.querySelector('label[id^="price_"]');
        const sku = row.querySelector('label[id^="sku_"]'); // SKU değeri

        if (groupSelect) groupSelect.value = '';
        if (itemSelect) itemSelect.innerHTML = '<option value=""></option>';
        if (warrantySelect) warrantySelect.innerHTML = '<option value=""></option>';
        if (unpackSelect) unpackSelect.innerHTML = '<option value=""></option>';
        if (removeSelect) removeSelect.innerHTML = '<option value=""></option>';
        if (quantityInput) quantityInput.value = '';
        if (priceLabel) priceLabel.textContent = '';
        if (dpriceLabel) dpriceLabel.textContent = '';
        if (sku) sku.textContent = ''; // SKU değerini temizle
    });

    // ...existing code...
    try {
        const response = await fetch(`/load_ref_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const selections = data.selections;

            // Customer type ve ref_dsc geri yükleniyor
            const customerTypeElement = document.getElementById('customerType');
            const refDscElement = document.getElementById('ref_dsc');
            if (selections.length > 0) {
                customerTypeElement.value = selections[0].customer_type || '';
                refDscElement.value = selections[0].ref_dsc || 0;
                customerTypeElement.dispatchEvent(new Event('change'));
                refDscElement.dispatchEvent(new Event('input'));
            }

            // Sadece quantity > 0 olan satırlar için işlem yapılıyor
            for (const selection of selections) {
                if (selection.quantity > 0) {
                    const row = document.querySelector(`#tab_refrigeration tbody tr:nth-child(${selection.row_index + 1})`);
                    if (!row) continue;

                    const groupSelect = row.querySelector('.group-select');
                    const itemSelect = row.querySelector('.item-select');
                    const warrantySelect = row.querySelector('.warranty-select');
                    const unpackSelect = row.querySelector('.unpack-select');
                    const removeSelect = row.querySelector('.remove-select');
                    const quantityInput = row.querySelector('input[name^="quantity_"]');
                    const priceLabel = row.querySelector('label[id^="price_"]');
                    const dpriceLabel = row.querySelector('label[id^="dprice_"]');

                    // Group name geri yükleniyor
                    if (groupSelect) {
                        await new Promise(resolve => setTimeout(resolve, 150));
                        groupSelect.value = selection.group_name;
                        groupSelect.dispatchEvent(new Event('change'));
                    }

                    // Group name seçildikten sonra item name geri yükleniyor
                    if (itemSelect) {
                        await new Promise(resolve => setTimeout(resolve, 150)); // Bağımlı seçimlerin yüklenmesi için bekleme
                        itemSelect.value = selection.item_name;
                        itemSelect.dispatchEvent(new Event('change'));
                    }

                    await new Promise(resolve => setTimeout(resolve, 150));

                    // Item name seçildikten sonra warranty, unpack, remove geri yükleniyor
                    if (warrantySelect) warrantySelect.value = selection.warranty;
                    if (unpackSelect) unpackSelect.value = selection.unpack;
                    if (removeSelect) removeSelect.value = selection.remove;

                    // Quantity, price ve dprice geri yükleniyor
                    if (quantityInput) quantityInput.value = selection.quantity;
                    if (priceLabel) priceLabel.textContent = selection.price.toFixed(2);
                    if (dpriceLabel) dpriceLabel.textContent = selection.discounted_price.toFixed(2);
                }
            }

            const { customer_type, ref_dsc } = data;

            // customer_type ve ref_dsc değerlerini ilgili alanlara yerleştir
            document.getElementById('customerType').value = customer_type;
            document.getElementById('ref_dsc').value = ref_dsc;

            console.log('Refrigeration seçimleri başarıyla yüklendi.');
        } else {
            console.error('Refrigeration seçimleri yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Refrigeration seçimleri yüklenirken hata oluştu:', error);
    }
}

async function addCeilingData() {
    const rows = document.querySelectorAll('#ceilingTableBody tr'); // Ceiling tablosundaki satırları seç
    const largestFile = document.getElementById('largestFile').textContent.trim(); // largestFile değerini al

    const ceilingData = []; // Gönderilecek tüm verileri tutacak dizi
    let validRowFound = false; // Geçerli bir satır bulunup bulunmadığını kontrol etmek için

    rows.forEach((row) => {
        const code = row.children[0]?.textContent.trim(); // Code
        const materials = row.children[1]?.textContent.trim(); // Materials
        const qty = parseFloat(row.children[3]?.textContent.trim()) || 0; // Qty
        const local = parseFloat(row.children[4]?.textContent.trim()) || 0; // Local
        const dPrice = parseFloat(row.children[5]?.textContent.trim()) || 0; // D.Price

        if (code && materials) {
            ceilingData.push({
                Code: code,
                Materials: materials,
                qty: qty,
                local: local,
                dPrice: dPrice
            });
            validRowFound = true; // Geçerli bir satır bulundu
        }
    });

    // Eğer geçerli bir satır bulunmadıysa işlemi durdur
    if (!validRowFound) {
        console.log("Ceiling tablosunda işlenecek geçerli veri yok.");
        window.adclknt = 0; // Tüm fonksiyonlar için global bir değişken oluşturuyoruz.
        return true;
    } else {
        window.adclknt = 1;
    }

    // API'ye POST isteği gönder
    try {
        const response = await fetch('/add_ceiling_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                largest_file: largestFile,
                ceiling_data: ceilingData
            }),
        });

        const responseData = await response.json();

        if (responseData.status === "success") {
            console.log("Ceiling verileri başarıyla gönderildi!");
        } else {
            throw new Error("Bir hata oluştu: " + responseData.message);
        }
    } catch (error) {
        console.error('API Hatası:', error);
        alert('Ceiling verileri gönderilirken hata oluştu.');
    }
}

async function saveCeilSelection(quoteNumber) {
    const ceilingM2 = parseFloat(document.getElementById('ceilingM2')?.value) || 0;
    const trimLM = parseFloat(document.getElementById('trimLM')?.value) || 0;
    const ceilingDiscount = parseFloat(document.getElementById('ceilingDiscount')?.value) || 0;

    try {
        const response = await fetch('/save_ceil_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                ceiling_m2: ceilingM2,
                trim_lm: trimLM,
                ceiling_discount: ceilingDiscount,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Ceiling seçimleri başarıyla kaydedildi.');
        } else {
            console.error('Ceiling seçimleri kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Ceiling seçimleri kaydedilirken hata oluştu:', error);
    }
}

async function loadCeilSelection(quoteNumber) {
    // Ceiling sayfasını tamamen temizle
    document.getElementById('ceilingM2').value = '';
    document.getElementById('trimLM').value = '';
    document.getElementById('ceilingDiscount').value = '';
    const tableBody = document.getElementById('ceilingTableBody');
    if (tableBody) {
        tableBody.innerHTML = ''; // Tabloyu temizle
    }

    // ...existing code...
    try {
        const response = await fetch(`/load_ceil_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const { ceiling_m2, trim_lm, ceiling_discount } = data;

            // Eğer tüm değerler boşsa fonksiyonu sonlandır
            if (!ceiling_m2 && !trim_lm && !ceiling_discount) {
                console.log('Ceiling seçimleri boş, işlem yapılmadı.');
                return;
            }

            document.getElementById('ceilingM2').value = ceiling_m2 || '';
            document.getElementById('trimLM').value = trim_lm || '';
            document.getElementById('ceilingDiscount').value = ceiling_discount || '';

            // Değerler yüklendikten sonra ceiling verilerini güncelle
            fetchCeilingData();
            console.log('Ceiling seçimleri başarıyla yüklendi.');
        } else {
            console.error('Ceiling seçimleri yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Ceiling seçimleri yüklenirken hata oluştu:', error);
    }
}


    function sellModalcnt() {
        const tableBody = document.querySelector('#quoteListTable tbody');
        if (tableBody && tableBody.children.length > 0) {
            // Tablo doluysa modalı aç
            openSellModal();
        } else {
            // Tablo boşsa modalı kapat
            alert("No data in the table!");
            closeSellModal();
        }
    }


    // Sell Modal açma
    function openSellModal() {
        document.getElementById('sellModal').style.display = 'flex';
    }

    // Sell Modal kapama
    function closeSellModal() {
        document.getElementById('sellModal').style.display = 'none';

        // Checkbox'ların tiklerini temizle
        //checkboxI.checked = false; // 'I' kutucuğunun seçimini kaldır
        //checkboxS.checked = false;
    }

    function ClearChckBox() {
        // Checkbox'ların tiklerini temizle
        checkboxI.checked = false; // 'I' kutucuğunun seçimini kaldır
        checkboxS.checked = false;
    }

    // Satışı onaylama
    function approveSale() {
        //alert("Sale approved!"); // Burada satış işlemi için gerekli işlemleri yapabilirsiniz.
        closeSellModal();
    }

    async function salecustdet() {
    try {
        const tableRows = Array.from(document.querySelectorAll('#quoteListTable tbody tr'));
        const quoteNumber = document.getElementById('tableHeader').textContent.split(':')[1].trim(); // Proforma tablosunun database ismi alınıyor

        // Checkbox'lardan seçili olanın değerini al
        //const checkboxS = document.getElementById("checkboxS");
        //const checkboxI = document.getElementById("checkboxI");
        let s_i = null;

        if (checkboxS.checked) {
            s_i = 'S';
        } else if (checkboxI.checked) {
            s_i = 'I';
        }

        if (!s_i) {
            alert("Lütfen bir seçenek seçin (S veya I).");
            return;
        }

        // Veritabanından customer_id ve customer_name değerlerini çek
        const customerResponse = await fetch(`/get_customer_by_quote_number?quote_number=${quoteNumber}`);
        const customerData = await customerResponse.json();

        if (customerData.status !== 'success') {
            alert('Müşteri bilgileri alınamadı: ' + customerData.message);
            return;
        }

        const customerId = customerData.customer_id;
        const customerName = customerData.customer_name;
        const postcode = document.getElementById('selectedCustomer').textContent.match(/Postcode:\s*(\S+)/)?.[1] || '';
        
        // G.Total satırını kontrol et
        const gTotalRow = tableRows[tableRows.length - 1];
        if (!gTotalRow) {
            alert('G.Total satırı bulunamadı!');
            return;
        }

        const gTotal = parseFloat(gTotalRow.querySelector('td:last-child')?.textContent.replace(/,/g, '')) || 0;

        // Description oluştur
        const descriptionSet = new Set();
        tableRows.forEach(row => {
            const sira = row.querySelector('td:nth-child(6)')?.textContent.trim();
            if (sira) {
                const mainNumber = sira.split('.')[0];
                descriptionSet.add(mainNumber);
            }
        });
        const description = Array.from(descriptionSet).join(',');

        const payload = {
            date: new Date().toISOString().split('T')[0],
            quote_number: quoteNumber,
            customer_id: customerId,
            customer_name: customerName,
            postcode: postcode,
            description: description,
            s_i: s_i, // Checkbox'tan gelen değer
            g_total: gTotal
        };

        // Gönderilen verileri alert ile göster
        //alert('Gönderilen Veriler:\n' + JSON.stringify(payload, null, 2));

        const response = await fetch('/sale_cust_det', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });

        const result = await response.json();
        if (result.status === 'success') {
            //alert('Satış bilgileri başarıyla kaydedildi.');
            closeSellModal();
        } else {
            console.error('Hata:', result.message);
            alert('Hata: ' + result.message);
        }
    } catch (error) {
        console.error('Hata (salecustdet):', error);
        alert('Satış bilgileri kaydedilirken bir hata oluştu.');
        await fetch('/reset_islmdvm', { method: 'POST' });
    }
}

async function decreaseStock() {
    try {
        const tableRows = Array.from(document.querySelectorAll('#quoteListTable tbody tr'));

        for (const row of tableRows) {
            const sira = row.querySelector('td:nth-child(6)')?.textContent.trim(); // Sıra numarası
            const itemId = row.querySelector('td:nth-child(2)')?.textContent.trim(); // Item ID
            const model = row.querySelector('td:nth-child(3)')?.textContent.trim(); // Item ID
            const qty = parseInt(row.querySelector('td:nth-child(4)')?.textContent.trim()) || 0; // Quantity

            if (!sira || !itemId || qty <= 0) continue; // Geçersiz veri varsa atla

            if (sira.startsWith('1')) {
                // Sıra numarası 1 ile başlıyorsa prc_tbl'deki quantity değerini düş
                await fetch('/update_prc_tbl_quantity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ item_id: itemId, qty: qty }),
                });
            } else if (sira.startsWith('2')) {
                // Sıra numarası 2 ile başlıyorsa refrigeration.db'deki Qty değerini düş
                await fetch('/update_refrigeration_quantity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ model_: model, qty: qty }),
                });
            }
        }

        //alert('Stok güncelleme işlemi tamamlandı.');
    } catch (error) {
        console.error('Hata (decreaseStock):', error);
        alert('Stok güncelleme sırasında bir hata oluştu.');
        await fetch('/reset_islmdvm', { method: 'POST' });
    }
}


</script>

<div id="tab_reports" class="tab-content">
    <!--<h2>Sales</h2>-->
    <div style="margin-bottom: 20px;">
        <label for="salesSelection">Select Category:</label>
        <select id="salesSelection" onchange="handleSalesSelection()">
            <option value="C.Accounts">C.Accounts</option>
            <option value="Shelving">Shelving</option>
            <option value="Refrigeration">Refrigeration</option>
        </select>
        <button id="customerAccountsButton" onclick="openAccountsModal()" style="margin-left: 20px;">Customer Accounts</button>
    </div>
    <div id="CAccountsTable" class="sales-table">
        <table border="1" style="width: 100%; text-align: center; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Customer Name</th>
                    <th>Customer Id</th>
                    <th>Quote Number</th>
                    <th>Description</th>
                    <th>S_I</th>
                    <th>Amounth</th>
                </tr>
            </thead>
            <tbody id="salesTableBody">
                <!-- Dinamik veri buraya yüklenecek -->
            </tbody>
        </table>
    </div>
    <div id="ShelvingTable" class="sales-table" style="display: none;">
        <table border="1" style="width: 100%; text-align: center; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name1</th>
                    <th>Name2</th>
                    <th>Quantity</th>
                    <th>Code</th>
                    <th>Import</th>
                    <th>Local</th>
                    <th>Kg</th>
                </tr>
            </thead>
            <tbody id="ShelvingTableBody">
                <!-- Dinamik veri buraya yüklenecek -->
            </tbody>
        </table>
    </div>
    <div id="RefrigerationTable" class="sales-table" style="display: none;">
        <table border="1" style="width: 100%; text-align: center; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>G.Name</th>
                    <th>Model</th>
                    <th>R.Price</th>
                    <th>T.Price</th>
                    <th>Kar</th>
                    <th>Maliyet</th>
                    <th>Kg</th>
                    <th>Qty</th>
                    <th>Warranty</th>
                    <th>Unpack</th>
                    <th>Remove</th>
                </tr>
            </thead>
            <tbody id="RefrigerationTableBody">
                <!-- Dinamik veri buraya yüklenecek -->
            </tbody>
        </table>
    </div>
    
</div>

<script>
    function handleSalesSelection() {
        const selection = document.getElementById("salesSelection").value;
        const tables = document.querySelectorAll(".sales-table");
        const customerButton = document.getElementById("customerAccountsButton");

        tables.forEach(table => {
            table.style.display = "none"; // Tüm tabloları gizle
        });

        if (selection === "C.Accounts") {
            document.getElementById("CAccountsTable").style.display = "block";
            customerButton.style.display = "inline-block"; // Customer Accounts butonunu göster
        } else if (selection === "Shelving") {
            document.getElementById("ShelvingTable").style.display = "block";
            customerButton.style.display = "none"; // Customer Accounts butonunu gizle
            fetchShelvingData(); // Shelving verilerini çek
        } else if (selection === "Refrigeration") {
            document.getElementById("RefrigerationTable").style.display = "block";
            customerButton.style.display = "none"; // Customer Accounts butonunu gizle
            fetchRefrigerationData(); // Refrigeration verilerini çek
        }
    }

    function fetchShelvingData() {
        fetch('/get_prc_tbl_data')
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const tableBody = document.getElementById("ShelvingTableBody");
                    tableBody.innerHTML = ""; // Eski tablo içeriğini temizle

                    data.rows.forEach(row => {
                        const tr = document.createElement("tr");
                        row.forEach(cell => {
                            const td = document.createElement("td");
                            td.textContent = cell;
                            tr.appendChild(td);
                        });
                        tableBody.appendChild(tr);
                    });
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error("Shelving verileri alınırken hata oluştu:", error);
                alert("An error occurred while fetching shelving data.");
            });
    }

    function fetchRefrigerationData() {
        fetch('/get_refrigeration_data')
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const tableBody = document.getElementById("RefrigerationTableBody");
                    tableBody.innerHTML = ""; // Eski tablo içeriğini temizle

                    data.rows.forEach(row => {
                        const tr = document.createElement("tr");
                        row.forEach(cell => {
                            const td = document.createElement("td");
                            td.textContent = cell;
                            tr.appendChild(td);
                        });
                        tableBody.appendChild(tr);
                    });
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(async (error) => {
            console.error("Refrigeration verileri alınırken hata oluştu:", error);
            alert("An error occurred while fetching refrigeration data.");
            await fetch('/reset_islmdvm', { method: 'POST' });
            });
    }
</script>

<!-- Customer Accounts Modal -->
<div class="modal" id="accountsModal">
    <div class="modal-content" style="max-width: 800px;">
        <h2>Customer Accounts</h2>
        <input type="text" id="accountsSearchBox" placeholder="Search Customers..." onkeyup="searchAccounts()">
        <div class="scrollable-table">
            <table id="accountsTable">
                <thead>
                    <tr>
                        <th>Customer ID</th>
                        <th>Customer Name</th>
                        <th>Tel</th>
                        <th>Address line1</th>
                        <th>Address line2</th>
                        <th>Postcode</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dinamik veri buraya yüklenecek -->
                </tbody>
            </table>
        </div>
        <button onclick="closeAccountsModal()">Close</button>
    </div>
</div>

<script>
    // Accounts Modal açma
    function openAccountsModal() {
        document.getElementById("accountsModal").style.display = "flex";
        fetchAccountsData(); // Modal açıldığında müşteri verilerini çek
    }

    // Accounts Modal kapama
    function closeAccountsModal() {
        document.getElementById("accountsModal").style.display = "none";
    }

    // Müşteri verilerini çekme
    function fetchAccountsData() {
        fetch("/fetch_customers")
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById("accountsTable").querySelector("tbody");
                tableBody.innerHTML = ""; // Eski satırları temizle
                data.forEach(customer => {
                    const tr = document.createElement("tr");
                    customer.forEach(cell => {
                        const td = document.createElement("td");
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tr.addEventListener("click", () => handleCustomerRowClick(customer)); // Satıra tıklama olayı
                    tableBody.appendChild(tr);
                });
            })
            .catch(error => console.error("Müşteri verileri alınırken hata oluştu:", error));
    }

    // Satıra tıklama olayı
    function handleCustomerRowClick(customer) {
        const customerId = customer[0]; // Müşteri ID
        const postcode = customer[5]; // Posta kodu
        const dbName = `${customerId}${postcode}.db`; // ID ve posta kodunu birleştirip .db ekle
        //alert(`Generated DB Name: ${dbName}`); // Alert ile göster

        // Sales sayfasında tabloyu oluştur
        fetchSalesData(dbName);
        closeAccountsModal(); // Modalı kapat
    }

    // Sales sayfasında tabloyu oluşturmak için veri çekme
    function fetchSalesData(dbName) {
        fetch(`/get_customer_db?db_name=${encodeURIComponent(dbName)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Database not found: ${dbName}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === "success") {
                    const tableBody = document.getElementById("salesTableBody");
                    tableBody.innerHTML = ""; // Eski satırları temizle

                    data.rows.forEach(row => {
                        const tr = document.createElement("tr");
                        row.forEach(cell => {
                            const td = document.createElement("td");
                            td.textContent = cell;
                            tr.appendChild(td);
                        });
                        tableBody.appendChild(tr);
                    });
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error("Sales verileri alınırken hata oluştu:", error);
                alert(error.message); // Hata mesajını kullanıcıya göster
            });
    }

    // Arama fonksiyonu
    function searchAccounts() {
        const input = document.getElementById("accountsSearchBox").value.toUpperCase();
        const table = document.getElementById("accountsTable");
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) { // İlk satır başlık olduğu için 1'den başla
            const tds = tr[i].getElementsByTagName("td");
            let visible = false;
            for (let td of tds) {
                if (td.textContent.toUpperCase().includes(input)) {
                    visible = true;
                    break;
                }
            }
            tr[i].style.display = visible ? "" : "none";
        }
    }
</script>


<script>
    function toggleCheckbox(selected) {
        const checkboxS = document.getElementById("checkboxS");
        const checkboxI = document.getElementById("checkboxI");

        if (selected === 'S') {
            checkboxI.checked = false; // 'I' kutucuğunun seçimini kaldır
        } else if (selected === 'I') {
            checkboxS.checked = false; // 'S' kutucuğunun seçimini kaldır
        }
    }

/////fazlalik satismodulu burdaydi
</script>
<!-- ...existing code... -->

<script>
    async function updateQuoteSI() {
        try {
            const quoteNumber = document.getElementById('tableHeader').textContent.split(':')[1].trim(); // Proforma tablosunun database ismi alınıyor

            // Checkbox'lardan seçili olanın değerini al
            const checkboxS = document.getElementById("checkboxS");
            const checkboxI = document.getElementById("checkboxI");
            let s_i = null;

            if (checkboxS.checked) {
                s_i = 'S';
            } else if (checkboxI.checked) {
                s_i = 'I';
            }

            if (!s_i) {
                alert("Lütfen bir seçenek seçin (S veya I).");
                return;
            }

            // Backend'e güncelleme isteği gönder
            const response = await fetch('/update_quote_si', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quote_number: quoteNumber,
                    s_i: s_i
                }),
            });

            const result = await response.json();
            if (result.status === 'success') {
                console.log('Quote S/I değeri başarıyla güncellendi.');
            } else {
                console.error('Hata:', result.message);
                alert('Hata: ' + result.message);
            }
        } catch (error) {
            console.error('Hata (updateQuoteSI):', error);
            alert('Quote S/I değeri güncellenirken bir hata oluştu.');
        }
    }


</script>

<script>
    async function fetchServerDate() {
        try {
            const response = await fetch('/get_server_time'); // Sunucudan tarih ve saat bilgisini al
            if (!response.ok) {
                throw new Error('Sunucudan tarih ve saat alınamadı.');
            }

            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById('quoteDate').textContent = `Quote Date: ${data.server_time}`;
            } else {
                console.error('Tarih ve saat alınırken hata oluştu:', data.message);
            }
        } catch (error) {
            console.error('Tarih ve saat alınırken hata oluştu:', error);
        }
    }

    async function updateQuoteDate(quoteNumber) {
        try {
            const response = await fetch(`/get_quote_date?quote_number=${quoteNumber}`);
            const data = await response.json();

            if (data.status === 'success') {
                document.getElementById('quoteDate').textContent = `Quote Date: ${data.quote_date}`;
            } else {
                console.error('Quote tarihi alınırken hata oluştu:', data.message);
            }
        } catch (error) {
            console.error('Quote tarihi alınırken hata oluştu:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', fetchServerDate); // Sayfa yüklendiğinde server tarihini al
</script>
<script>
    async function checkSign() {
        try {
            const quoteNumber = document.getElementById('tableHeader').textContent.split(':')[1].trim(); // Proforma tablosunun database ismi alınıyor
            
            //alert(`Quote Number: ${quoteNumber}`); // Bu satırı ekledik
    
            const response = await fetch(`/check_sign?quote_number=${quoteNumber}`);
            const data = await response.json();
    
            if (data.status === 'exists') {
                alert("The sale has already been made");
                checkboxI.checked = false; // 'I' kutucuğunun seçimini kaldır
                checkboxS.checked = false;
                return false; // İşlemleri iptal etmek için false döndür
            }
    
            return true; // İşlem başarılıysa true döndür
        } catch (error) {
            console.error('Hata (checkSign):', error);
            return false; // Hata durumunda false döndür
        }
    }
    
    // "Yes" butonuna tıklama olayı
    document.querySelector('#sellModal button:first-child').addEventListener('click', async () => {
        try {
            const isValid = await checkSign();
            if (!isValid) {
                console.log("İşlem iptal edildi.");
                return; // İşlemleri durdur
            }
            await salecustdet();
            await decreaseStock();
            await updateQuoteSI(); // Yeni fonksiyon çağrıldı
            if (checkboxI.checked === true) {
                generateInvoice(true); // Sell için PDF oluştur
            }
    
            checkboxI.checked = false; // 'I' kutucuğunun seçimini kaldır
            checkboxS.checked = false;
        } catch (error) {
            console.error('İşlem iptal edildi:', error);
        }
    });
    </script>
    
    <script>
        async function generateInvoice(isSell) {
            
            const quoteNumber = document.getElementById('tableHeader').textContent.split(':')[1].trim();
            if (!quoteNumber) {
                alert("Quote list boş!");
                return;
            }
    
            try {
                const response = await fetch('/generate_invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ quote_number: quoteNumber, is_sell: isSell }),
                });
    
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Fatura başarıyla oluşturuldu ve kaydedildi.');
                } else {
                    alert('Fatura oluşturulurken hata oluştu: ' + data.message);
                }
            } catch (error) {
                console.error('Hata:', error);
                alert('Fatura oluşturulurken bir hata oluştu.');
            }
        }
    
    
    
        function openSellModal() {
            document.getElementById('sellModal').style.display = 'flex';
        }
    
        function closeSellModal() {
            document.getElementById('sellModal').style.display = 'none';
        }
    
        function ClearChckBox() {
            document.getElementById('checkboxS').checked = false;
            document.getElementById('checkboxI').checked = false;
        }


        // proforma basim
function generateProfroma() {
    const table = document.getElementById('quoteListTable');
    if (!table) {
        alert("Proforma tablosu bulunamadı!");
        return;
    }

    const clonedTable = table.cloneNode(true);
    const qttyIndex = Array.from(clonedTable.querySelectorAll('thead th')).findIndex(th => th.textContent.trim().toUpperCase() === "QTTY");
    if (qttyIndex !== -1) {
        clonedTable.querySelectorAll('tbody tr').forEach(tr => {
            const td = tr.children[qttyIndex];
            if (td) {
                const input = td.querySelector('input');
                if (input) {
                    td.textContent = input.value;
                }
            }
        });
    }

    const selectedCustomerDiv = document.getElementById('selectedCustomer');
    let proformaAddressText = "";
    let deliveryAddressText = "";
    if (selectedCustomerDiv) {
        const divs = selectedCustomerDiv.querySelectorAll('div');
        if (divs.length > 1) {
            proformaAddressText = divs[0].innerText || divs[0].textContent;
            deliveryAddressText = divs[1].innerText || divs[1].textContent;
        } else {
            proformaAddressText = selectedCustomerDiv.innerText || selectedCustomerDiv.textContent;
            deliveryAddressText = "";
        }
    }

    function getColorLabel(id, label) {
        const el = document.getElementById(id);
        let value = "";
        if (el) {
            if (el.options && el.selectedIndex > -1) {
                value = el.options[el.selectedIndex].text || el.value;
            } else {
                value = el.value || "";
            }
        }
        return `<div><span style="font-weight:bold;">${label}:</span> ${value}</div>`;
    }

    const colorLabelsHtml = `
        <div class="color-info">
            ${getColorLabel('shelfColor', 'Shelf Colour')}
            ${getColorLabel('ticketColor', 'Ticket Color')}
            ${getColorLabel('ttype', 'Ticket Type')}
            ${getColorLabel('slatwall', 'Slatwall')}
            ${getColorLabel('insert', 'Insert')}
            ${getColorLabel('endcap', 'End Cap')}
        </div>
    `;

    // --- QUOTE DATE ve KG ---
    const quoteDateElem = document.getElementById('quoteDate');
    let dateStr = "";
    if (quoteDateElem && quoteDateElem.textContent.includes(':')) {
        // Tüm metni al, başındaki "Quote Date:" kısmını da dahil et
        dateStr = quoteDateElem.textContent.trim();
    } else {
        const today = new Date();
        dateStr = "Quote Date: " + today.toLocaleDateString() + " " + today.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // KG bilgisini DOM'dan al
    let kgStr = "";
    const kgInfoElem = document.getElementById('kgInfo');
    if (kgInfoElem && kgInfoElem.textContent) {
        kgStr = kgInfoElem.textContent.trim();
    }

    let proformaNumber = "";
    const tableHeader = document.getElementById('tableHeader');
    if (tableHeader && tableHeader.textContent.includes(':')) {
        proformaNumber = tableHeader.textContent.split(':')[1].trim();
    }

    let salePerson = "";
    const userInfo = document.querySelector('.user-info h1');
    if (userInfo) {
        salePerson = userInfo.textContent.replace(/^User Name:\s*/i, '').trim();
    }

    let vernum = "";
    const vernumFooter = document.getElementById('quoteListTableFooter');
    if (vernumFooter && vernumFooter.textContent.includes('vernum:')) {
        vernum = vernumFooter.textContent.replace('vernum:', '').trim();
    }

    const tableHtml = clonedTable.outerHTML;
    const title = "Proforma Invoice";

    const footerText = `
        <div class="proforma-footer-wrapper">
            <div class="proforma-footer-vernum-row">
                <span class="footer-vernum-label">vernum: ${vernum}</span>
            </div>
            <div class="proforma-footer">
                <div>This is not vat invoice
                    Note: Engineers will follow customer/shop keeper/representative's instructoins how and where to perform installation work. In no event will we be liable for any loss or damage including 
                    without limitation, indirect or consequential loss or damage, or any loss or damage whatsoeverarising from any installation or delivery. All goods remains the property of EASYSHELF
                    Direct Ltd all dues paid in full. 30% re-stocking fee will be charged for goods returned. Door for all entrances should be measured accordingly this is the customer's responsibility 
                    before delivery is made. Information about warranty is available on the invoice and on the web page. Delivery Information:  www.easyshelf.co.uk/delivery
                </div>
            </div>
        </div>
    `;

    const printHtml = `
<html>
<head>
    <title>${title}</title>
    <style>
        * { box-sizing: border-box; }
        html, body {
            margin: 0;
            padding: 0;
            background: #fff;
            height: 100%;
        }
        body {
            font-family: Arial, sans-serif;
        }
        .proforma-container {
            display: flex;
            flex-direction: column;
            min-height: 97vh;
            width: 800px;
            margin: 30px auto;
            padding: 24px 32px 32px 32px;
            background: #fff;
            border-radius: 8px;
        }
        .proforma-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 18px;
            gap: 24px;
        }
        .proforma-header .company-col {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 220px;
        }
        .proforma-header .company-info {
            font-size: 13px;
            line-height: 1.2;
            margin-bottom: 6px;
        }
        .proforma-header .proforma-number,
        .proforma-header .sale-person {
            font-size: 13px;
            font-weight: bold;
            color: #444;
            margin-bottom: 6px;
        }
        .date-block {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 8px;
        }
        .date-label {
            display: block;
            text-align: right;
            font-size: 13px;
            color: #333;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .kg-label {
            display: block;
            text-align: right;
            font-size: 13px;
            color: gray;
            font-weight: normal;
        }
        .color-and-address-row {
            display: flex;
            flex-direction: row;
            gap: 40px;
            margin-bottom: 24px;
            font-size: 12px;
            justify-content: flex-start;
            align-items: flex-start;
        }
        .color-info {
            min-width: 180px;
            max-width: 220px;
            font-size: 12px;
            line-height: 1.3;
            flex-shrink: 0;
        }
        .color-info div {
            margin-bottom: 2px;
        }
        .address-block {
            min-width: 220px;
            max-width: 340px;
            word-break: break-word;
            white-space: pre-line;
            font-size: 12px;
            flex-shrink: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            font-size: 11px;
            page-break-inside: auto;
        }
        th, td {
            border: 1px solid #333;
            padding: 6px 8px;
            font-weight: normal;
            height: 18px;
            word-break: break-word;
        }
        th {
            background: #f2f2f2;
            text-align: left;
            font-size: 13px;
        }
        td {
            text-align: left;
            font-size: 11px;
        }
        td:nth-child(4),
        td:nth-child(7),
        td:nth-child(8) {
            text-align: right;
        }
        td[colspan="5"],
        td[colspan="6"] {
            text-align: right !important;
        }
        tr:last-child td,
        tr:nth-last-child(2) td,
        tr:nth-last-child(3) td {
            background: #f9f9f9;
        }
        .proforma-footer-wrapper {
            margin-top: auto;
            page-break-inside: avoid;
            break-inside: avoid;
            padding-top: 24px;
        }
        .proforma-footer-vernum-row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 8px;
        }
        .footer-vernum-label {
            font-size: 11px;
            font-weight: bold;
            color: #444;
        }
        .proforma-footer {
            font-size: 9px;
            color: #333;
            border-top: 1px solid #ccc;
            padding-top: 5px;
            white-space: pre-line;
        }
        .proforma-footer > div:first-child {
            font-weight: normal;
            font-size: 9px;
        }
        .proforma-header .logo {
            height: 80px;
            width: 250px;
            object-fit: contain;
            margin-bottom: 4px;
        }
        @media print {
            html, body {
                height: auto;
            }
            .proforma-container {
                page-break-after: always;
            }
            tr {
                page-break-inside: auto;
                break-inside: auto;
            }
            thead {
                display: table-header-group;
            }
            tfoot {
                display: table-footer-group;
            }
            .proforma-footer-wrapper {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="proforma-container">
        <div class="proforma-header">
            <div class="company-col">
                <div class="company-info">
                    Easyshelf Direct Ltd.<br>
                    205-207 Leabridge Road<br>
                    E10 7PN<br>
                    Telefon: +44 7834519643
                </div>
                <div class="proforma-number">Proforma No: ${proformaNumber}</div>
                <div class="sale-person">Sale Person: ${salePerson}</div>
            </div>
            <div class="center-title">
                <span class="title">${title}</span>
            </div>
            <div class="logo-col">
                <img src="/static/images/logoQ.png" alt="Logo" class="logo">
                <div class="date-block">
                    <span class="date-label">${dateStr}</span>
                    ${kgStr ? `<span class="kg-label">${kgStr}</span>` : ""}
                </div>
            </div>
        </div>
        <div class="color-and-address-row">
            ${colorLabelsHtml}
            <div class="address-block">
                ${proformaAddressText.replace(/\n/g, "<br>")}
            </div>
            <div class="address-block">
                ${deliveryAddressText.replace(/\n/g, "<br>")}
            </div>
        </div>
        ${tableHtml}
        ${footerText}
    </div>
    <script>
        window.onload = function() { window.print(); }
    <\/script>
</body>
</html>
`;

    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    document.body.appendChild(iframe);

    iframe.onload = function () {
        try {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
        } catch (e) {
            console.error("Yazdırma hatası:", e);
        }
        setTimeout(() => {
            document.body.removeChild(iframe);
        }, 1000);
    };

    iframe.srcdoc = printHtml;
}


    </script>
<script>
    // ...existing code...

    async function createTableprofdelv(nextNumber) {
        try {
            const response = await fetch('/createTableprofdelv', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quote_number: nextNumber,
                    customer_id: selectedCustomerID
                }),
            });

            const data = await response.json();
            if (data.status === 'success') {
                console.log('createTableprofdelv başarıyla tamamlandı.');
            } else {
                console.error('createTableprofdelv sırasında hata oluştu:', data.message);
            }
        } catch (error) {
            console.error('createTableprofdelv isteği sırasında hata oluştu:', error);
        }
    }

    // ...existing code...
</script>
<script>
    // ...existing code...

    async function loadProformaDeliveryInfo(quoteNumber) {
        try {
            const response = await fetch(`/get_delivery_info?quote_number=${quoteNumber}`);
            const data = await response.json();

            if (data.status === 'success') {
                const proformaName = document.getElementById('proformaName');
                const proformaTel = document.getElementById('proformaTel');
                const proformaAddress1 = document.getElementById('proformaAddress1');
                const proformaAddress2 = document.getElementById('proformaAddress2');
                const proformaPostcode = document.getElementById('proformaPostcode');

                const deliverName = document.getElementById('deliverName');
                const deliverTel = document.getElementById('deliverTel');
                const deliverAddress1 = document.getElementById('deliverAddress1');
                const deliverAddress2 = document.getElementById('deliverAddress2');
                const deliverPostcode = document.getElementById('deliverPostcode');

                // Elementlerin varlığını kontrol et ve değerleri ata
                if (proformaName) proformaName.textContent = data.delivery_info.name || '';
                if (proformaTel) proformaTel.textContent = data.delivery_info.tel || '';
                if (proformaAddress1) proformaAddress1.textContent = data.delivery_info.address1 || '';
                if (proformaAddress2) proformaAddress2.textContent = data.delivery_info.address2 || '';
                if (proformaPostcode) proformaPostcode.textContent = data.delivery_info.postcode || '';

                if (deliverName) deliverName.textContent = data.delivery_info.Dname || '';
                if (deliverTel) deliverTel.textContent = data.delivery_info.Dtel || '';
                if (deliverAddress1) deliverAddress1.textContent = data.delivery_info.Daddress1 || '';
                if (deliverAddress2) deliverAddress2.textContent = data.delivery_info.Daddress2 || '';
                if (deliverPostcode) deliverPostcode.textContent = data.delivery_info.Dpostcode || '';
            } else {
                console.error('Delivery info yüklenirken hata oluştu:', data.message);
            }
        } catch (error) {
            console.error('Delivery info yüklenirken hata oluştu:', error);
        }
    }

    // // Proforma sekmesi yüklendiğinde delivery info'yu yükle
    // document.addEventListener('DOMContentLoaded', () => {
    //     const quoteNumber = document.getElementById('tableHeader').textContent.split(':')[1]?.trim();
    //     if (quoteNumber) {
    //         loadProformaDeliveryInfo(quoteNumber);
    //     }
    // });

    // ...existing code...

    async function DpTpl(quoteNumber) {
    try {
        const response = await fetch('/depo_topla', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quote_number: quoteNumber }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            const result = data.result; // Backend'den gelen sonucu al
            const tableFooter = document.getElementById('quoteListTableFooter'); // Tablonun alt kısmı için bir element
            if (!tableFooter) {
                // Eğer footer yoksa oluştur
                const footer = document.createElement('div');
                footer.id = 'quoteListTableFooter';
                footer.style.textAlign = 'left';
                footer.style.marginTop = '20px';
                footer.style.fontWeight = 'bold';
                footer.textContent = `vernum: ${result}`;
                document.getElementById('quoteListTable').parentElement.appendChild(footer);
            } else {
                // Eğer footer varsa güncelle
                tableFooter.textContent = `vernum: ${result}`;
            }
        } else {
            console.error('Depo toplama işlemi başarısız:', data.message);
        }
    } catch (error) {
        console.error('Hata (DpTpl):', error);
    }
}

async function KgTpl(quoteNumber) {
    try {
        const response = await fetch('/kg_topla', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quote_number: quoteNumber }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            let kgInfo = document.getElementById('kgInfo');
            const quoteDateContainer = document.getElementById('quoteDateContainer');
            if (!kgInfo) {
            kgInfo = document.createElement('div');
            kgInfo.id = 'kgInfo';
            kgInfo.style.fontWeight = 'normal';
            kgInfo.style.fontSize = '14px';
            kgInfo.style.color = 'gray';
            kgInfo.style.marginTop = '4px';
            kgInfo.style.alignSelf = 'flex-end'; // Sağa hizala
            kgInfo.style.textAlign = 'right';
            kgInfo.style.marginRight = '10px'; // Sağ boşluk
            //kgInfo.style.marginLeft = '20';
            quoteDateContainer.appendChild(kgInfo);
        }
            kgInfo.textContent = `Tot Shelving Kg: ${data.kg_total}`;
        } else {
            console.error('KG toplama işlemi başarısız:', data.message);
        }
    } catch (error) {
        console.error('Hata (KgTpl):', error);
    }
}

</script>
<!-- ...existing code... -->

<!-- Delivery Address Modal -->
<div class="modal" id="deliveryModal">
    <div class="modal-content" style="max-width: 600px;">
        <h2>Change Delivery Address</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="deliveryName" style="width: 150px;">Customer Name *</label>
                <input type="text" id="deliveryNameInput" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="deliveryTel" style="width: 150px;">Tel *</label>
                <input type="text" id="deliveryTelInput" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="deliveryAddress1" style="width: 150px;">Address Line1 *</label>
                <input type="text" id="deliveryAddress1Input" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="deliveryAddress2" style="width: 150px;">Address Line2</label>
                <input type="text" id="deliveryAddress2Input" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="deliveryPostcode" style="width: 150px;">Postcode *</label>
                <input type="text" id="deliveryPostcodeInput" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button onclick="formatAndSaveDeliveryAddress()" style="padding: 10px 20px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer;">Save</button>
            <button onclick="closeDeliveryModal()" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>

<script>
function toProperCase(str) {
    return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
}

function formatAndSaveDeliveryAddress() {
    // Format inputs using the PROPER function
    document.getElementById('deliveryNameInput').value = toProperCase(document.getElementById('deliveryNameInput').value.trim());
    document.getElementById('deliveryTelInput').value = document.getElementById('deliveryTelInput').value.trim(); // No formatting for phone numbers
    document.getElementById('deliveryAddress1Input').value = toProperCase(document.getElementById('deliveryAddress1Input').value.trim());
    document.getElementById('deliveryAddress2Input').value = toProperCase(document.getElementById('deliveryAddress2Input').value.trim());
    document.getElementById('deliveryPostcodeInput').value = document.getElementById('deliveryPostcodeInput').value.trim().toUpperCase(); // Postcode in uppercase

    // Call the save function
    saveDeliveryAddress();
}

function openDeliveryModal() {
    document.getElementById('deliveryModal').style.display = 'flex';
    // Fill modal inputs with current delivery details
    document.getElementById('deliveryNameInput').value = document.getElementById('deliverName').textContent.trim();
    document.getElementById('deliveryTelInput').value = document.getElementById('deliverTel').textContent.trim();
    document.getElementById('deliveryAddress1Input').value = document.getElementById('deliverAddress1').textContent.trim();
    document.getElementById('deliveryAddress2Input').value = document.getElementById('deliverAddress2').textContent.trim();
    document.getElementById('deliveryPostcodeInput').value = document.getElementById('deliverPostcode').textContent.trim();
}

function closeDeliveryModal() {
    document.getElementById('deliveryModal').style.display = 'none';
}

async function saveDeliveryAddress() {
    const quoteNumber = selectedQuoteNumber ?? newQuoteNum; // Get the current quote number
    const deliveryData = {
        quote_number: quoteNumber,
        name: document.getElementById('deliveryNameInput').value.trim(),
        tel: document.getElementById('deliveryTelInput').value.trim(),
        address1: document.getElementById('deliveryAddress1Input').value.trim(),
        address2: document.getElementById('deliveryAddress2Input').value.trim(),
        postcode: document.getElementById('deliveryPostcodeInput').value.trim()
    };

    try {
        const response = await fetch('/update_delivery_address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(deliveryData),
        });

        const data = await response.json();
        if (data.status === 'success') {
            // Update the "Deliver To" section
            document.getElementById('deliverName').textContent = deliveryData.name;
            document.getElementById('deliverTel').textContent = deliveryData.tel;
            document.getElementById('deliverAddress1').textContent = deliveryData.address1;
            document.getElementById('deliverAddress2').textContent = deliveryData.address2;
            document.getElementById('deliverPostcode').textContent = deliveryData.postcode;

            closeDeliveryModal();
            alert('Delivery address updated successfully!');
        } else {
            alert('Error updating delivery address: ' + data.message);
        }
    } catch (error) {
        console.error('Error updating delivery address:', error);
        alert('An error occurred while updating the delivery address.');
    }
}
</script>
<script>
function clrCont() {
    const uniteRows = document.querySelectorAll('.unite-table table tbody tr'); // Unite sayfasındaki satırlar
    const shelfColor = document.getElementById('shelfColor')?.value || ''; // Proforma sayfasındaki Shelf Color
    const ticketColor = document.getElementById('ticketColor')?.value || ''; // Proforma sayfasındaki Ticket Color
    const ttype = document.getElementById('ttype')?.value || ''; // Proforma sayfasındaki Ticket Type
    const slatwall = document.getElementById('slatwall')?.value || ''; // Proforma sayfasındaki Slatwall

    for (const row of uniteRows) {
        const rowIndex = row.getAttribute('data-row-index'); // Satırın indexini al
        const uniteType = row.querySelector(`[name="option2_${rowIndex}"]`)?.value || ''; // Unit Type
        const uniteShelf = row.querySelector(`[name="option5_${rowIndex}"]`)?.value || ''; // Unit shelf
        const uniteShelf1 = row.querySelector(`[name="option7_${rowIndex}"]`)?.value || ''; // Unit shelf
        const uniteShelf2 = row.querySelector(`[name="option9_${rowIndex}"]`)?.value || ''; // Unit shelf
        const uniteShelf3 = row.querySelector(`[name="option11_${rowIndex}"]`)?.value || ''; // Unit shelf
        const shelf = row.querySelector(`[name="option23_${rowIndex}"]`)?.value || ''; // Shelf
        const backPanel = row.querySelector(`[name="option27_${rowIndex}"]`)?.value || ''; // Back Panel
        const item = row.querySelector(`[name="option29_${rowIndex}"]`)?.value || ''; // Item
        const extra = row.querySelector(`[name="option35_${rowIndex}"]`)?.value || ''; // Extra
        const counterStandard = row.querySelector(`[name="option41_${rowIndex}"]`)?.value || ''; // Counter Standard
        const counterHigh = row.querySelector(`[name="option43_${rowIndex}"]`)?.value || ''; // Counter High

        // Unite Type, Shelf, Back Panel, Item kontrolü
        if (uniteType || shelf || backPanel || item) {
            if (!shelfColor) {
                alert('Shelf Color seçili değil.');
                return false;
            }
        }

        // Extra kolonunda "price" geçiyorsa
        if ((extra && extra.toLowerCase().includes('price')) || (extra && extra.includes('Price')) || uniteShelf || uniteShelf1 || uniteShelf2 || uniteShelf3) {
            if (!ticketColor) {
                alert('Ticket Color seçili değil.');
                return false;
            }
            if (!ttype) {
                alert('Ticket Type seçili değil.');
                return false;
            }
        } else if (!shelfColor) {
            alert('Shelf Color seçili değil.');
            return false;
        }

        // Counter Standard ve Counter High kolonları kontrolü
        if ((counterStandard && counterStandard.toLowerCase().includes('panel')) ||
            (counterHigh && counterHigh.includes('Panel'))) {
                alert('Panel secili.');
            if (!slatwall) {
                alert('Slatwall Color seçili değil.');
                return false;
            }
        } else if ((counterStandard || counterHigh) && !shelfColor) {
            alert('Shelf Color seçili değil.');
            return false;
        }
    }

    return true; // Başarılı sonuç
}
</script>
<script>
async function uniteScndprt(quoteNumber) {
    try {
        if (!quoteNumber) {
            alert('Quote number eksik!');
            return false;
        }

        const uniteRows = document.querySelectorAll('.unite-table table tbody tr');
        const dataToSend = [];

        for (const row of uniteRows) {
            const rowIndex = row.getAttribute('data-row-index');

            for (let i = 24; i <= 43; i += 2) {
                const quantityInput = row.querySelector(`[name="option${i}_${rowIndex}"]`);
                const itemSelect = row.querySelector(`[name="option${i + 1}_${rowIndex}"]`);

                if (quantityInput && itemSelect) {
                    const quantity = quantityInput.value.trim();
                    const itemName = itemSelect.value.trim();

                    if (quantity && itemName) {
                        dataToSend.push({
                            row_index: rowIndex,
                            column_number: i + 1,
                            quantity: parseInt(quantity, 10),
                            item_name: itemName
                        });
                    }
                }
            }
        }

        if (dataToSend.length > 0) {
            const response = await fetch('/add_unite_secnd_part', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    quote_number: quoteNumber,
                    selections: dataToSend
                })
            });

            const result = await response.json();

            if (result.status === 'success') {
                window.scnduntknt = 1;
            } else {
                alert(`Hata: ${result.message}`);
            }
        } 
        else {
            // Seçim yoksa sadece flag ata, işlem devam etsin
            window.scnduntknt = 0;
            return true;
        }
    } catch (error) {
        console.error('uniteScndprt Hatası:', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
    }
}
</script>

<script>
let inputsLocked = true;

document.addEventListener('DOMContentLoaded', async function () {
    const adetHeader = Array.from(document.querySelectorAll('#quoteListTable thead th'))
        .find(th => th.textContent.trim().toUpperCase() === "QTTY");

    if (adetHeader) {
        adetHeader.style.cursor = 'pointer';
        adetHeader.addEventListener('click', async function () {
            // View Mode kontrolü
            const viewMode = document.getElementById('viewMode')?.value;
            if (viewMode !== 'subtotal') {
                // Sadece subtotal modunda çalışsın, değilse hiçbir şey yapma
                return;
            }

            if (!selectedQuoteNumber) {
                alert('Henüz bir numara atanmadı.');
                return;
            }

            // --- SUBTOTAL SATIRLARINI AÇ ---
            document.querySelectorAll('.subtotal-header').forEach(row => {
                row.style.display = '';
            });
            // --- GRUPLANMIŞ SATIRLARI DA AÇ ---
            document.querySelectorAll('.group-row').forEach(row => {
                row.style.display = '';
            });

            if (inputsLocked) {
                // Aç: inputları aktif et
                document.querySelectorAll('.adet-input').forEach(input => {
                    input.disabled = false;
                });
                inputsLocked = false;
            } else {
                // Kapat: inputları kilitle ve güncelle
                document.querySelectorAll('.adet-input').forEach(input => {
                    input.disabled = true;
                });
                inputsLocked = true;

                // Güncelleme işlemi
                const discountInput = document.getElementById('discountInput');
                const dsc = parseFloat(discountInput.value) || 0;

                // ✅ Yeni adet değerlerini topla
                const rows = document.querySelectorAll('#quoteListTable tbody tr');
                const adetUpdates = [];
                rows.forEach(row => {
                    const adetInput = row.children[3]?.querySelector('input'); // ADET input
                    const dbListRaw = row.children[9]?.textContent?.trim(); // 10. sütun: db index(ler)i

                    if (adetInput && dbListRaw) {
                        const adet = parseInt(adetInput.value) || 0;
                        const db_indexes = dbListRaw
                            .split(',')
                            .map(s => parseInt(s.trim()))
                            .filter(n => !isNaN(n));

                        if (db_indexes.length > 0) {
                            adetUpdates.push({ adet, db_indexes });
                        }
                    }
                });

                try {
                    // ✅ Adetleri güncelle
                    const adetResponse = await fetch('/apply_adet', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            quote_number: selectedQuoteNumber,
                            adet_updates: adetUpdates
                        })
                    });

                    const adetResult = await adetResponse.json();
                    if (!adetResponse.ok || adetResult.status !== 'success') {
                        console.error('apply_adet başarısız:', adetResult.message);
                        await fetch('/reset_islmdvm', { method: 'POST' });
                        return;
                    }

                    // ✅ Ardından indirim işlemi
                    const response = await fetch('/apply_discount', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            quote_number: selectedQuoteNumber,
                            dsc: dsc
                        })
                    });

                    const result = await response.json();
                    if (!response.ok || result.status !== 'success') {
                        console.error('apply_discount başarısız:', result.message);
                        await fetch('/reset_islmdvm', { method: 'POST' });
                        return;
                    }

                    await loadQuoteList(selectedQuoteNumber);  // Listeyi yeniden yükle
                    console.log(result.message);
                } catch (error) {
                    console.error('İşlem sırasında hata:', error);
                    await fetch('/reset_islmdvm', { method: 'POST' });
                }
            }
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const viewModeSelect = document.getElementById('viewMode');
    viewModeSelect.addEventListener('change', function () {
        // Seçili quote varsa, tabloyu güncelle
        if (selectedQuoteNumber) {
            loadQuoteList(selectedQuoteNumber);
        }
    });
});

document.addEventListener('DOMContentLoaded', function () {
    const itemNameHeader = Array.from(document.querySelectorAll('#quoteListTable thead th'))
        .find(th => th.textContent.trim().toUpperCase() === "ITEM_NAME");

    let subtotalsVisible = false;

    if (itemNameHeader) {
        itemNameHeader.style.cursor = 'pointer';
        itemNameHeader.addEventListener('click', function () {
            subtotalsVisible = !subtotalsVisible;
            document.querySelectorAll('.group-row').forEach(row => {
                row.style.display = subtotalsVisible ? '' : 'none';
            });
        });
    }
});
</script>

<script>
setInterval(function() {
    fetch('/is_session_active')
        .then(r => r.json())
        .then(data => {
            if (!data.active) {
                alert("Oturumunuz sonlandırıldı.");
                window.location.href = "/logout";
            }
        });
}, 10000); // 10 saniyede bir kontrol
</script>

<script>
    // Show overlay immediately
    document.body.classList.add('loading');
    document.getElementById('loadingOverlay').style.display = 'flex';

    // Hide overlay after all content/scripts loaded
    window.addEventListener('load', function() {
        setTimeout(function() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.body.classList.remove('loading');
        }, 400); // Optionally delay for effect
    });

    // Prevent all interaction while loading
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.body.classList.add('loading');
    });
</script>

</body>
</html>


