<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayfa İçi Sekmeler</title>
    <style>
        /* Sekme başlıkları */
        .tab {
            display: inline-block;
            padding: 10px 20px;
            background-color: #ddd;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        /* Aktif sekme başlığı */
        .tab.active {
            background-color: #333;
            color: white;
        }

        /* Sekme içerikleri */
        .tab-content {
            display: none;
            padding: 20px;
            border: 0px solid #ddd;
            border-top: none;
        }

        /* Aktif sekme içeriği */
        .tab-content.active {
            display: block;
        }

        /* Logo ve Başlık */
        .header {
            display: flex;
            align-items: center; /* Dikeyde ortalama */
            justify-content: flex-start; /* Sol hizalama */
            padding: 10px 20px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        .logo {
            max-width: 300px;
            height: auto;
            margin-right: 20px; /* Logo ile kullanıcı bilgisi arasına boşluk ekleyebiliriz */
        }

        .user-info {
            display: flex;
            flex-direction: column; /* Yatay yerine dikey sıralar */
            gap: 0; /* Aradaki boşluğu sıfırla */
            margin: 0; /* Margin sıfırlandı */
        }

        .user-info h1, .user-info p {
            margin: 0; /* Burada da margin sıfırlandı */
            padding: 0; /* Padding sıfırlandı */
        }

        

        .header-button {
            margin-left: 20px; /* Buton ile kullanıcı bilgisinin arasına boşluk ekleyebiliriz */
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .header-button:hover {
            background-color: #0056b3;
        }

        .logout {
            position: absolute;  /* Sabit pozisyon */
            top: 10px;        /* Ekranın üstünden 10px mesafe */
            right: 10px;      /* Ekranın sağından 10px mesafe */
            text-decoration: none;
            background-color: #f44336;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10000;    /* Diğer öğelerin önünde görünsün */
        }

        #serverTime {
            font-size: 14px;
            color: gray;
            margin-left: auto; /* Sağ tarafa hizala */
        }

        /* Sabit Tab Bar - Sekme başlıkları altta */
        .tab-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #007BFF;
            padding: 10px 0;
            z-index: 1000;
        }

        /* Sayfa içeriği, sekme başlıkları ile çakışmasın diye alt tarafta bir boşluk bırak */
        .content {
            padding-bottom: 70px; /* Alt kısımdaki sabit sekme çubuğu için boşluk */
        }

        /* Müşteri Penceresi */
        .modal {
            display: none; /* Başlangıçta gizli */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Yarı şeffaf arka plan */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto; /* Ortalamak için */
            padding: 20px;
            border: 1px solid #888;
            width: 100%; /* Modal genişliği */
            max-width: 1200px; /* Maksimum genişlik */
            height: 70%; /* Sabit yükseklik */
            overflow: hidden; /* İçerik taşmasını gizle */
            display: flex;
            flex-direction: column;
        }

        .modal input {
            width: 30%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .modal button {
            background-color: #007BFF;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: auto; /* Butonu içeriğin altına iter */
            align-self: center; /* Ortalar */
        }

        .modal button:hover {
            background-color: #0056b3;
        }

        table {
            width: 50%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }
        .scrollable-table {
            max-height: 820px; /* Tablonun maksimum yüksekliği */
            overflow-y: auto; /* Yalnızca dikey kaydırma */
            border: 1px solid #ddd; /* Çerçeve ekleyin */
        }

        .scrollable-table table {
            width: 100%; /* Tabloyu kapsayıcıya yay */
            border-collapse: collapse; /* Çerçeveleri birleştir */
        }

        .scrollable-table th {
            position: sticky; /* Sabit pozisyon */
            top: 0; /* Tablo başlığı yukarıda sabitlenir */
            background-color: #f2f2f2; /* Arka plan rengi */
            z-index: 1; /* Başlığı diğer elemanların üstünde tut */
            border: 1px solid #ddd; /* Başlık hücre çerçevesi */
            padding: 8px; /* İçerik aralığı */
            text-align: center; /* Ortala */
        }

        


    </style>
</head>
<body>

 <!-- Çıkış Butonu -->
 <a href="/logout" class="logout">Çıkış Yap</a>


 <!-- Logo ve Kullanıcı Bilgileri -->
 <div class="header">
     <img src="/static/images/logo.png" alt="Logo" class="logo">
     <div class="user-info" data-user-id="{{ user_id }}">
         <h1>User Name: {{ user }}</h1>
         
         <!--<p id="largestFile">Quotation Number: {{ largest_file }}</p>-->
         <p id="largestFile">{{ largest_file }}</p>
     </div>
     <button class="header-button" onclick="openModal()">Müşteri Bilgileri</button> <!-- Yeni Buton -->

     <div id="selectedCustomer" style="margin-left: 0px; font-size: 14px;">
         <!-- Seçilen müşteri bilgileri burada görünecek -->
     </div>
     <span id="serverTime" style="display: block; margin-top: 10px; font-size: 14px; color: gray;">
        <!-- Tarih burada gösterilecek -->
    </span>
 </div>

 <!-- İçerik -->
 <div class="content">

        <!-- Unite Tab İçeriği -->

        <!-- Unite Tab İçeriği -->
        <div id="tab_unite" class="tab-content">
            <h2>Unite Page</h2>
            <!--<p>Bu, Unite sekmesinin içeriğidir.</p>-->
            <!-- 40 Satır ve 43 Kolonlu Tablo -->

            <!--<button id="updateWidthButton">Update Width</button>-->

            <form method="POST">
                <div class="scrollable-table">
                <table>
                    <thead>
                        <tr>
                            <th colspan="6"></th>
                            <th colspan="2">Top Shelf1</th>
                            <th colspan="2">Top Shelf2</th>
                            <th colspan="2">Top Shelf3</th>
                            <th colspan="3">Back Panel 40</th>
                            <th colspan="3">Back Panel 30</th>
                            <th colspan="3">Back Panel 20</th>
                            <th colspan="3">Back Panel 10</th>
                            <th colspan="1">Color</th>
                            <th colspan="2">Shelves</th>
                            <th colspan="2">Back Panels</th>
                            <th colspan="2">Post, Baseleg</th>
                            <th colspan="2">Extras</th>
                            <th colspan="2">Risers</th>
                            <th colspan="2">Wire Shelves</th>
                            <th colspan="2">Baskets</th>
                            <th colspan="2">Hooks</th>
                            <th colspan="2">Counter Standart</th>
                            <th colspan="2">Counter High</th>
                        </tr>
                        <tr>
                            <th>Sira</th>
                            <th>Unit Piece</th>
                            <th>Unit Type</th>
                            <th>Height</th>
                            <th>Width</th>
                            <th>Base Shelf</th>
                            <th>Qty</th>
                            <th>Shelf Size</th>
                            <th>Qty</th>
                            <th>Shelf Size</th>
                            <th>Qty</th>
                            <th>Shelf Size</th>
                            <th>BP 40</th>
                            <th>Plane 40</th>
                            <th>Perf 40</th>
                            <th>BP 30</th>
                            <th>Plane 30</th>
                            <th>Perf 30</th>
                            <th>BP 20</th>
                            <th>Plane 20</th>
                            <th>Perf 20</th>
                            <th>BP 10</th>
                            <th>Plane 10</th>
                            <th>Perf 10</th>
                            <th>Color</th>
                            <th>Qty</th>
                            <th>Shelf</th>
                            <th>Qty</th>
                            <th>Back Panel</th>
                            <th>Qty</th>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Extras</th>
                            <th>Qty</th>
                            <th>Risers</th>
                            <th>Qty</th>
                            <th>Wire Shelf</th>
                            <th>Qty</th>
                            <th>Baskets</th>
                            <th>Qty</th>
                            <th>Hooks</th>
                            <th>Qty</th>
                            <th>Counter Standart</th>
                            <th>Qty</th>
                            <th>Counter High</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(40) %}
                        <tr data-row-index="{{ i }}">
                            <td class="row-number">{{ i + 1 }}</td>
                            <td>
                                <select name="option1_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox1'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option2_{{ i }}" class="trigger-select">
                                    <option value=""></option>
                                    {% for option in options['combobox2'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option3_{{ i }}"class="base-select">
                                    <option value=""></option>
                                    {% for option in options['combobox3'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option4_{{ i }}" >
                                    <option value=""></option>
                                    {% for option in options['combobox4'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option5_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox5'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option6_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox6'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option7_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox7'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option8_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox8'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option9_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox9'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option10_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox10'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option11_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox11'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value1_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option13_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox13'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option14_{{ i }}" class="bp-select">
                                    <option value=""></option>
                                    {% for option in options['combobox14'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value2_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option16_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox16'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option17_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox17'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value3_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option19_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox19'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option20_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox20'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <label class="value-label" id="value4_{{ i }}"></label>
                            </td>
                            <td>
                                <select name="option22_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox22'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="option23_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox23'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            


                             <td>
                                <select name="option24_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox24'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>
                                <!-- Label yerine text box (input) ekliyoruz -->
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option26_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox26'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option28_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox28'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option30_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox30'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option32_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox32'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option34_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox34'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option36_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox36'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option38_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox38'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option40_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox40'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option42_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox42'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                            </td>
                            <td>
                                <select name="option44_{{ i }}">
                                    <option value=""></option>
                                    {% for option in options['combobox44'] %}
                                        <option value="{{ option }}">{{ option }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </form>
        </div>

        <!-- Diğer Tab İçeriği (Örnek: Refrigeration) -->
        <div id="tab_refrigeration" class="tab-content">
            <h2>Refrigeration</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <label for="customerType">Choose Customer Type:</label>
                    <select id="customerType">
                        <option value="Retail">Retail</option>
                        <option value="Trade">Trade</option>
                    </select>
                </div>
                <div>
                    <label for="ref_dsc">Discount:</label>
                    <input type="number" id="ref_dsc" value="0" style="width: 60px;" min="0" max="100" step="1">
                </div>
            </div>
            <table border="1" style="width: 100%; text-align: center; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>SELECT GROUP</th>
                        <th>SELECT ITEM</th>
                        <th>WARRANTY</th>
                        <th>UNPACK&POSITION</th>
                        <th>REMOVE&DISPOSE</th>
                        <th>QUANTITY</th>
                        <th>PRICE</th>
                        <th>D.PRICE</th>
                        <th>SKU</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(15) %}
                    <tr>
                        <td>
                            <select name="group_{{ i }}" class="group-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <select name="item_{{ i }}" class="item-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <select name="warranty_{{ i }}" class="warranty-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <select name="unpack_{{ i }}" class="unpack-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->

                            </select>
                        </td>
                        <td>
                            <select name="remove_{{ i }}" class="remove-select">
                                <option value=""></option> <!-- Varsayılan boş seçenek -->
                            </select>
                        </td>
                        <td>
                            <input type="number" name="quantity_{{ i }}" min="1" style="width: 60px;">
                        </td>
                        <td>
                            <label id="price_{{ i }}"></label>
                        </td>
                        <td>
                            <label id="dprice_{{ i }}"></label>
                        </td>
                        <td>
                            <label id="sku_{{ i }}"></label>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="tab_add_item" class="tab-content">
            <h2>ADD ITEM</h2>
            <!--<p>Bu, add item sekmesinin içeriğidir.</p>-->
            <!--<table border="1" style="width: 100%; text-align: center;">-->
                <table border="1" style="text-align: center;">
                <thead>
                    <tr>
                        <th style="width: 200px;">Item Name</th>
                        <th style="width: 30px;">Qty</th>
                        <th style="width: 30px;">Price</th>
                        <th style="width: 30px;">After Disc.</th>
                        <th style="width: 60px;">Depo Code</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 20 satır oluşturuluyor -->
                    <!-- Her satırda 5 sütun -->
                    <!-- 2., 3., ve 4. sütunlar için yalnızca rakam girişi -->
                    <!-- HTML5 input type="number" kullanılarak sağlanır -->
                    <!-- Satırlar dinamik olarak çoğaltılabilir -->
                    <script>
                        //<input type="text" class="value-input" style="width: 30px;"  onkeypress="return isNumberKey(event)" /> 
                        //<td><input type="number" style="width: 100%;"></td>
                        //<td><input type="number" step="0.01" style="width: 100%;"></td>
                        // 20 satır ve 5 sütun ekleyen dinamik JavaScript kodu
                        for (let i = 0; i < 20; i++) {
                            document.write(`<tr>
                                <td><input type="text" style="width: 100%;"></td>
                                <td><input type="text" style="width: 100%;"  onkeypress="return isNumberKey(event)" ></td> 
                                <td><input type="text" style="width: 100%;"  onkeypress="return isNumberKey(event)" ></td> 
                                <td><input type="text" style="width: 100%;"  onkeypress="return isNumberKey(event)" ></td>
                                <td><input type="text" style="width: 100%;"></td>
                            </tr>`);
                        }
                    </script>
                </tbody>
            </table>
        </div>

        
        <div id="tab_proforma" class="tab-content active">
            <!-- <h2>Proforma</h2>-->
            <h2 id="tableHeader" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Quote list: Yükleniyor...</span>
            </h2>
            <div style="display: flex; gap: 100px; align-items: center; margin-top: 20px;">
                <button id="updateWidthBtn">Make Proforma</button>
                <button id="openProformaBtn" onclick="openProformaModal()">Open Proforma</button>
                <label for="discountInput">Discount:</label>
                <input type="number" id="discountInput" value="0" style="width: 60px;" min="0" max="100" step="1">
            </div>

            <p id="statusMessage"></p>
        
            <!-- Quote List Table -->
            <table id="quoteListTable" border="1" style="margin-top: 20px; width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>USER_ID</th>
                        <th>ITEM_ID</th>
                        <th>ITEM_NAME</th>
                        <th>ADET</th>
                        <th>UNIT_TYPE</th>
                        <th>SIRA</th>
                        <th>PRICE</th>
                        <th>D.PRICE</th>
                        <th>AMOUNTH</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Veri buraya yüklenecek -->
                </tbody>
            </table>
        </div>

        <div id="tab_goruntule" class="tab-content">
            <h1>Database Content</h1>
        
            {% if data %}
                {% for table_name, table_data in data.items() %}
                    <h2>{{ table_name }}</h2>  <!-- Tablo adı -->
                    <table border="1">
                        <thead>
                            <tr>
                                {% for column in table_data.columns %}
                                    <th>{{ column }}</th>  <!-- Sütun isimleri -->
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data.rows %}
                                <tr>
                                    {% for cell in row %}
                                        <td>{{ cell }}</td>  <!-- Her hücrenin değeri -->
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endfor %}
            {% else %}
                <p>No data available.</p>
            {% endif %}
        </div>

        <div id="tab_ceiling" class="tab-content">
            <h2>Ceiling</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <label for="ceilingM2">Ceiling M2:</label>
                    <input type="number" id="ceilingM2" placeholder="Enter M2" style="margin-right: 20px;">
                    <label for="trimLM">Trim LM:</label>
                    <input type="number" id="trimLM" placeholder="Enter LM">
                </div>
                <div>
                    <label for="ceilingDiscount">Discount:</label>
                    <input type="number" id="ceilingDiscount" placeholder="Enter Discount" style="width: 100px;">
                </div>
            </div>
            <table border="1" style="width: 100%; text-align: center; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Materials</th>
                        <th>Notes</th>
                        <th>Qty</th>
                        <th>Local</th>
                        <th>D.Price</th>
                    </tr>
                </thead>
                <tbody id="ceilingTableBody">
                    <!-- Veriler backend'den yüklenecek -->
                </tbody>
            </table>
        </div>
        <script>
            let ceil_dsc = 0; // Discount değeri için global değişken

            function fetchCeilingData() {
                const ceilingM2Input = document.getElementById('ceilingM2');
                const trimLMInput = document.getElementById('trimLM');
                const discountInput = document.getElementById('ceilingDiscount');

                let ceilingM2 = parseFloat(ceilingM2Input.value) || 0;
                let trimLM = parseFloat(trimLMInput.value) || 0;
                ceil_dsc = parseFloat(discountInput.value) || 0; // Discount değerini al

                fetch('/calculate_ceiling_qty', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ceilingM2, trimLM, ceil_dsc }), // ceil_dsc gönderiliyor
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const tableBody = document.getElementById('ceilingTableBody');
                        tableBody.innerHTML = ''; // Eski içeriği temizle

                        data.rows.forEach(row => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${row.Code}</td>
                                <td>${row.Materials}</td>
                                <td>${row.Notes}</td>
                                <td>${row.qty}</td>
                                <td>${row.local}</td>
                                <td>${row.dPrice}</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    } else {
                        console.error('Hata:', data.message);
                    }
                })
                .catch(error => console.error('Hata:', error));
            }

            document.getElementById('ceilingM2').addEventListener('input', fetchCeilingData);
            document.getElementById('trimLM').addEventListener('input', fetchCeilingData);
            document.getElementById('ceilingDiscount').addEventListener('input', fetchCeilingData); // Discount değişikliğinde tetikleniyor
        </script>

        <!-- Diğer içerikler buraya eklenebilir -->
    </div>

    <div class="modal" id="customerModal">
    <div class="modal-content" style="max-width: 1400px;"> <!-- Modal genişliği artırıldı -->
    <h2>Müşteri Bilgileri</h2>
    <input type="text" id="searchBox" placeholder="Müşteri Arama..." onkeyup="searchCustomer()">
    <div style="display: flex; gap: 20px;">
        <!-- Sol taraf: Müşteri Tablosu -->
        <div style="flex: 2;">
            <table id="customerTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Customer ID</th>
                        <th>Customer Name</th>
                        <th>Tel</th>
                        <th>Address</th>
                        <th>Postcode</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dinamik veri buraya gelir -->
                </tbody>
            </table>
            <button onclick="closeModal()" style="margin-top: 10px;">Kapat</button>
        </div>

        <!-- Orta çizgi -->
        <div style="width: 1px; background-color: #ddd;"></div>

        <!-- Sağ taraf: Customer Add/Update -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
            <h2>Customer Add/Update</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerName" style="width: 150px;">Customer Name</label>
                <input type="text" id="customerName" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerTel" style="width: 150px;">Tel</label>
                <input type="text" id="customerTel" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerAddress1" style="width: 150px;">Address Line1</label>
                <input type="text" id="customerAddress1" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerAddress2" style="width: 150px;">Address Line2</label>
                <input type="text" id="customerAddress2" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerPostcode" style="width: 150px;">Postcode</label>
                <input type="text" id="customerPostcode" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerEmail" style="width: 150px;">Email</label>
                <input type="text" id="customerEmail" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="customerDiscount" style="width: 150px;">Discount</label>
                <input type="text" id="customerDiscount" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <button onclick="addOrUpdateCustomer()" style="margin-top: 10px; padding: 10px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer;">ADD / UPDATE</button>
        </div>
    </div>
</div>
</div>

<script>

</script>

    <div class="modal" id="proformaModal">
        <div class="modal-content">
            <h2>Proforma Listesi</h2>
            <input type="text" id="searchBox" placeholder="Proforma Arama..." onkeyup="searchProforma()">
            
            <!-- Kaydırılabilir tablo -->
            <div class="scrollable-table">
                <table id="proformaTable">
                    <thead>
                        <tr>
                            <th>Quote Number</th>
                            <th>User ID</th>
                            <th>User Name</th>
                            <th>Customer ID</th>
                            <th>Customer Name</th>
                            <th>DidDis</th>
                            <th>Amount</th>
                            <th>Sold</th>
                            <th>Inv</th>
                            <th>Created At</th> <!-- Yeni sütun -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dinamik veri buraya gelir -->
                    </tbody>
                </table>
            </div>
            
            <button onclick="closeProformaModal()">Kapat</button>
        </div>
    </div>

    <!-- Sabit Tab Bar - Sekme Başlıkları altta -->
    <div class="tab-bar">
        <div class="tab active" onclick="openTab('tab_proforma')">Proforma</div>
        <div class="tab" onclick="openTab('tab_unite')">Unite</div>
        <div class="tab" onclick="openTab('tab_refrigeration')">Refrigeration</div>
        <div class="tab" onclick="openTab('tab_ceiling')">Ceiling</div>
        <div class="tab" onclick="openTab('tab_add_item')">Add Item</div>
        
        <div class="tab" onclick="openTab('tab_view_pdf')">View PDF</div>
        <div class="tab" onclick="openTab('tab_goruntule')">Goruntule</div>
    </div>


    

    <script>

let selectedCustomerID = null;
let selectedCustomer1ID = null;
let selectedCustomerName = null;
let selectedQuoteNumber = null; // Seçili quote numarasını saklamak için global değişken

function setCustomerInfo(customer) {
    // Backend'e müşteri bilgilerini gönder
    fetch('/set_customer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            customer_id: customer[0],
            customer_name: customer[1],
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log("Müşteri bilgileri başarıyla gönderildi.");
        } else {
            console.error("Müşteri bilgileri gönderilirken hata oluştu:", data.message);
        }
    })
    .catch(error => {
        console.error("Müşteri bilgileri gönderilirken hata oluştu:", error);
    });
}
        // Sekme açma fonksiyonu
        function openTab(tabId) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="openTab('${tabId}')"]`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.trigger-select').forEach((select, index) => {
                select.addEventListener('change', function() {
                    toggleRowNumber(index);
                });
            });
    
            document.querySelectorAll('.bp-select').forEach((select, index) => {
                select.addEventListener('change', function() {
                    updateValueDisplay(index);
                });
            });
    
            document.querySelectorAll('.base-select').forEach((select, index) => {
                select.addEventListener('change', function() {
                    updateValueDisplay(index);
                });
            });
        });
    
        function toggleRowNumber(index) {
            const rowNumberCell = document.querySelectorAll('.row-number')[index];
            const triggerSelect = document.querySelectorAll('.trigger-select')[index];
            
            if (triggerSelect.value) {
                rowNumberCell.textContent = index + 1; 
            } else {
                rowNumberCell.textContent = ""; 
            }
        }
    
        function updateValueDisplay(index) {
        const bpSelect = document.querySelectorAll('.bp-select')[index];
        const type = document.querySelectorAll('.base-select')[index];
        const secondCombobox = document.querySelectorAll('.trigger-select')[index]; // 2. combobox
        const valueLabel1 = document.getElementById(`value1_${index}`);
        const valueLabel2 = document.getElementById(`value2_${index}`);
        const valueLabel3 = document.getElementById(`value3_${index}`);
        const valueLabel4 = document.getElementById(`value4_${index}`);

        const selectedValueBP = parseInt(bpSelect.value);
        const selectedValueBase = parseInt(type.value);
        const secondComboboxValue = secondCombobox.value; // 2. combobox değeri alınıyor
    
        let multiplier = 1;

    // 2. combobox değeri 'Single Gondola' veya 'Double Gondola' ise multiplier 2 katına çıkar
        if (secondComboboxValue === "Single Gondola" || secondComboboxValue === "Double Gondola") {
            if (!isNaN(selectedValueBase) && selectedValueBase > 10) {
                const adjustedValueBase = selectedValueBase - 10; 
                const pnl40=adjustedValueBase / 40
                valueLabel1.textContent = Math.floor(pnl40) * 2;
                const remainingAfter40 = adjustedValueBase - (Math.floor(pnl40) * 40); 
                const pnl30 = remainingAfter40 / 30; 
                valueLabel2.textContent = Math.floor(pnl30) * 2;
                const remainingAfter30 = remainingAfter40 - (Math.floor(pnl30) * 30); 
                const pnl20 = remainingAfter30 / 20; 
                valueLabel3.textContent = Math.floor(pnl20) * 2;
                const remainingAfter20 = remainingAfter30 - (Math.floor(pnl20) * 20); 
                const pnl10 = remainingAfter20 / 10; 
                valueLabel4.textContent = Math.floor(pnl10) * 2;
            }
            else {
            valueLabel1.textContent = "";
            valueLabel2.textContent = "";
            valueLabel3.textContent = "";
            valueLabel4.textContent = "";
            }  
        }
        else{

            if (!isNaN(selectedValueBase) && selectedValueBase > 10) {
                const adjustedValueBase = selectedValueBase - 10; 
                const pnl40=adjustedValueBase / 40
                valueLabel1.textContent = Math.floor(pnl40);
                const remainingAfter40 = adjustedValueBase - (Math.floor(pnl40) * 40); 
                const pnl30 = remainingAfter40 / 30; 
                valueLabel2.textContent = Math.floor(pnl30);
                const remainingAfter30 = remainingAfter40 - (Math.floor(pnl30) * 30); 
                const pnl20 = remainingAfter30 / 20; 
                valueLabel3.textContent = Math.floor(pnl20);
                const remainingAfter20 = remainingAfter30 - (Math.floor(pnl20) * 20); 
                const pnl10 = remainingAfter20 / 10; 
                valueLabel4.textContent = Math.floor(pnl10);
            }
            else {
            valueLabel1.textContent = "";
            valueLabel2.textContent = "";
            valueLabel3.textContent = "";
            valueLabel4.textContent = "";
            } 
        } 
    }       
        function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        // Rakam (0-9) ve Backspace (8) dışında bir tuş basıldığında engelle
        if (charCode != 8 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }



// 1. İlk fonksiyon: updateWidthData
async function updateWidthData() {
    const rows = Array.from(document.querySelectorAll('tbody tr'));
    let validRowFound = false;
    const errorMessages = [];
    const largestFile = document.getElementById('largestFile').textContent.trim();

    for (let index = 0; index < 40; index++) {
        const row = rows[index];
        const rowIndex = index + 1;

        // İlgili select öğelerinin varlığını kontrol et
        const unitPieceElement = row.querySelector('select[name^="option1_"]');
        const unittypeElement = row.querySelector('select[name^="option2_"]');
        const heightValueElement = row.querySelector('select[name^="option3_"]');
        const widthValueElement = row.querySelector('select[name^="option4_"]');
        const baseShelfValueElement = row.querySelector('select[name^="option5_"]');
        const qtyValueElement = row.querySelector('select[name^="option6_"]');
        const shelfSizeValueElement = row.querySelector('select[name^="option7_"]');
        const qtyOption8Element = row.querySelector('select[name^="option8_"]');
        const shelfSizeOption9Element = row.querySelector('select[name^="option9_"]');
        const qtyOption10Element = row.querySelector('select[name^="option10_"]');
        const shelfSizeOption11Element = row.querySelector('select[name^="option11_"]');
        const plane40Element = row.querySelector('select[name^="option13_"]');
        const perf40Element = row.querySelector('select[name^="option14_"]');
        const plane30Element = row.querySelector('select[name^="option16_"]');
        const perf30Element = row.querySelector('select[name^="option17_"]');
        const plane20Element = row.querySelector('select[name^="option19_"]');
        const perf20Element = row.querySelector('select[name^="option20_"]');
        const plane10Element = row.querySelector('select[name^="option22_"]');
        const perf10Element = row.querySelector('select[name^="option23_"]');

        // Satırdaki değerlerin herhangi biri seçilmiş veya girilmişse işlem yap
        const anyValueEntered = 
        (unitPieceElement && unitPieceElement.value) ||
            (unittypeElement && unittypeElement.value) ||
            (heightValueElement && heightValueElement.value) ||
            (widthValueElement && widthValueElement.value) ||
            (baseShelfValueElement && baseShelfValueElement.value) ||
            (qtyValueElement && qtyValueElement.value) ||
            (shelfSizeValueElement && shelfSizeValueElement.value) ||
            (qtyOption8Element && qtyOption8Element.value) ||
            (shelfSizeOption9Element && qtyOption8Element.value) ||
            (qtyOption10Element && qtyOption10Element.value) ||
            (shelfSizeOption11Element && shelfSizeOption11Element.value) ||
            (plane40Element && plane40Element.value) ||
            (perf40Element && perf40Element.value) ||
            (plane30Element && plane30Element.value) ||
            (perf30Element && perf30Element.value) ||
            (plane20Element && plane20Element.value) ||
            (perf20Element && perf20Element.value) ||
            (plane10Element && perf10Element.value) ||
            (perf10Element && perf10Element.value);

        // Eğer hiçbir değer girilmediyse bu satırı atla
        if (!anyValueEntered) {
            continue; // Bu satırı atla ve sıradaki satıra geç
        }

        // Gerekli öğeler eksikse hata mesajı ekle ve bu satırı atla
        if (!unitPieceElement || !unittypeElement || !heightValueElement || !widthValueElement || !baseShelfValueElement) {
            errorMessages.push(`Satır ${rowIndex}: Gerekli öğeler eksik.`);
            continue; // Eksik öğe varsa bu satırı atla
        }

        // Seçilen değerleri al
        const unitPiece = unitPieceElement.value;
        const unittype = unittypeElement.value;
        const heightValue = heightValueElement.value;
        const widthValue = widthValueElement.value;
        const baseShelfValue = baseShelfValueElement.value;
        const qtyValue = qtyValueElement ? qtyValueElement.value : '';
        const shelfSizeValue = shelfSizeValueElement ? shelfSizeValueElement.value : '';
        const qtyOption8 = qtyOption8Element ? qtyOption8Element.value : '';
        const shelfSizeOption9 = shelfSizeOption9Element ? shelfSizeOption9Element.value : '';
        const qtyOption10 = qtyOption10Element ? qtyOption10Element.value : '';
        const shelfSizeOption11 = shelfSizeOption11Element ? shelfSizeOption11Element.value : '';
        const plane40 = plane40Element ? plane40Element.value : '';
        const perf40 = perf40Element ? perf40Element.value : '';
        const plane30 = plane30Element ? plane30Element.value : '';
        const perf30 = perf30Element ? perf30Element.value : '';
        const plane20 = plane20Element ? plane20Element.value : '';
        const perf20 = perf20Element ? perf20Element.value : '';
        const plane10 = plane10Element ? plane10Element.value : '';
        const perf10 = perf10Element ? perf10Element.value : '';

        // Boş değer kontrolü
        const allOptionsEmpty =
            !unitPiece && !unittype && !heightValue && !widthValue && !baseShelfValue &&
            !qtyValue && !shelfSizeValue &&
            !qtyOption8 && !shelfSizeOption9 &&
            !qtyOption10 && !shelfSizeOption11 &&
            !plane40 && !perf40 &&
            !plane30 && !perf30 &&
            !plane20 && !perf20 &&
            !plane10 && !perf10;

        if (allOptionsEmpty) {
            continue; // Bu satırı atla ve sıradaki satıra geç
        }
        else{
            //return;
        }

        validRowFound = true; // İşlenecek bir satır bulundu

        // Fetch çağrısı
        try {
            const response = await fetch('/update_width', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    row_index: rowIndex, // Satır numarasını ekliyoruz
                    unit_piece: unitPiece,
                    unit_type: unittype,
                    height: heightValue,
                    width: widthValue,
                    base_shelf: baseShelfValue,
                    qty: qtyValue,
                    shelf_size: shelfSizeValue,
                    qty_option8: qtyOption8,
                    shelf_size_option9: shelfSizeOption9,
                    qty_option10: qtyOption10,
                    shelf_size_option11: shelfSizeOption11,
                    plane40: plane40,
                    perf40: perf40,
                    plane30: plane30,
                    perf30: perf30,
                    plane20: plane20,
                    perf20: perf20,
                    plane10: plane10,
                    perf10: perf10,
                    largest_file: largestFile // largest_file değerini de ekliyoruz
                }),
            });

            if (!response.ok) {
                throw new Error('Güncelleme sırasında hata oluştu.');
            }

            //loadQuoteList();
        } catch (error) {
            console.error('Hata:', error);
            document.getElementById('statusMessage').textContent = 'Güncelleme sırasında hata oluştu.';
            return false; // Eğer hata varsa işlemi iptal et
        }
    }

    if (errorMessages.length > 0) {
        alert(errorMessages.join('\n'));
        return false; // Hatalar varsa false döndür
    }

    if (!validRowFound) {
        //alert('Unit bos');
        window.untknt = 0; // Tüm fonksiyonlar için global bir değişken oluşturuyoruz.
        return true; // Hiçbir satır işlenmediyse false döndür
    }else{
        window.untknt = 1;
    }

    return true; // İşlem başarıyla tamamlandı
}

// 2. İkinci fonksiyon: showAddItemData
async function showAddItemData() {
    const rows = document.querySelectorAll('#tab_add_item tbody tr'); // Tüm satırları seç
    const largestFile = document.getElementById('largestFile').textContent.trim(); // largestFile değerini al

    const addItemData = []; // Gönderilecek tüm verileri tutacak dizi

    // Tüm satırlarda dön
    rows.forEach((row) => {
        const inputs = row.querySelectorAll('input'); // Satırdaki tüm inputları al
        const itemName = inputs[0]?.value.trim(); // 1. input (Item Name)
        const qty = inputs[1]?.value.trim(); // 2. input (Quantity)
        const price = inputs[2]?.value.trim(); // 3. input (Price)
        const dsprice = inputs[3]?.value.trim(); // 4. input (After Discount)
        const kar = inputs[4]?.value.trim(); // 5. input (Depo Code)

        // Eğer en az Item Name ve Quantity doluysa, veriyi ekle
        if (itemName && qty) {
            addItemData.push({
                itemName: itemName,
                qty: parseInt(qty, 10), // Sayıya çevir
                price: parseFloat(price || 0), // Sayıya çevir, boşsa 0
                dsprice: parseFloat(dsprice || 0), // Sayıya çevir, boşsa 0
                //kar: String(kar || "") // kar değerini açıkça text'e çevir
                kar:kar
            });
        }
    });

    // Eğer gönderilecek veri yoksa uyarı ver ve işlemi durdur
     if (addItemData.length === 0) {
        ///////////////////////////////////////alert("Add item bos!");
        //return Promise.reject("Geçerli veri yok.");
        window.aditmknt = 0; // Tüm fonksiyonlar için global bir değişken oluşturuyoruz.
        return true;
    }else{
        window.aditmknt = 1;
    }

    // API'ye gönderilecek veri
    const data = {
        add_item_data: addItemData, // Toplanan tüm satırlar
        largest_file: largestFile // largestFile değeri burada kullanılıyor
    };

    // API'ye POST isteği gönder
    try {
        // Yerel veya sunucu ortamına göre API taban URL'sini ayarla
    const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';

    const apiBaseUrl = isLocal
        ? 'http://127.0.0.1:5000' // Yerel geliştirme ortamı için
        : window.location.origin; // Render.com veya herhangi bir sunucu ortamı için

    // API çağrısı
    const response = await fetch(`${apiBaseUrl}/add_item_data`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
            },
        body: JSON.stringify(data)
    });


        const responseData = await response.json();

        if (responseData.status === "success") {
            //alert("Veriler başarıyla gönderildi!");
        } else {
            throw new Error("Bir hata oluştu: " + responseData.message);
        }
    } catch (error) {
        console.error('API Hatası:', error);
        alert('Veri gönderme sırasında hata oluştu.');
        throw error; // Hata fırlatarak işlemi durdur
    }
}
// 3. Main fonksiyon: Sıralı çağırma ve loadQuoteList() çağrısı
async function mainFunction() {
    console.log("mainFunction çalıştı");
    // islmdvm değerini kontrol et
    const response = await fetch('/check_islmdvm');
    const data = await response.json();

        // Müşteri seçimi kontrolü
    if (!selectedCustomerID) {
    alert("Müşteri seçili değil! Lütfen bir müşteri seçin.");
    // islmdvm değerini sıfırlamak için bir API çağrısı yap
    await fetch('/reset_islmdvm', { method: 'POST' });
    return; // İşlemleri sonlandır
    }

    if (data.status === 'busy') {
    //alert("İçeride kullanıcı var!");
    // İşlemleri iptal ettikten sonra "Make Proforma" butonuna otomatik tıklama
    await new Promise(resolve => setTimeout(resolve, 1000));
    document.getElementById('updateWidthBtn').click();
    return; // İşlemleri iptal et
    }
    // Eş zamanlı tıklamaları kontrol et
    //await checkConcurrentClicks();
    const nextNumber = await quotenumkont();
    if (!nextNumber) {
        console.error("quotenumkont işlemi başarısız. İşlem durduruldu.");
        await fetch('/reset_islmdvm', { method: 'POST' });
        return; // İşlemi sonlandır
    }

    // largestFile değerini güncelle
    document.getElementById('largestFile').textContent = nextNumber

        // 1. updateWidthData çağrısı
    const updateResult = await updateWidthData();
    if (!updateResult) {
        console.error('updateWidthData başarısız oldu. İşlem sonlandırıldı.');
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    



    // 1. AddRefData çağrısı
    try {
        console.log("AddRefData fonksiyonu çağrıldı.");
        await AddRefData(); // İşlemin tamamlanmasını bekle
    } catch (error) {
        console.error('AddRefData başarısız oldu. İşlem sonlandırıldı.', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    // 2. showAddItemData çağrısı
    try {
        console.log("showAddItemData fonksiyonu çağrıldı.");
        await showAddItemData(); // İşlemin tamamlanmasını bekle
    } catch (error) {
        console.error('showAddItemData başarısız oldu. İşlem sonlandırıldı.', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    // Ceiling verilerini gönder
    try {
        console.log("addCeilingData fonksiyonu çağrıldı.");
        await addCeilingData(); // Ceiling verilerini gönder
    } catch (error) {
        console.error('addCeilingData başarısız oldu. İşlem sonlandırıldı.', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }
    
       // 3. Kullanıcıdan indirim değerini al
       const discountInput = document.getElementById('discountInput');
    const dsc = parseFloat(discountInput.value) || 0; // Kullanıcının girdiği değeri al

    // 4. apply_discount çağrısı
    try {
    const response = await fetch('/apply_discount', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
        body: JSON.stringify({ quote_number: nextNumber, dsc: dsc }) // dsc = 5
    });

    const result = await response.json();
    if (result.status !== 'success') {
        console.error('apply_discount başarısız oldu:', result.message);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }
    console.log(result.message);
    } catch (error) {
        console.error('apply_discount sırasında hata oluştu:', error);
        await fetch('/reset_islmdvm', { method: 'POST' });
        return;
    }

    // 3. loadQuoteList çağrısı
    if ((window.untknt || 0) + (window.aditmknt || 0) + (window.adrefknt || 0)+ (window.adclknt || 0)<= 0) {
        alert("Proforma oluşturulacak bir değer yok!");
        await fetch('/reset_islmdvm', { method: 'POST' });
    } else {
        console.log("loadQuoteList fonksiyonu çağrılıyor.");

        await loadQuoteList(nextNumber); // İşlemin tamamlanmasını bekle
        await callPrepUpQt(nextNumber,dsc);
        await saveUniteSelection(nextNumber);
        await saveAddItemSelection(nextNumber);

        //if ((window.adrefknt || 0)<= 0) {
        //await fetch('/reset_islmdvm', { method: 'POST' });
        //} else {
        await saveRefSelection(nextNumber); // Yeni fonksiyon çağrısı
        //}
        await saveCeilSelection(nextNumber)
        await fetch('/reset_islmdvm', { method: 'POST' });
        
    }
}



// 4. Event Listener
document.getElementById('updateWidthBtn').addEventListener('click', mainFunction);
//document.getElementById('updateWidthBtn').addEventListener('click', quotenumkont);

// Yeni fonksiyon: quotenumkont

async function quotenumkont() {
    try {
        // Proforma listesinden seçili bir quote olup olmadığını kontrol et
        if (selectedQuoteNumber) {
            console.log(`Seçili quote bulundu: ${selectedQuoteNumber}`);

            // clear_list_table endpoint'ini çağır
            const response = await fetch('/clear_list_table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ db_name: selectedQuoteNumber }), // Veritabanı adını gönder
            });

            const data = await response.json();
            if (data.status === 'success') {
                console.log(data.message); // Başarı mesajını konsola yazdır
            } else {
                console.error('Tablo temizlenirken hata oluştu:', data.message);
                alert(data.message); // Hata mesajını kullanıcıya göster
                return null; // İşlemi sonlandır
            }

            return selectedQuoteNumber; // Seçili quote numarasını döndür
        }

        // Eğer seçili bir quote yoksa normal işlemlere devam et
        console.log("Seçili quote bulunamadı, yeni numara hesaplanıyor...");

        // Sunucudan dosya listesini al
        const response = await fetch('/get_quote_files'); // quotes klasöründeki dosyaları döndüren bir endpoint
        if (!response.ok) {
            throw new Error('Dosya listesi alınırken hata oluştu.');
        }

        // Dosya isimlerini al
        const files = await response.json(); // Örnek: ["001.db", "002.db", "010.db", "100.db"]
        if (!files || files.length === 0) {
            alert("Quotes klasöründe dosya bulunamadı.");
            return null; // İşlemi sonlandır
        }

        // Sadece .db uzantılı dosyaları ve sıfırları koruyarak numaraları ayıkla
        const fileNumbers = files
            .filter(file => file.endsWith('.db')) // .db uzantılı dosyaları seç
            .map(file => file.match(/^(\d+)\.db$/)) // Numara kısmını ve sıfırları ayıkla
            .filter(match => match) // Geçerli eşleşmeleri seç
            .map(match => match[1]); // Numara kısmını al

        if (fileNumbers.length === 0) {
            alert("Geçerli dosya numarası bulunamadı.");
            return null; // İşlemi sonlandır
        }

        // En büyük numarayı bul
        const maxNumber = fileNumbers.reduce((max, num) => 
            num.length > max.length || (num.length === max.length && num > max) ? num : max
        );

        // Bir fazlasını hesapla, sıfırları koruyarak
        const nextNumber = (BigInt(maxNumber) + 1n).toString().padStart(maxNumber.length, '0');

        console.log(`Bir sonraki dosya numarası: ${nextNumber}`);
        return nextNumber; // Hesaplanan değeri döndür
    } catch (error) {
        console.error('Hata:', error);
        alert('Dosya kontrolü sırasında bir hata oluştu.');
        return null; // İşlemi sonlandır
    }
}



document.addEventListener('DOMContentLoaded', function () {
        // Hedef değerler
        const targetValues = ["End / Wall Unit", "End / Single Gondola", "End / Double Gondola"];

        // Tüm trigger-select sınıfındaki select elementlerini dinle
        const triggerSelects = document.querySelectorAll('.trigger-select');

        triggerSelects.forEach(select => {
            select.addEventListener('change', function () {
                const row = select.closest('tr'); // Satırı bul
                const selectedValue = select.value; // Seçili değeri al
                
                // Eğer seçili değer hedef değerlerden biriyse
                if (targetValues.includes(selectedValue)) {
                    lockComboboxes(row);
                } else {
                    unlockComboboxes(row);
                }
            });
        });

        // Combobox'ları kilitle
        function lockComboboxes(row) {
            row.querySelectorAll('select').forEach((combobox, index) => {
                if (![0, 1, 2, 4, 22].includes(index)) { // 1., 2., 3., 5. ve 23. combobox'ı atla
                    combobox.disabled = true;
                }
            });
        }

        // Combobox'ları aç
        function unlockComboboxes(row) {
            row.querySelectorAll('select').forEach((combobox, index) => {
                if (![0, 1, 2, 4, 22].includes(index)) { // 1., 2., 3., 5. ve 23. combobox'ı atla
                    combobox.disabled = false;
                }
            });
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Dinlenmesi gereken combobox isimlerini bir array olarak tanımlıyoruz
        const monitoredComboboxes = [
            "option13_", "option14_", 
            "option16_", "option17_", 
            "option19_", "option20_", 
            "option22_", "option23_"
        ];

        // Tüm satırlardaki comboboxlar için event listener ekle
        const selects = document.querySelectorAll("select");

        selects.forEach(select => {
            const name = select.getAttribute("name");
            if (monitoredComboboxes.some(prefix => name && name.startsWith(prefix))) {
                select.addEventListener("change", function () {
                    const row = select.closest('tr'); // İlgili satırı bul

                    // Her bir label için kontrol yap
                    checkLabelTotal(row, 'value1_', 'option13_', 'option14_');
                    checkLabelTotal(row, 'value2_', 'option16_', 'option17_');
                    checkLabelTotal(row, 'value3_', 'option19_', 'option20_');
                    checkLabelTotal(row, 'value4_', 'option22_', 'option23_');
                });
            }
        });

        // Label ile kendisinden sonraki iki combobox'ı kontrol eden fonksiyon
        function checkLabelTotal(row, labelPrefix, combobox1Prefix, combobox2Prefix) {
            const rowIndex = row.dataset.rowIndex; // Satır index'i

            // Label ve ilgili combobox'ları seç
            const label = row.querySelector(`#${labelPrefix}${rowIndex}`);
            const combobox1 = row.querySelector(`select[name="${combobox1Prefix}${rowIndex}"]`);
            const combobox2 = row.querySelector(`select[name="${combobox2Prefix}${rowIndex}"]`);

            if (label && combobox1 && combobox2) {
                const combobox1Value = parseFloat(combobox1.value) || 0;
                const combobox2Value = parseFloat(combobox2.value) || 0;
                const total = combobox1Value + combobox2Value;

                // Eğer label içeriği toplamına eşit değilse kırmızı arka plan ekle
                if (parseFloat(label.textContent) !== total) {
                    label.style.backgroundColor = "red";
                } else {
                    label.style.backgroundColor = ""; // Arka planı temizle
                }
            }
        }
    });

    //let selectedCustomerID = null;

// Modal açma
function openModal() {
    selectedCustomerID = null; // Modal açıldığında ID'yi sıfırla
    selectedCustomer1ID = null;
    document.getElementById("selectedCustomer").innerHTML = ""; // Seçilen müşteri bilgilerini temizle
    document.getElementById("customerModal").style.display = "flex";
    document.getElementById("searchBox").value = ""; // Arama kutusunu temizle
    //document.getElementById("customerName").value = "";
            // Güncelleme kısmındaki input kutularını temizle
    document.getElementById("customerName").value = "";
    document.getElementById("customerTel").value = "";
    document.getElementById("customerAddress1").value = "";
    document.getElementById("customerAddress2").value = "";
    document.getElementById("customerPostcode").value = "";
    document.getElementById("customerEmail").value = "";
    document.getElementById("customerDiscount").value = "";

    fetchCustomerData(); // Modal açıldığında müşteri verilerini çek
}

// Modal kapama
function closeModal() {
    document.getElementById("customerModal").style.display = "none";
}

// Müşteri verilerini çekme
function fetchCustomerData() {
    fetch("/fetch_customers")
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById("customerTable").querySelector("tbody");
            tableBody.innerHTML = ""; // Eski satırları temizle
            data.forEach(customer => {
                const tr = document.createElement("tr");
                customer.forEach(cell => {
                    const td = document.createElement("td");
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tr.addEventListener("dblclick", () => selectCustomer(customer)); // Satırı tıklanabilir hale getir
                tr.addEventListener("click", () => select1Customer(customer));
                tableBody.appendChild(tr);
            });
        });
}
function selectCustomer(customer) {
        // Global değişkene müşteri ID'sini ata
        selectedCustomerID = customer[0];
        selectedCustomerName = customer[1];
        selectedCustomer1ID = null;

        // Seçilen müşteri bilgilerini ekrana yaz
        document.getElementById("selectedCustomer").innerHTML = `
            <strong>Customer Name:</strong> ${customer[1]} <br>
            <strong>Tel:</strong> ${customer[2]} <br>
            <strong>Address:</strong> ${customer[3]} <br>
            <strong>Postcode:</strong> ${customer[4]}
        `;

        // Backend'e müşteri bilgilerini gönder
        setCustomerInfo(customer);
        

        // Modal'ı kapat
        closeModal();
    }

    function select1Customer(customer) {
        selectedCustomer1ID = customer[0]; // Seçilen müşterinin ID'sini al
        //alert(`Selected Customer ID: ${selectedCustomer1ID}`); // ID'yi alert olarak göster

        // ...existing code...
        fetch(`/get_customer_by_id?id=${selectedCustomer1ID}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Customer Add/Update alanını doldur
                    document.getElementById("customerName").value = data.customer.name || "";
                    document.getElementById("customerTel").value = data.customer.tel || "";
                    document.getElementById("customerAddress1").value = data.customer.address1 || "";
                    document.getElementById("customerAddress2").value = data.customer.address2 || "";
                    document.getElementById("customerPostcode").value = data.customer.postcode || "";
                    document.getElementById("customerEmail").value = data.customer.email || "";
                    document.getElementById("customerDiscount").value = data.customer.discount || "";
                } else {
                    alert("Müşteri bilgileri alınamadı: " + data.message);
                }
            })
            .catch(error => console.error("Müşteri bilgileri alınırken hata oluştu:", error));
    }

    function addOrUpdateCustomer() {
        //alert(`selectedCustomer1ID: ${selectedCustomer1ID}, selectedCustomerID: ${selectedCustomerID}`); // Değerleri göster
        const customerData = {
            id: selectedCustomer1ID || null, // Eğer seçili müşteri yoksa null
            name: document.getElementById("customerName").value,
            tel: document.getElementById("customerTel").value,
            address1: document.getElementById("customerAddress1").value,
            address2: document.getElementById("customerAddress2").value,
            postcode: document.getElementById("customerPostcode").value,
            email: document.getElementById("customerEmail").value,
            discount: document.getElementById("customerDiscount").value,
        };
        //alert(`xselectedCustomer1ID: ${selectedCustomer1ID}, xselectedCustomerID: ${selectedCustomerID}`); // Değerleri göster
        fetch("/add_or_update_customer", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(customerData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                //alert("Customer added/updated successfully!");
                selectedCustomerID = null; // Modal açıldığında ID'yi sıfırla
                selectedCustomer1ID = null;
                document.getElementById("customerName").value = "";
                document.getElementById("customerTel").value = "";
                document.getElementById("customerAddress1").value = "";
                document.getElementById("customerAddress2").value = "";
                document.getElementById("customerPostcode").value = "";
                document.getElementById("customerEmail").value = "";
                document.getElementById("customerDiscount").value = "";
                fetchCustomerData(); // Tabloyu güncelle
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(error => console.error("Error:", error));
    }
//      // Müşteri seçme
// function selectCustomer(customer) {
//     // Global değişkene müşteri ID'sini ata
//     selectedCustomerID = customer[0];
//     selectedCustomerName = customer[1];

//     // Seçilen müşteri bilgilerini ekrana yaz
//     document.getElementById("selectedCustomer").innerHTML = `
//         <strong>Customer Name:</strong> ${customer[1]} <br>
//         <strong>Tel:</strong> ${customer[2]} <br>
//         <strong>Address:</strong> ${customer[3]} <br>
//         <strong>Postcode:</strong> ${customer[4]}
//     `;

//     // Backend'e müşteri bilgilerini gönder
//     setCustomerInfo(customer);

//     // Modal'ı kapat
//     closeModal();
// }

// Arama fonksiyonu
function searchCustomer() {
    const input = document.getElementById("searchBox").value.toUpperCase();
    const table = document.getElementById("customerTable");
    const tr = table.getElementsByTagName("tr");

    for (let i = 1; i < tr.length; i++) { // İlk satır başlık olduğu için 1'den başla
        const tds = tr[i].getElementsByTagName("td");
        let visible = false;
        for (let td of tds) {
            if (td.textContent.toUpperCase().includes(input)) {
                visible = true;
                break;
            }
        }
        tr[i].style.display = visible ? "" : "none";
    }
}



// Aynı anda tıklayanları kontrol eden fonksiyon
async function checkConcurrentClicks() {
    try {
        const user = document.querySelector('.user-info h1').textContent.trim();
        //const userId = document.querySelector('.user-info').id.trim();
        const userId = document.querySelector('.user-info').getAttribute('data-user-id');
        const clickTime = new Date().toLocaleString(); // Kullanıcının tıklama zamanı

        const response = await fetch('/log_click', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                user: user, 
                user_id: userId 
            }),
        });

        const data = await response.json();

        if (data.status === 'success') {
            const recentClicks = data.recent_clicks;

            // Kullanıcının kendi tıklama detaylarını göster
            let alertMessage = `Tıklayan Kullanıcı: ${user} (ID: ${userId})\nTıklama Saati: ${clickTime}`;

            // Eğer başka kullanıcılar da tıkladıysa, onları listele
            if (recentClicks.length > 1) {
                const otherUsers = recentClicks
                    .filter(log => log.user_id !== userId)
                    .map(log => {
                        const time = new Date(log.time).toLocaleTimeString();
                        return `${log.user} (ID: ${log.user_id}) - ${time}`;
                    })
                    .join('\n');

                alertMessage += `\n\nAynı anda tıklayan diğer kullanıcılar:\n${otherUsers}`;
            }

            alert(alertMessage);
        }
    } catch (error) {
        console.error('Eş zamanlı tıklama kontrol hatası:', error);
    }
}

function openProformaModal() {
    const modal = document.getElementById('proformaModal');
    modal.style.display = 'flex'; // Modalı görünür yap

    // Proforma listesini yükle
    fetch('/get_quotes')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Tabloyu doldur
            const tableBody = document.getElementById('proformaTable').querySelector('tbody');
            tableBody.innerHTML = ''; // Önceki içeriği temizle

            data.rows.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach((cell, index) => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });

                // Satıra tıklama olayı ekle
                tr.addEventListener('click', () => {
                    const quoteNumber = row[0]; // Birinci sütundaki numarayı al
                    const discountValue = row[5]; // Discount değerini al
                    selectedQuoteNumber = row[0]; // Birinci sütundaki quote numarasını al
                    const dbName = `${quoteNumber}`; // Dosya adını oluştur

                    // Discount değerini dsc alanına yaz
                    document.getElementById('discountInput').value = discountValue;

                    fetchCustomerDataByQuote(quoteNumber);
                    loadQuoteList(dbName); // get_quote_list'i çağır
                    loadUniteSelection(dbName); // Unite seçimlerini yükle
                    loadAddItemSelection(dbName); // Add Item seçimlerini yükle
                    loadRefSelection(dbName); 
                    loadCeilSelection(dbName); // Ceiling seçimlerini yükle
                    closeProformaModal(); // Modalı kapat
                });

                tableBody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Proforma listesi yüklenirken bir hata oluştu.');
        });
}

function closeProformaModal() {
    const modal = document.getElementById('proformaModal');
    modal.style.display = 'none'; // Modalı gizle
}

async function loadQuoteList(dbName) {
    try {
        const response = await fetch(`/get_quote_list?db_name=${dbName}`);

        if (!response.ok) {
            if (response.status === 404) {
                alert('Dosya bulunamadı: ' + dbName);
            }
            throw new Error('Veri alınırken hata oluştu.');
        }

        const responseData = await response.json();
        const { db_name, data } = responseData;

        const tableHeader = document.getElementById('tableHeader');
        tableHeader.textContent = `Quote list: ${db_name}`;

        // Eğer data boşsa tabloyu temizleyip mesaj göster
        if (!data || data.length === 0) {
            const tableBody = document.getElementById('quoteListTable').querySelector('tbody');
            tableBody.innerHTML = ''; // Tüm veriyi temizle
            alert('Gösterilecek liste verisi bulunamadı.');
            return;
        }

        // Tabloyu doldur
        const tableBody = document.getElementById('quoteListTable').querySelector('tbody');
        tableBody.innerHTML = '';

        // Alt toplamları hesaplamak için bir nesne oluştur
        const subtotals = {};
        const rowsByUnitType = {}; // Her unit_type için satırları saklamak için

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
                <td>${row[4]}</td>
                <td>${row[5]}</td>
                <td>${parseFloat(row[6]).toFixed(2)}</td>
                <td>${parseFloat(row[7]).toFixed(2)}</td>
                <td>${parseFloat(row[8]).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            tableBody.appendChild(tr);

            // Alt toplamları hesapla
            const unitType = row[4]; // `unit_type` sütunu
            const price = parseFloat(row[6]) || 0; // `price` sütunu
            const dPrice = parseFloat(row[7]) || 0; // `d.price` sütunu
            const amount = parseFloat(row[8]) || 0; // `amount` sütunu

            if (!subtotals[unitType]) {
                subtotals[unitType] = { price: 0, dPrice: 0, amount: 0 };
                rowsByUnitType[unitType] = []; // Her unit_type için bir dizi oluştur
            }

            subtotals[unitType].price += price;
            subtotals[unitType].dPrice += dPrice;
            subtotals[unitType].amount += amount;
            rowsByUnitType[unitType].push(tr); // Satırı ilgili unit_type dizisine ekle
        });

        // Alt toplamları ilgili `unit_type`'ın altına ekle
        Object.keys(rowsByUnitType).forEach(unitType => {
            const subtotalRow = document.createElement('tr');
            subtotalRow.innerHTML = `
                <td colspan="5" style="font-weight: bold; text-align: right;"> (${unitType}):</td>
                <td></td>
                <td style="font-weight: bold;">${subtotals[unitType].price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td style="font-weight: bold;">${subtotals[unitType].dPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td style="font-weight: bold;">${subtotals[unitType].amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;

            // Alt toplam satırını ilgili `unit_type`'ın son satırının altına ekle
            const lastRow = rowsByUnitType[unitType][rowsByUnitType[unitType].length - 1];
            lastRow.after(subtotalRow);
        });

        // Total, Vat ve G.Total hesaplama ve ekleme
        const totalPrice = Object.values(subtotals).reduce((sum, item) => sum + item.price, 0);
        const totalDPrice = Object.values(subtotals).reduce((sum, item) => sum + item.dPrice, 0);
        const totalAmount = Object.values(subtotals).reduce((sum, item) => sum + item.amount, 0);
        const vat = totalAmount * 0.2; // %20 KDV
        const grandTotal = totalAmount + vat;

        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `
            <td colspan="5" style="font-weight: bold; text-align: right;">Total:</td>
            <td></td>
            <td style="font-weight: bold;">${totalPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td style="font-weight: bold;">${totalDPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td style="font-weight: bold;">${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        `;
        tableBody.appendChild(totalRow);

        const vatRow = document.createElement('tr');
        vatRow.innerHTML = `
            <td colspan="8" style="font-weight: bold; text-align: right;">Vat (20%):</td>
            <td style="font-weight: bold;">${vat.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        `;
        tableBody.appendChild(vatRow);

        const grandTotalRow = document.createElement('tr');
        grandTotalRow.innerHTML = `
            <td colspan="8" style="font-weight: bold; text-align: right;">G.Total:</td>
            <td style="font-weight: bold;">${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        `;
        tableBody.appendChild(grandTotalRow);
    } catch (error) {
        console.error('Hata:', error);
        document.getElementById('statusMessage').textContent = 'Liste yüklenirken hata oluştu.';
    }
}

// Sayfa yüklendiğinde sunucudan tarih ve saat bilgisini çek
document.addEventListener('DOMContentLoaded', fetchServerTime);

async function saveUniteSelection(quoteNumber) {
    const rows = Array.from(document.querySelectorAll('#tab_unite tbody tr'));
    const selections = rows.map(row => {
        const selects = Array.from(row.querySelectorAll('select'));
        return selects.map(select => select.value || null); // Seçili değerleri al
    });

    try {
        const response = await fetch('/save_unite_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                selections: selections,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Seçimler başarıyla kaydedildi.');
        } else {
            console.error('Seçimler kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Seçimler kaydedilirken hata oluştu:', error);
    }
}


async function loadUniteSelection(quoteNumber) {
    try {
        const response = await fetch(`/load_unite_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const selections = data.selections;
            const rows = Array.from(document.querySelectorAll('#tab_unite tbody tr'));

            rows.forEach((row, index) => {
                const selects = Array.from(row.querySelectorAll('select'));
                const selection = selections[index] || [];
                selects.forEach((select, i) => {
                    select.value = selection[i] || ''; // Seçimleri geri yükle
                });

                // Seçimler yüklendikten sonra hesaplama fonksiyonunu çağır
                updateValueDisplay(index);
            });

            console.log('Seçimler başarıyla yüklendi.');
        } else {
            console.error('Seçimler yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Seçimler yüklenirken hata oluştu:', error);
    }
}


async function fetchCustomerDataByQuote(quoteNumber) {
    try {
        const response = await fetch(`/get_customer_by_quote?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            // Müşteri bilgilerini al
            const customer = [
                data.customer_id,    // ID
                data.customer_name,  // Name
                data.tel,            // Tel
                data.address,        // Address
                data.postcode        // Postcode
            ];

            // selectCustomer fonksiyonunu tetikle
            selectCustomer(customer);
        } else {
            console.error('Müşteri bilgileri alınırken hata oluştu:', data.message);
            alert(data.message); // Hata mesajını kullanıcıya göster
        }
    } catch (error) {
        console.error('Müşteri bilgileri alınırken hata oluştu:', error);
        alert('Müşteri bilgileri alınırken bir hata oluştu.');
    }
}


async function callPrepUpQt(quoteNumber,dsc) {
    try {
        const response = await fetch('/prep_up_qt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quote_number: quoteNumber, dsc: dsc }), // dsc = 5
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log(data.message);
        } else {
            console.error('prep_up_qt çağrılırken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('prep_up_qt isteği sırasında hata oluştu:', error);
    }
}

async function fetchServerTime() {
    try {
        const response = await fetch('/get_server_time'); // Sunucudan tarih ve saat bilgisini al
        if (!response.ok) {
            throw new Error('Sunucudan tarih ve saat alınamadı.');
        }

        const data = await response.json();
        if (data.status === 'success') {
            const serverTimeElement = document.getElementById('serverTime');
            serverTimeElement.textContent = `Server Time: ${data.time}`; // Tarih ve saati göster
        } else {
            console.error('Tarih ve saat alınırken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Tarih ve saat alınırken hata oluştu:', error);
    }
}

async function saveAddItemSelection(quoteNumber) {
    const rows = Array.from(document.querySelectorAll('#tab_add_item tbody tr'));
    const selections = rows.map(row => {
        const inputs = Array.from(row.querySelectorAll('input'));
        return inputs.map(input => input.value || null); // Input değerlerini al
    });

    // Selections verilerini gösteren alert mesajı
    //alert("Kaydedilecek Selections Verileri:\n" + JSON.stringify(selections, null, 2));

    try {
        const response = await fetch('/save_aditm_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                selections: selections,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Add Item seçimleri başarıyla kaydedildi.');
        } else {
            console.error('Add Item seçimleri kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Add Item seçimleri kaydedilirken hata oluştu:', error);
    }
}

async function loadAddItemSelection(quoteNumber) {
    try {
        const response = await fetch(`/load_aditm_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const selections = data.selections;
            const rows = Array.from(document.querySelectorAll('#tab_add_item tbody tr'));

            //console.log("Gelen veriler:", selections); // Gelen verileri logla

            rows.forEach((row, index) => {
                const inputs = Array.from(row.querySelectorAll('input'));
                const selection = selections[index] || {}; // Seçim nesnesini al

                //console.log(`Satır ${index} için seçimler:`, selection); // Satır bazında seçimleri logla

                // Input alanlarına değerleri ata
                if (inputs.length >= 5) {
                    inputs[0].value = selection.item_name || ''; // Item Name
                    inputs[1].value = selection.quantity || ''; // Quantity
                    inputs[2].value = selection.price || ''; // Price
                    inputs[3].value = selection.discounted_price || ''; // After Discount
                    inputs[4].value = selection.depo_code || ''; // Depo Code
                }
            });

            console.log('Add Item seçimleri başarıyla yüklendi.');
        } else {
            console.error('Add Item seçimleri yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Add Item seçimleri yüklenirken hata oluştu:', error);
    }
}



function clearAddItemPage() {
    const rows = Array.from(document.querySelectorAll('#tab_add_item tbody tr'));
    rows.forEach(row => {
        const inputs = Array.from(row.querySelectorAll('input'));
        inputs.forEach(input => {
            input.value = ''; // Tüm inputları temizle
        });
    });
}

document.addEventListener('DOMContentLoaded', function () {
    // Group seçimlerini doldur
    const groupSelects = document.querySelectorAll('.group-select');
    groupSelects.forEach(select => {
        fetch('/get_refrigeration_groups')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    data.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Group verileri alınırken hata oluştu:', data.message);
                }
            })
            .catch(error => console.error('Group verileri alınırken hata oluştu:', error));
    });

    // Group, item ve customer type değişikliklerini dinle
    document.querySelectorAll('.group-select, .item-select, #customerType').forEach(element => {
        element.addEventListener('change', function () {
            const row = this.closest('tr');
            const groupSelect = row ? row.querySelector('.group-select') : null;
            const itemSelect = row ? row.querySelector('.item-select') : null;
            const customerType = document.getElementById('customerType').value;
            const priceLabel = row ? row.querySelector('label[id^="price_"]') : null;
            const ref1price = priceLabel
            const dpriceLabel = row ? row.querySelector('label[id^="dprice_"]') : null;
            const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Get ref_dsc value

            // Group değiştiğinde item ve sonraki seçim kutularını sıfırla
            if (this.classList.contains('group-select')) {
                if (itemSelect) {
                    itemSelect.innerHTML = '<option value=""></option>';
                    itemSelect.value = ''; // Item seçimini sıfırla
                }
                const inputsAndSelects = Array.from(row.querySelectorAll('select, input')).slice(1); // Group'tan sonraki tüm elemanlar
                inputsAndSelects.forEach(inputOrSelect => {
                    if (inputOrSelect.tagName === 'SELECT') {
                        inputOrSelect.value = ''; // Seçimi sıfırla
                    } else if (inputOrSelect.tagName === 'INPUT') {
                        inputOrSelect.value = ''; // Giriş kutusunu sıfırla
                    }
                });
                if (priceLabel) priceLabel.textContent = ''; // Fiyatı sıfırla
                    dpriceLabel.textContent = '';

                const selectedGroup = groupSelect.value;
                if (selectedGroup) {
                    fetch(`/get_refrigeration_items?group=${encodeURIComponent(selectedGroup)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                data.items.forEach(item => {
                                    const option = document.createElement('option');
                                    option.value = item;
                                    option.textContent = item;
                                    itemSelect.appendChild(option);
                                });
                            } else {
                                console.error('Item verileri alınırken hata oluştu:', data.message);
                            }
                        })
                        .catch(error => console.error('Item verileri alınırken hata oluştu:', error));
                }
            }

            // Item değiştiğinde sonraki seçim kutularını ve giriş kutularını sıfırla
            if (this.classList.contains('item-select')) {
                const inputsAndSelects = Array.from(row.querySelectorAll('select, input')).slice(2); // Item'den sonraki tüm elemanlar
                inputsAndSelects.forEach(inputOrSelect => {
                    if (inputOrSelect.tagName === 'SELECT') {
                        inputOrSelect.value = ''; // Seçimi sıfırla
                    } else if (inputOrSelect.tagName === 'INPUT') {
                        inputOrSelect.value = ''; // Giriş kutusunu sıfırla
                    }
                });
            }

            // Group, item veya customer type değiştiğinde fiyatı güncelle veya sıfırla
            const selectedGroup = groupSelect ? groupSelect.value : null;
            const selectedItem = itemSelect ? itemSelect.value : null;

            if (selectedGroup && selectedItem && customerType) {
                fetch(`/get_refrigeration_price?model=${encodeURIComponent(selectedItem)}&customer_type=${encodeURIComponent(customerType)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            priceLabel.textContent = data.price.toFixed(2); // Display price
                            dpriceLabel.textContent = (data.price - (data.price * discount / 100)).toFixed(2); // Apply discount
                        } else {
                            console.error('Fiyat alınırken hata oluştu:', data.message);
                            priceLabel.textContent = ''; // Clear price on error
                            dpriceLabel.textContent = ''; // Clear discounted price on error
                        }
                    })
                    .catch(error => {
                        console.error('Fiyat alınırken hata oluştu:', error);
                        priceLabel.textContent = ''; // Clear price on error
                        dpriceLabel.textContent = ''; // Clear discounted price on error
                    });
            } else {
                if (priceLabel) priceLabel.textContent = ''; // Clear price if no selection
                if (dpriceLabel) dpriceLabel.textContent = ''; // Clear discounted price if no selection
            }
        });
    });

    // Customer type değiştiğinde fiyatı güncelle
    document.getElementById('customerType').addEventListener('change', function () {
        const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
        document.querySelectorAll('tr').forEach(row => {
            const groupSelect = row.querySelector('.group-select');
            const itemSelect = row.querySelector('.item-select');
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');

            const warrantyValue = parseFloat(row.querySelector('.warranty-select')?.value) || 0;
            const unpackValue = parseFloat(row.querySelector('.unpack-select')?.value) || 0;
            const removeValue = parseFloat(row.querySelector('.remove-select')?.value) || 0;
            
            const customerType = this.value;

            if (groupSelect && itemSelect && priceLabel && groupSelect.value && itemSelect.value) {
                fetch(`/get_refrigeration_price?model=${encodeURIComponent(itemSelect.value)}&customer_type=${encodeURIComponent(customerType)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            priceLabel.textContent = (data.price + warrantyValue + unpackValue + removeValue).toFixed(2); // Fiyatı güncelle
                            dpriceLabel.textContent = (data.price - (data.price * discount / 100) + warrantyValue + unpackValue + removeValue).toFixed(2); // Apply discount
                        } else {
                            console.error('Fiyat alınırken hata oluştu:', data.message);
                            priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                            dpriceLabel.textContent = '';
                        }
                    })
                    .catch(error => {
                        console.error('Fiyat alınırken hata oluştu:', error);
                        priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                        dpriceLabel.textContent = '';
                    });
            }
        });
    });

    // Function to update dprice for all rows
    function updateAllDPrices() {
        const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Get ref_dsc value
        document.querySelectorAll('tr').forEach(row => {
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');
            const warrantyValue = parseFloat(row.querySelector('.warranty-select')?.value) || 0;
            const unpackValue = parseFloat(row.querySelector('.unpack-select')?.value) || 0;
            const removeValue = parseFloat(row.querySelector('.remove-select')?.value) || 0;

            if (priceLabel && dpriceLabel && priceLabel.textContent) {
                const basePrice = parseFloat(priceLabel.textContent)-(warrantyValue+unpackValue+removeValue); // Base price before additions
                //alert(basePrice);
                const discountedPrice = (basePrice - (basePrice * discount / 100)).toFixed(2); // Calculate discounted price
                dpriceLabel.textContent = (parseFloat(discountedPrice) + warrantyValue + unpackValue + removeValue).toFixed(2); // Add additional values
            }
        });
    }

    // Update dprice when ref_dsc changes
    document.getElementById('ref_dsc').addEventListener('input', updateAllDPrices);
});

document.addEventListener('DOMContentLoaded', function () {

    document.querySelectorAll('.item-select').forEach(itemSelect => {
        itemSelect.addEventListener('change', function () {
            const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
            const row = this.closest('tr');
            const selectedItem = this.value;
            const warrantySelect = row.querySelector('.warranty-select');
            const unpackSelect = row.querySelector('.unpack-select');
            const removeSelect = row.querySelector('.remove-select');
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');
            const skuLabel = row.querySelector('label[id^="sku_"]');

            if (selectedItem) {
                fetch(`/get_refrigeration_item_details?model=${encodeURIComponent(selectedItem)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Populate warranty, unpack, and remove values with an empty option
                            warrantySelect.innerHTML = `<option value=""></option><option value="${data.warranty}">${data.warranty}</option>`;
                            unpackSelect.innerHTML = `<option value=""></option><option value="${data.unpack}">${data.unpack}</option>`;
                            removeSelect.innerHTML = `<option value=""></option><option value="${data.remove}">${data.remove}</option>`;

                            // Update price and dprice
                            const basePrice = parseFloat(priceLabel.textContent) || 0;
                            priceLabel.textContent = basePrice.toFixed(2);
                            dpriceLabel.textContent = (basePrice - (basePrice * discount / 100)).toFixed(2);

                            // Update SKU with TradePrice and Kar
                            const tradePrice = parseFloat(data.tradePrice) || 0;
                            const kar = parseFloat(data.kar) || 0;
                            //skuLabel.textContent = `${selectedItem} ${tradePrice.toFixed(2)}-${kar.toFixed(2)}`;
                            skuLabel.textContent = `SKU ${tradePrice}-${kar}`;
                        } else {
                            console.error('Item details alınırken hata oluştu:', data.message);
                            warrantySelect.innerHTML = '<option value=""></option>';
                            unpackSelect.innerHTML = '<option value=""></option>';
                            removeSelect.innerHTML = '<option value=""></option>';
                            skuLabel.textContent = ''; // Clear SKU on error
                        }
                    })
                    .catch(error => {
                        console.error('Item details alınırken hata oluştu:', error);
                        warrantySelect.innerHTML = '<option value=""></option>';
                        unpackSelect.innerHTML = '<option value=""></option>';
                        removeSelect.innerHTML = '<option value=""></option>';
                        skuLabel.textContent = ''; // Clear SKU on error
                    });
            } else {
                warrantySelect.innerHTML = '<option value=""></option>';
                unpackSelect.innerHTML = '<option value=""></option>';
                removeSelect.innerHTML = '<option value=""></option>';
                priceLabel.textContent = '';
                dpriceLabel.textContent = '';
                skuLabel.textContent = ''; // Clear SKU if no selection
            }
        });
    });

    document.querySelectorAll('.warranty-select, .unpack-select, .remove-select').forEach(select => {
        select.addEventListener('change', function () {
            const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
            const row = this.closest('tr');
            const priceLabel = row.querySelector('label[id^="price_"]');
            const dpriceLabel = row.querySelector('label[id^="dprice_"]');
            const warrantyValue = parseFloat(row.querySelector('.warranty-select').value) || 0;
            const unpackValue = parseFloat(row.querySelector('.unpack-select').value) || 0;
            const removeValue = parseFloat(row.querySelector('.remove-select').value) || 0;

            const basePrice = parseFloat(priceLabel.dataset.basePrice) || parseFloat(priceLabel.textContent) || 0;

            // Calculate updated price
            const updatedPrice = basePrice + warrantyValue + unpackValue + removeValue;

            // Store the base price in a data attribute for future reference
            priceLabel.dataset.basePrice = basePrice;

            priceLabel.textContent = updatedPrice.toFixed(2);
            dpriceLabel.textContent = ((basePrice - (basePrice * discount / 100)) + warrantyValue + unpackValue + removeValue).toFixed(2);
        });
    });

});

document.querySelectorAll('.warranty-select, .unpack-select, .remove-select').forEach(select => {
    select.addEventListener('change', function () {
        const discount = parseFloat(document.getElementById('ref_dsc').value) || 0; // Discount tanımlandı
        const customerType = document.getElementById('customerType').value; // Customer type alındı
        const row = this.closest('tr');
        const priceLabel = row.querySelector('label[id^="price_"]');
        const dpriceLabel = row.querySelector('label[id^="dprice_"]');
        const warrantyValue = parseFloat(row.querySelector('.warranty-select').value) || 0;
        const unpackValue = parseFloat(row.querySelector('.unpack-select').value) || 0;
        const removeValue = parseFloat(row.querySelector('.remove-select').value) || 0;
        const itemSelect = row.querySelector('.item-select');

        if (itemSelect && itemSelect.value && customerType) {
            fetch(`/get_refrigeration_price?model=${encodeURIComponent(itemSelect.value)}&customer_type=${encodeURIComponent(customerType)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const basePrice = data.price; // Customer type'a göre fiyat alındı
                        const updatedPrice = basePrice + warrantyValue + unpackValue + removeValue;

                        // Store the base price in a data attribute for future reference
                        priceLabel.dataset.basePrice = basePrice;

                        priceLabel.textContent = updatedPrice.toFixed(2);
                        dpriceLabel.textContent = ((basePrice - (basePrice * discount / 100)) + warrantyValue + unpackValue + removeValue).toFixed(2);
                    } else {
                        console.error('Fiyat alınırken hata oluştu:', data.message);
                        priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                        dpriceLabel.textContent = '';
                    }
                })
                .catch(error => {
                    console.error('Fiyat alınırken hata oluştu:', error);
                    priceLabel.textContent = ''; // Hata durumunda fiyatı temizle
                    dpriceLabel.textContent = '';
                });
        } else {
            console.error('Gerekli bilgiler eksik: itemSelect veya customerType');
        }
    });
});

async function AddRefData() {
    const rows = document.querySelectorAll('#tab_refrigeration tbody tr'); // Refrigeration tablosundaki satırları seç
    const largestFile = document.getElementById('largestFile').textContent.trim(); // largestFile değerini al

    const refData = []; // Gönderilecek tüm verileri tutacak dizi
    let validRowFound = false; // Geçerli bir satır bulunup bulunmadığını kontrol etmek için

    rows.forEach((row) => {
        const sku = row.querySelector('label[id^="sku_"]')?.textContent.trim(); // SKU değeri
        const itemName = row.querySelector('.item-select')?.value.trim(); // Seçilen item
        const quantity = row.querySelector('input[name^="quantity_"]')?.value.trim(); // Girilen quantity
        const price = row.querySelector('label[id^="price_"]')?.textContent.trim(); // Price değeri
        const dprice = row.querySelector('label[id^="dprice_"]')?.textContent.trim(); // D.Price değeri

        // Eğer 1., 2., 6., 7., 8., ve 9. kolonlar doluysa, veriyi ekle
        if (sku && itemName && quantity && price && dprice) {
            refData.push({
                sku: sku,
                itemName: itemName,
                quantity: parseInt(quantity, 10), // Sayıya çevir
                price: parseFloat(price || 0), // Sayıya çevir, boşsa 0
                dprice: parseFloat(dprice || 0), // Sayıya çevir, boşsa 0
                unitType: "Add Refrigeration" // Sabit değer
            });
            validRowFound = true; // Geçerli bir satır bulundu
        }
    });

    // Eğer geçerli bir satır bulunmadıysa işlemi durdur
    if (!validRowFound) {
        console.log("Refrigeration tablosunda işlenecek geçerli veri yok.");
        window.adrefknt = 0; // Tüm fonksiyonlar için global bir değişken oluşturuyoruz.
        return true;
    } else {
        window.adrefknt = 1;
    }

    // API'ye gönderilecek veri
    const data = {
        ref_data: refData, // Toplanan tüm satırlar
        largest_file: largestFile // largestFile değeri burada kullanılıyor
    };

    // API'ye POST isteği gönder
    try {
        const response = await fetch('/add_ref_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const responseData = await response.json();

        if (responseData.status === "success") {
            console.log("Refrigeration verileri başarıyla gönderildi!");
        } else {
            throw new Error("Bir hata oluştu: " + responseData.message);
        }
    } catch (error) {
        console.error('API Hatası:', error);
        alert('Refrigeration verileri gönderilirken hata oluştu.');
        throw error; // Hata fırlatarak işlemi durdur
    }
}

async function saveRefSelection(quoteNumber) {
    const customerType = document.getElementById('customerType')?.value || '';
    const refDsc = parseFloat(document.getElementById('ref_dsc')?.value) || 0;

    const rows = Array.from(document.querySelectorAll('#tab_refrigeration tbody tr'));
    const selections = rows.map(row => {
        const groupSelect = row.querySelector('.group-select')?.value || '';
        const itemSelect = row.querySelector('.item-select')?.value || '';
        const quantityInput = row.querySelector('input[name^="quantity_"]')?.value || 0;
        const warrantySelect = row.querySelector('.warranty-select')?.value || '';
        const unpackSelect = row.querySelector('.unpack-select')?.value || '';
        const removeSelect = row.querySelector('.remove-select')?.value || '';
        const priceLabel = row.querySelector('label[id^="price_"]')?.textContent || 0.0;
        const discountedPriceLabel = row.querySelector('label[id^="dprice_"]')?.textContent || 0.0;

        // Tüm satırları kaydet, boş olanlar dahil
        return {
            group_name: groupSelect,
            item_name: itemSelect,
            warranty: warrantySelect,
            unpack: unpackSelect,
            remove: removeSelect,
            quantity: parseInt(quantityInput, 10),
            price: parseFloat(priceLabel),
            discounted_price: parseFloat(discountedPriceLabel)
        };
    });

    try {
        const response = await fetch('/save_ref_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                customer_type: customerType,
                ref_dsc: refDsc,
                selections: selections,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Refrigeration seçimleri başarıyla kaydedildi.');
        } else {
            console.error('Refrigeration seçimleri kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Refrigeration seçimleri kaydedilirken hata oluştu:', error);
    }
}

async function loadRefSelection(quoteNumber) {
    // Tüm seçimleri sıfırla
    const rows = document.querySelectorAll('#tab_refrigeration tbody tr');
    rows.forEach(row => {
        const dpriceLabel = row.querySelector('label[id^="dprice_"]');
        const groupSelect = row.querySelector('.group-select');
        const itemSelect = row.querySelector('.item-select');
        const warrantySelect = row.querySelector('.warranty-select');
        const unpackSelect = row.querySelector('.unpack-select');
        const removeSelect = row.querySelector('.remove-select');
        const quantityInput = row.querySelector('input[name^="quantity_"]');
        const priceLabel = row.querySelector('label[id^="price_"]');
        const sku = row.querySelector('label[id^="sku_"]'); // SKU değeri

        if (groupSelect) groupSelect.value = '';
        if (itemSelect) itemSelect.innerHTML = '<option value=""></option>';
        if (warrantySelect) warrantySelect.innerHTML = '<option value=""></option>';
        if (unpackSelect) unpackSelect.innerHTML = '<option value=""></option>';
        if (removeSelect) removeSelect.innerHTML = '<option value=""></option>';
        if (quantityInput) quantityInput.value = '';
        if (priceLabel) priceLabel.textContent = '';
        if (dpriceLabel) dpriceLabel.textContent = '';
        if (sku) sku.textContent = ''; // SKU değerini temizle
    });

    // ...existing code...
    try {
        const response = await fetch(`/load_ref_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const selections = data.selections;

            // Customer type ve ref_dsc geri yükleniyor
            const customerTypeElement = document.getElementById('customerType');
            const refDscElement = document.getElementById('ref_dsc');
            if (selections.length > 0) {
                customerTypeElement.value = selections[0].customer_type || '';
                refDscElement.value = selections[0].ref_dsc || 0;
                customerTypeElement.dispatchEvent(new Event('change'));
                refDscElement.dispatchEvent(new Event('input'));
            }

            // Sadece quantity > 0 olan satırlar için işlem yapılıyor
            for (const selection of selections) {
                if (selection.quantity > 0) {
                    const row = document.querySelector(`#tab_refrigeration tbody tr:nth-child(${selection.row_index + 1})`);
                    if (!row) continue;

                    const groupSelect = row.querySelector('.group-select');
                    const itemSelect = row.querySelector('.item-select');
                    const warrantySelect = row.querySelector('.warranty-select');
                    const unpackSelect = row.querySelector('.unpack-select');
                    const removeSelect = row.querySelector('.remove-select');
                    const quantityInput = row.querySelector('input[name^="quantity_"]');
                    const priceLabel = row.querySelector('label[id^="price_"]');
                    const dpriceLabel = row.querySelector('label[id^="dprice_"]');

                    // Group name geri yükleniyor
                    if (groupSelect) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        groupSelect.value = selection.group_name;
                        groupSelect.dispatchEvent(new Event('change'));
                    }

                    // Group name seçildikten sonra item name geri yükleniyor
                    if (itemSelect) {
                        await new Promise(resolve => setTimeout(resolve, 200)); // Bağımlı seçimlerin yüklenmesi için bekleme
                        itemSelect.value = selection.item_name;
                        itemSelect.dispatchEvent(new Event('change'));
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));

                    // Item name seçildikten sonra warranty, unpack, remove geri yükleniyor
                    if (warrantySelect) warrantySelect.value = selection.warranty;
                    if (unpackSelect) unpackSelect.value = selection.unpack;
                    if (removeSelect) removeSelect.value = selection.remove;

                    // Quantity, price ve dprice geri yükleniyor
                    if (quantityInput) quantityInput.value = selection.quantity;
                    if (priceLabel) priceLabel.textContent = selection.price.toFixed(2);
                    if (dpriceLabel) dpriceLabel.textContent = selection.discounted_price.toFixed(2);
                }
            }

            const { customer_type, ref_dsc } = data;

            // customer_type ve ref_dsc değerlerini ilgili alanlara yerleştir
            document.getElementById('customerType').value = customer_type;
            document.getElementById('ref_dsc').value = ref_dsc;

            console.log('Refrigeration seçimleri başarıyla yüklendi.');
        } else {
            console.error('Refrigeration seçimleri yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Refrigeration seçimleri yüklenirken hata oluştu:', error);
    }
}

async function addCeilingData() {
    const rows = document.querySelectorAll('#ceilingTableBody tr'); // Ceiling tablosundaki satırları seç
    const largestFile = document.getElementById('largestFile').textContent.trim(); // largestFile değerini al

    const ceilingData = []; // Gönderilecek tüm verileri tutacak dizi
    let validRowFound = false; // Geçerli bir satır bulunup bulunmadığını kontrol etmek için

    rows.forEach((row) => {
        const code = row.children[0]?.textContent.trim(); // Code
        const materials = row.children[1]?.textContent.trim(); // Materials
        const qty = parseFloat(row.children[3]?.textContent.trim()) || 0; // Qty
        const local = parseFloat(row.children[4]?.textContent.trim()) || 0; // Local
        const dPrice = parseFloat(row.children[5]?.textContent.trim()) || 0; // D.Price

        if (code && materials) {
            ceilingData.push({
                Code: code,
                Materials: materials,
                qty: qty,
                local: local,
                dPrice: dPrice
            });
            validRowFound = true; // Geçerli bir satır bulundu
        }
    });

    // Eğer geçerli bir satır bulunmadıysa işlemi durdur
    if (!validRowFound) {
        console.log("Ceiling tablosunda işlenecek geçerli veri yok.");
        window.adclknt = 0; // Tüm fonksiyonlar için global bir değişken oluşturuyoruz.
        return true;
    } else {
        window.adclknt = 1;
    }

    // API'ye POST isteği gönder
    try {
        const response = await fetch('/add_ceiling_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                largest_file: largestFile,
                ceiling_data: ceilingData
            }),
        });

        const responseData = await response.json();

        if (responseData.status === "success") {
            console.log("Ceiling verileri başarıyla gönderildi!");
        } else {
            throw new Error("Bir hata oluştu: " + responseData.message);
        }
    } catch (error) {
        console.error('API Hatası:', error);
        alert('Ceiling verileri gönderilirken hata oluştu.');
    }
}

async function saveCeilSelection(quoteNumber) {
    const ceilingM2 = parseFloat(document.getElementById('ceilingM2')?.value) || 0;
    const trimLM = parseFloat(document.getElementById('trimLM')?.value) || 0;
    const ceilingDiscount = parseFloat(document.getElementById('ceilingDiscount')?.value) || 0;

    try {
        const response = await fetch('/save_ceil_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quote_number: quoteNumber,
                ceiling_m2: ceilingM2,
                trim_lm: trimLM,
                ceiling_discount: ceilingDiscount,
            }),
        });

        const data = await response.json();
        if (data.status === 'success') {
            console.log('Ceiling seçimleri başarıyla kaydedildi.');
        } else {
            console.error('Ceiling seçimleri kaydedilirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Ceiling seçimleri kaydedilirken hata oluştu:', error);
    }
}

async function loadCeilSelection(quoteNumber) {
    // Ceiling sayfasını tamamen temizle
    document.getElementById('ceilingM2').value = '';
    document.getElementById('trimLM').value = '';
    document.getElementById('ceilingDiscount').value = '';
    const tableBody = document.getElementById('ceilingTableBody');
    if (tableBody) {
        tableBody.innerHTML = ''; // Tabloyu temizle
    }

    // ...existing code...
    try {
        const response = await fetch(`/load_ceil_selection?quote_number=${quoteNumber}`);
        const data = await response.json();

        if (data.status === 'success') {
            const { ceiling_m2, trim_lm, ceiling_discount } = data;

            // Eğer tüm değerler boşsa fonksiyonu sonlandır
            if (!ceiling_m2 && !trim_lm && !ceiling_discount) {
                console.log('Ceiling seçimleri boş, işlem yapılmadı.');
                return;
            }

            document.getElementById('ceilingM2').value = ceiling_m2 || '';
            document.getElementById('trimLM').value = trim_lm || '';
            document.getElementById('ceilingDiscount').value = ceiling_discount || '';

            // Değerler yüklendikten sonra ceiling verilerini güncelle
            fetchCeilingData();
            console.log('Ceiling seçimleri başarıyla yüklendi.');
        } else {
            console.error('Ceiling seçimleri yüklenirken hata oluştu:', data.message);
        }
    } catch (error) {
        console.error('Ceiling seçimleri yüklenirken hata oluştu:', error);
    }
}

</script>

</body>
</html>
